---
title: "west_us"
output: html_document
date: "2023-09-20"
---

## NOTES
* LCMAP vs NLCD: https://www.usgs.gov/special-topics/lcmap/science/lcmap-and-nlcd-complementary-data-understanding-geography-united#:~:text=LCMAP%20has%20a%20lower%20level,found%20in%20NLCD%20is%20needed

## Set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

### Load packages
library(tidyverse)
library(sf)
library(lubridate)
library(raster)
library(terra)
library(viridis)
library(scales)
library(lwgeom)
library(googledrive)
```

Workflow
-	Restrict USFS fuel treatment polygons to western US
-	Subset MTBS to western US
o	Drop prescribed fires from MTBS
-	Intersect fuel treatments with subsequent wildfires 
o	ïƒ  output: polygons showing which sections of fuel treatment footprints subsequently burned
-	Loop through burned FTs to figure out overlaps between treatments

## USFS Perimeters  
* Dataset: "Hazardous Fuel Treatment Reduction: Polygon"  
* Data downloaded 8/28/2023
* Data last updated Aug 18, 2023  
* url: https://data.fs.usda.gov/geodata/edw/datasets.php  
* metadata: https://data.fs.usda.gov/geodata/edw/edw_resources/meta/S_USA.Activity_HazFuelTrt_PL.xml  

```{r}
### Open fuel treatment database
ft <- st_read("E:/usda_2023/usfs_fuel_treatments/S_USA.Activity_HazFuelTrt_PL.shp") 

### add column for unique identifier
ft <- ft %>%
  mutate(ft_id = row_number())

### Subset to states of the western US (and adjacent states)
ft <- ft %>%
  filter(STATE_ABBR %in% c("AZ", "CA",
                           "CO", "ID",
                           "MT", "NM",
                           "NV", "OR",
                           "UT", "WA", "WY",
                           
                           ### adjacent states
                           "ND", "SD",
                           "NE", "KS", 
                           "OK", "TX"))

### Reproject fuel treatments
ft <- ft %>%
  st_transform(crs = 6350)

### Filter out chemical and grazing
ft <- ft %>%
  filter(!METHOD %in% c("Animal",
                        "Chemical"))

### remove chemical and grazing
ft <- ft %>%
  filter(!TREATMENT_ %in% c("Chemical",
                            "Grazing"))

### Take out treatments where completed date = NA
ft <- ft %>%
  drop_na(DATE_COMPL)

### simplify columns
ft_simp <- ft %>%
  dplyr::select(ft_id, STATE_ABBR, geometry)

### divide up ft for overlap with western us (otherwise it's very large!)
ft_adj <- ft_simp %>%
  filter(STATE_ABBR %in% c("ND", "SD",
                           "NE", "KS", 
                           "OK", "TX"))
ft_pacific <- ft_simp %>%
  filter(STATE_ABBR %in% c("WA", "OR", "CA"))
ft_sw <- ft_simp %>%
  filter(STATE_ABBR %in% c("AZ", "UT", "CO", "NM"))
ft_n <- ft_simp %>%
  filter(STATE_ABBR %in% c("ID", "NV", "WY", "MT"))
rm(ft_simp)

### Open western US boundary
w_bound <- raster::getData(name = "GADM",
                            country = 'USA',
                            level = 1) %>%
  st_as_sf() %>%
  filter(NAME_1 %in% c("Arizona", "California", 
                       "Colorado", "Idaho",
                       "Montana", "New Mexico",
                       "Nevada", "Oregon",
                       "Utah", "Washington",
                       "Wyoming"))

### Reproject w_bound
w_bound <- w_bound %>%
  st_transform(crs = 6350) %>%
  dplyr::select(NAME_1, geometry)
st_write(w_bound,
         "E:/usda_2023/usfs_fuel_treatments/western_us/west_states.shp")

### Intersect treatment boundaries with western states
ft_adj <- st_intersection(ft_adj, 
                          w_bound)
ft_pacific <- st_intersection(ft_pacific, 
                              w_bound)
ft_sw <- st_intersection(ft_sw, 
                         w_bound)
ft_n <- st_intersection(ft_n, 
                        w_bound)

### subset ft
ft_adj <- ft %>%
  filter(ft_id %in% ft_adj$ft_id)
ft_pacific <- ft %>%
  filter(ft_id %in% ft_pacific$ft_id)
ft_sw <- ft %>%
  filter(ft_id %in% ft_sw$ft_id)
ft_n <- ft %>%
  filter(ft_id %in% ft_n$ft_id)

### write out
st_write(ft_adj,
         "E:/usda_2023/usfs_fuel_treatments/western_us/adj_treatments.shp")
st_write(ft_sw,
         "E:/usda_2023/usfs_fuel_treatments/western_us/sw_treatments.shp")
st_write(ft_n,
         "E:/usda_2023/usfs_fuel_treatments/western_us/northern_treatments.shp")
st_write(ft_pacific,
         "E:/usda_2023/usfs_fuel_treatments/western_us/pacific_treatments.shp")
```

### re-run including grazing and chemical 
```{r}
### Open fuel treatment database
ft <- st_read("E:/usda_2023/usfs_fuel_treatments/S_USA.Activity_HazFuelTrt_PL.shp") 

### add column for unique identifier
ft <- ft %>%
  mutate(ft_id = row_number())

### Subset to states of the western US (and adjacent states)
ft <- ft %>%
  filter(STATE_ABBR %in% c("AZ", "CA",
                           "CO", "ID",
                           "MT", "NM",
                           "NV", "OR",
                           "UT", "WA", "WY",
                           
                           ### adjacent states
                           "ND", "SD",
                           "NE", "KS", 
                           "OK", "TX"))

### Reproject fuel treatments
ft <- ft %>%
  st_transform(crs = 6350)

### Take out treatments where completed date = NA
ft <- ft %>%
  drop_na(DATE_COMPL)

### simplify columns
ft_simp <- ft %>%
  dplyr::select(ft_id, STATE_ABBR, geometry)

### divide up ft for overlap with western us (otherwise it's very large!)
ft_adj <- ft_simp %>%
  filter(STATE_ABBR %in% c("ND", "SD",
                           "NE", "KS", 
                           "OK", "TX"))
ft_pacific <- ft_simp %>%
  filter(STATE_ABBR %in% c("WA", "OR", "CA"))
ft_sw <- ft_simp %>%
  filter(STATE_ABBR %in% c("AZ", "UT", "CO", "NM"))
ft_n <- ft_simp %>%
  filter(STATE_ABBR %in% c("ID", "NV", "WY", "MT"))
rm(ft_simp)

### Open w_bound
w_bound <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/west_states.shp")

### Intersect treatment boundaries, write out
### adjacent
ft_adj <- st_intersection(ft_adj, 
                          w_bound)
ft_adj <- ft %>%
  filter(ft_id %in% ft_adj$ft_id)
st_write(ft_adj,
         "E:/usda_2023/usfs_fuel_treatments/western_us/adj_treatments_all.shp")
rm(ft_adj)
gc()

### sw
ft_sw <- st_intersection(ft_sw, 
                         w_bound)
ft_sw <- ft %>%
  filter(ft_id %in% ft_sw$ft_id)
st_write(ft_sw,
         "E:/usda_2023/usfs_fuel_treatments/western_us/sw_treatments_all.shp")
rm(ft_sw)
gc()

### northern
ft_n <- st_intersection(ft_n, 
                        w_bound)
ft_n <- ft %>%
  filter(ft_id %in% ft_n$ft_id)
st_write(ft_n,
         "E:/usda_2023/usfs_fuel_treatments/western_us/northern_treatments_all.shp")
rm(ft_n)
gc()

### pacific
ft_pacific <- st_intersection(ft_pacific, 
                              w_bound)
ft_pacific <- ft %>%
  filter(ft_id %in% ft_pacific$ft_id)
st_write(ft_pacific,
         "E:/usda_2023/usfs_fuel_treatments/western_us/pacific_treatments_all.shp")
rm(ft_pacific)
gc()
```

### Look at specific treatments
```{r}
### combine
ft_summ <- rbind(ft_pacific,
                 ft_sw,
                 ft_n, 
                 ft_adj)

### purpose codes
ft_summ <- ft_summ %>%
  mutate(purpose_code = ifelse(PURPOSE_CO == "FTF", "Fuels Treatment - Final", ifelse(PURPOSE_CO == "FTM", "Fuels Treatment - Maintenance", ifelse(PURPOSE_CO == "FTI", "Fuels Treatment - Initial or Interim", ifelse(PURPOSE_CO == "FIRE", "Wildfire", ifelse(PURPOSE_CO == "FUEL", "Fuels", ifelse(PURPOSE_CO == "TSI", "Timber Stand Improvement", ifelse(PURPOSE_CO == "TMBR", "Timber Management", ifelse(PURPOSE_CO == "BD", "Brush Disposal", ifelse(PURPOSE_CO == "WILD", "Wildlife", ifelse(PURPOSE_CO == "RF", "Reforestation", ifelse(PURPOSE_CO == "FE", "Fisheries Enhancement", ifelse(PURPOSE_CO == "DIS", "Disease Control", ifelse(PURPOSE_CO == "TES", "TES Species", ifelse(PURPOSE_CO == "CLTR", "Cultural Resources", ifelse(PURPOSE_CO == "REC", "Recreation", ifelse(PURPOSE_CO == "INS", "Insect Control", PURPOSE_CO)))))))))))))))))

### how many different treatments are there?
ft_summary <- ft_summ
st_geometry(ft_summary) <- NULL
ft_summary <- ft_summary %>%
  group_by(TREATMENT_, ACTIVITY, PURPOSE_CO, purpose_code) %>%
  summarise(n_rows = n())

# ### make column that categorizes activities
# ft <- ft %>%
#   mutate(treat_cat = ifelse(TREATMENT_ %in% c("Biomass Removal", "Chipping", "Crushing", "Lop and Scatter", "Machine Pile", "Thinning"), "mechanical", ifelse(TREATMENT_ == "Broadcast Burn", "rx_fire", ifelse(TREATMENT_ == "Fire Use", "managed_wildfire", ifelse(TREATMENT_ %in% c("Machine Pile Burn", "Jackpot Burn"), "other", TREATMENT_)))))

# ### write out treatment key
# ft_summ <- ft
# st_geometry(ft_summ) <- NULL
# ft_summ <- ft_summ %>%
#   group_by(treat_cat, TREATMENT_, ACTIVITY) %>%
#   summarise(n_rows = n())
# ft_summ <- ft_summ %>%
#   dplyr::select(-n_rows)
# write_csv(ft_summ, "treatment_codes.csv")

# #### List methods in each footprint
# unique_methods <- ft 
# st_geometry(unique_methods) <- NULL
# unique_methods <-  unique_methods %>%
#   group_by(footprint_id) %>%
#   summarise(all_methods = list(unique(treat_cat)))

# ### write out ft
# st_write(ft,
#          "E:/usda_2023/usfs_fuel_treatments/co_treatments.shp")

### clean up
rm(ft, ft_adj, ft_pacific, ft_n, ft_sw)
gc()
```

## Fire perimeters
### MTBS fire perimeters 
#### subset to western US
```{r}
### open all fires
mtbs <- st_read("E:/fire_sev_rdd/mtbs/mtbs_perims_DD.shp") %>%
  st_transform(crs = 6350)

### get column for state
mtbs <- mtbs %>%
  mutate(state = stringr::str_extract(Event_ID, "^.{2}"))

### filter to western US and surrounding states
mtbs <- mtbs %>%
  filter(state %in% c("AZ", "CA", "CO", "ID", "MT", "NM",
                      "NV", "OR", "UT", "WA", "WY", "ND",
                      "SD", "NE", "KS", "OK", "TX"))

### intersect with western US boundaries
mtbs <- st_intersection(mtbs, w_bound)

### reduce cols
mtbs <- mtbs %>%
  dplyr::select(Event_ID, Incid_Type, 
                Ig_Date, geometry)

### drop prescribed fires
mtbs <- mtbs %>%
  filter(!Incid_Type == "Prescribed Fire")

### Separate out year as column
mtbs <- mtbs %>%
  mutate(date = day(Ig_Date),
         month = month(Ig_Date),
         year = year(Ig_Date))

### Write out
st_write(mtbs,
         "E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_west.shp")

rm(w_bound)
```

#### intersect with fts (fire post-treatment)
##### adjacent states
```{r}
### open mtbs in western us
mtbs <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_west.shp")

### open ft and intersect
ft_adj <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/adj_treatments.shp")

### Add date cols for treatments
ft_adj <- ft_adj %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL))

### treatments completed range from 2007-2022

### drop MTBS fires before 2007
mtbs <- mtbs %>%
  filter(year > 2006)

### drop treatments that were completed after end of MTBS time series
ft_adj <- ft_adj %>%
  filter(year_comp < 2021)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_adj$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_adj[i, ]
  
  ### subset to fires that burned after
  mtbs_temp <- mtbs %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_adj$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
adj_treat_burn <- ft_adj[1, ]
adj_treat_burn <- adj_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(adj_treat_burn) <- NULL

### drop cols
adj_treat_burn <- adj_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
adj_treat_burn <- adj_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    adj_treat_burn <- rbind(adj_treat_burn,
                           temp_data)
  } 
  
}

### none of ft_adj burned
```

##### southwestern states
```{r}
### open mtbs in western us
mtbs <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_west.shp")

### open ft and intersect
ft_sw <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/sw_treatments.shp")

### Add date cols for treatments
ft_sw <- ft_sw %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL))

### when did the treatments occur?
range(ft_sw$year_comp)
### treatments completed range from 1997-2023

### drop MTBS fires before 2007
mtbs_sw <- mtbs %>%
  filter(year > 1996)

### drop treatments that were completed after end of mtbs_sw time series
ft_sw <- ft_sw %>%
  filter(year_comp < 2021)

### spatial filter on MTBS to sw states and adjacent states
mtbs_sw <- mtbs_sw %>%
  mutate(state = stringr::str_extract(Event_ID, "^.{2}"))
mtbs_sw <- mtbs_sw %>%
  filter(state %in% c("AZ", "CA", "CO", "ID", "NM",
                      "NV", "UT", "WY", 
                      "NE", "KS", "OK", "TX"))

### treatment types
table(ft_sw$PURPOSE_CO)
### 1 brush disposal
### 1 disease
### 3 wildlife
### 10 timber stand improvement
### 38 timber management
### 182 fuels
### 261 fire
### 799 fuels treatment - maintenance
### 2641 fuels treatment - final
### 4195 fuels treatment - initial/interim
```

###### purpose: fuels treatment - maintenance
```{r}
### restrict 
ft_sw_ftm <- ft_sw %>%
  filter(PURPOSE_CO == "FTM")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_ftm$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_ftm[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_ftm$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
sw_ftm_treat_burn <- ft_sw_ftm[1, ]
sw_ftm_treat_burn <- sw_ftm_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_ftm_treat_burn) <- NULL

### drop cols
sw_ftm_treat_burn <- sw_ftm_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_ftm_treat_burn <- sw_ftm_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_ftm_treat_burn <- rbind(sw_ftm_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_ftm_treat_burn <- sw_ftm_treat_burn %>%
  filter(!ft_id == "empty")

### 66 fuel treatments burned
```

###### purpose: fuels treatment - final
```{r}
### restrict 
ft_sw_ftf <- ft_sw %>%
  filter(PURPOSE_CO == "FTF")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_ftf$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_ftf[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_ftf$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
sw_ftf_treat_burn <- ft_sw_ftf[1, ]
sw_ftf_treat_burn <- sw_ftf_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_ftf_treat_burn) <- NULL

### drop cols
sw_ftf_treat_burn <- sw_ftf_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_ftf_treat_burn <- sw_ftf_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_ftf_treat_burn <- rbind(sw_ftf_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_ftf_treat_burn <- sw_ftf_treat_burn %>%
  filter(!ft_id == "empty")

### 170 fuel treatments burned
```

###### purpose: fuels treatment - initial/interim
```{r}
### restrict 
ft_sw_fti <- ft_sw %>%
  filter(PURPOSE_CO == "FTI")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_fti$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_fti[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_fti$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
sw_fti_treat_burn <- ft_sw_fti[1, ]
sw_fti_treat_burn <- sw_fti_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_fti_treat_burn) <- NULL

### drop cols
sw_fti_treat_burn <- sw_fti_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_fti_treat_burn <- sw_fti_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_fti_treat_burn <- rbind(sw_fti_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_fti_treat_burn <- sw_fti_treat_burn %>%
  filter(!ft_id == "empty")

### 251 fuel treatments burned
```

###### purpose: other
```{r}
### restrict 
ft_sw_other <- ft_sw %>%
  filter(!PURPOSE_CO %in% c("FTI", "FTF", "FTM")) %>%
  filter(!is.na(PURPOSE_CO))

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_other$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_other[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_other$ft_id)[i])
  
}

### See how many treatments burned
sw_other_treat_burn <- ft_sw_other[1, ]
sw_other_treat_burn <- sw_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_other_treat_burn) <- NULL

### drop cols
sw_other_treat_burn <- sw_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_other_treat_burn <- sw_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_other_treat_burn <- rbind(sw_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_other_treat_burn <- sw_other_treat_burn %>%
  filter(!ft_id == "empty")

### 129 fuel treatments burned
```

###### combine so far
```{r}
### combine
ft_multiple <- rbind(sw_ftm_treat_burn,
                     sw_ftf_treat_burn,
                     sw_fti_treat_burn,
                     sw_other_treat_burn)

### write out
write_csv(ft_multiple,
          "E:/usda_2023/usfs_fuel_treatments/western_us/sw_burned_ft.csv")
```


###### purpose: NA
```{r}
### restrict 
ft_sw_na <- ft_sw %>%
  filter(is.na(PURPOSE_CO))

table(ft_sw_na$TREATMENT_)
# Biomass Removal     Broadcast Burn           Chipping           Crushing 
#               1717               1250                316                188 
#           Fire Use       Jackpot Burn    Lop and Scatter       Machine Pile 
#                389                 46                452               1759 
#  Machine Pile Burn Mastication/Mowing                N/A           Thinning 
#               2133                  1                326               4150 

#### subset by treatment_

#################################
#################################
#################################
ft_sw_na_br <- ft_sw_na %>%
  filter(TREATMENT_ == "Biomass Removal")

### make list for storage
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_na_br$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_na_br[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_na_br$ft_id)[i])
  
}

### See how many treatments burned
sw_br_treat_burn <- ft_sw_na_br[1, ]
sw_br_treat_burn <- sw_br_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_br_treat_burn) <- NULL

### drop cols
sw_br_treat_burn <- sw_br_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_br_treat_burn <- sw_br_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_br_treat_burn <- rbind(sw_br_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_br_treat_burn <- sw_br_treat_burn %>%
  filter(!ft_id == "empty")

### 214 fuel treatments burned

#################################
#################################
#################################
ft_sw_na_bb <- ft_sw_na %>%
  filter(TREATMENT_ == "Broadcast Burn")

### make list for storage
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_na_bb$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_na_bb[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_na_bb$ft_id)[i])
  
}

### See how many treatments burned
sw_other_bb_burn <- ft_sw_na_bb[1, ]
sw_other_bb_burn <- sw_other_bb_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_other_bb_burn) <- NULL

### drop cols
sw_other_bb_burn <- sw_other_bb_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_other_bb_burn <- sw_other_bb_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_other_bb_burn <- rbind(sw_other_bb_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_other_bb_burn <- sw_other_bb_burn %>%
  filter(!ft_id == "empty")

### 338 fuel treatments burned

#################################
#################################
#################################
ft_sw_na_mp <- ft_sw_na %>%
  filter(TREATMENT_ == "Machine Pile")

### make list for storage
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_na_mp$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_na_mp[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_na_mp$ft_id)[i])
  
}

### See how many treatments burned
sw_other_mp_burn <- ft_sw_na_mp[1, ]
sw_other_mp_burn <- sw_other_mp_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_other_mp_burn) <- NULL

### drop cols
sw_other_mp_burn <- sw_other_mp_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_other_mp_burn <- sw_other_mp_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_other_mp_burn <- rbind(sw_other_mp_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_other_mp_burn <- sw_other_mp_burn %>%
  filter(!ft_id == "empty")

### 259 fuel treatments burned

#################################
#################################
#################################
ft_sw_na_mpb <- ft_sw_na %>%
  filter(TREATMENT_ == "Machine Pile Burn")

### make list for storage
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_na_mpb$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_na_mpb[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_na_mpb$ft_id)[i])
  
}

### See how many treatments burned
sw_other_mpb_burn <- ft_sw_na_mpb[1, ]
sw_other_mpb_burn <- sw_other_mpb_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_other_mpb_burn) <- NULL

### drop cols
sw_other_mpb_burn <- sw_other_mpb_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_other_mpb_burn <- sw_other_mpb_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_other_mpb_burn <- rbind(sw_other_mpb_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_other_mpb_burn <- sw_other_mpb_burn %>%
  filter(!ft_id == "empty")

### 370 fuel treatments burned

#################################
#################################
#################################

ft_sw_na_thin <- ft_sw_na %>%
  filter(TREATMENT_ == "Thinning")

### make list for storage
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_na_thin$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_na_thin[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_na_thin$ft_id)[i])
  
}

### See how many treatments burned
sw_other_thin_burn <- ft_sw_na_thin[1, ]
sw_other_thin_burn <- sw_other_thin_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_other_thin_burn) <- NULL

### drop cols
sw_other_thin_burn <- sw_other_thin_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_other_thin_burn <- sw_other_thin_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_other_thin_burn <- rbind(sw_other_thin_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_other_thin_burn <- sw_other_thin_burn %>%
  filter(!ft_id == "empty")

### 565 fuel treatments burned

#################################
#################################
#################################
### combine
sw_na_combined <- rbind(sw_br_treat_burn, 
                        sw_other_bb_burn,
                        sw_other_mp_burn,
                        sw_other_mpb_burn,
                        sw_other_thin_burn)

### write out
write_csv(sw_na_combined,
          "E:/usda_2023/usfs_fuel_treatments/western_us/sw_burned_ft_part2.csv")

```

###### the rest of the NAs
```{r}
### restrict 
ft_sw_na_remaining <- ft_sw_na %>%
  filter(!TREATMENT_ %in% c("Biomass Removal",
                            "Broadcast Burn",
                            "Machine Pile",
                            "Machine Pile Burn",
                            "Thinning"))

### make list for storage
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_na_remaining$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_na_remaining[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect,
                                   unique(ft_sw_na_remaining$ft_id)[i])
  
}

### See how many treatments burned
sw_remaining_treat_burn <- ft_sw_na_remaining[1, ]
sw_remaining_treat_burn <- sw_remaining_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_remaining_treat_burn) <- NULL

### drop cols
sw_remaining_treat_burn <- sw_remaining_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_remaining_treat_burn <- sw_remaining_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_remaining_treat_burn <- rbind(sw_remaining_treat_burn,
                                     temp_data)
  } 
  
}

### drop the empty row
sw_remaining_treat_burn <- sw_remaining_treat_burn %>%
  filter(!ft_id == "empty")

### 294 fuel treatments burned

### write out
write_csv(sw_remaining_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/sw_burned_ft_part3.csv")

### combine all
sw_na_all <- rbind(sw_br_treat_burn, 
                   sw_other_bb_burn,
                   sw_other_mp_burn,
                   sw_other_mpb_burn,
                   sw_other_thin_burn,
                   sw_remaining_treat_burn,
                   ft_multiple)

### write out
write_csv(sw_na_combined,
          "E:/usda_2023/usfs_fuel_treatments/western_us/sw_burned_ft_all.csv")

rm(sw_br_treat_burn, sw_ftf_treat_burn, sw_fti_treat_burn, sw_ftm_treat_burn,
   sw_na_all, sw_na_combined, sw_other_bb_burn, sw_other_mp_burn,
   sw_other_mpb_burn, sw_other_thin_burn, sw_other_treat_burn)
rm(ft_sw, ft_sw_ftf, ft_sw_fti, ft_sw_ftm, ft_sw_na, ft_sw_na_bb,
   ft_sw_na_br, ft_sw_na_mp, ft_sw_na_mpb, ft_sw_na_remaining,
   ft_sw_na_thin, ft_sw_other)
rm(mtbs_sw, sw_remaining_treat_burn, store_intersect_all,
   ft_multiple)
rm(mtbs_sw_temp)
```

##### northern states
```{r}
### open ft 
ft_n <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/northern_treatments.shp")

### Add date cols for treatments
ft_n <- ft_n %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL))

### when did the treatments occur?
range(ft_n$year_comp)
sort(unique(ft_n$year_comp))
### treatments completed range from 1900-2023

### drop treatments that were completed before or after mtbs time series
ft_n <- ft_n %>%
  filter(year_comp > 1983 &
           year_comp < 2021)

### spatial filter on MTBS to sw states and adjacent states
mtbs_n <- mtbs %>%
  mutate(state = stringr::str_extract(Event_ID, "^.{2}"))
mtbs_n <- mtbs_n %>%
  filter(state %in% c("MT", "ID", "WY", "NV",
                      "WA", "OR", "CA", "UT",
                      "AZ", "CO", "NE", "SD", "ND"))

### treatment types
table(ft_n$PURPOSE_CO)
### 24 disease
### 7 wildlife
### 189 timber stand improvement
### 17 timber management
### 294 fuels
### 968 fire
### 1907 fuels treatment - maintenance
### 4267 fuels treatment - final
### 14499 fuels treatment - initial/interim
### 1 recreation
### 3 reforestation
### 9 insect control
```

###### purpose: fuels treatment - maintenance
```{r}
### restrict 
ft_n_ftm <- ft_n %>%
  filter(PURPOSE_CO == "FTM")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_ftm$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_ftm[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_ftm$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_ftm_treat_burn <- ft_n_ftm[1, ]
n_ftm_treat_burn <- n_ftm_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_ftm_treat_burn) <- NULL

### drop cols
n_ftm_treat_burn <- n_ftm_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_ftm_treat_burn <- n_ftm_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_ftm_treat_burn <- rbind(n_ftm_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_ftm_treat_burn <- n_ftm_treat_burn %>%
  filter(!ft_id == "empty")

### 22 fuel treatments burned
```

###### purpose: fuel treatments final 
```{r}
### restrict 
ft_n_ftf <- ft_n %>%
  filter(PURPOSE_CO == "FTF")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_ftf$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_ftf[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_ftf$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_ftf_treat_burn <- ft_n_ftf[1, ]
n_ftf_treat_burn <- n_ftf_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_ftf_treat_burn) <- NULL

### drop cols
n_ftf_treat_burn <- n_ftf_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_ftf_treat_burn <- n_ftf_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_ftf_treat_burn <- rbind(n_ftf_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_ftf_treat_burn <- n_ftf_treat_burn %>%
  filter(!ft_id == "empty")
```

###### purpose: fuel treatments interim/intermed 
```{r}
###### purpose: fuel treatments interim/intermed 
### restrict 
ft_n_fti <- ft_n %>%
  filter(PURPOSE_CO == "FTI")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_fti$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_fti[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_fti$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_fti_treat_burn <- ft_n_fti[1, ]
n_fti_treat_burn <- n_fti_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_fti_treat_burn) <- NULL

### drop cols
n_fti_treat_burn <- n_fti_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_fti_treat_burn <- n_fti_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_fti_treat_burn <- rbind(n_fti_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_fti_treat_burn <- n_fti_treat_burn %>%
  filter(!ft_id == "empty")
```

###### combine FTM, FTF, FTI
```{r}
### combine
n_fts <- rbind(n_ftm_treat_burn,
               n_ftf_treat_burn,
               n_fti_treat_burn)

### write out
write_csv(n_fts,
          "E:/usda_2023/usfs_fuel_treatments/western_us/n_burned_ft_part1.csv")
```

###### purpose: other than FTF, FTM, FTI (not NA)
```{r}
###### purpose: other than FTF, FTM, FTI 

### restrict 
ft_n_other <- ft_n %>%
  filter(!PURPOSE_CO %in% c("FTF", "FTM", "FTI")) %>%
  filter(!is.na(PURPOSE_CO))

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_other$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_other[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_other$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_other_treat_burn <- ft_n_other[1, ]
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_other_treat_burn) <- NULL

### drop cols
n_other_treat_burn <- n_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_other_treat_burn <- rbind(n_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_other_treat_burn <- n_other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(n_other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/n_other_burned.csv")
```

###### purpose: NA, broadcast burn
```{r}
### restrict 
ft_n_na <- ft_n %>%
  filter(is.na(PURPOSE_CO))

### counts
table(ft_n_na$TREATMENT_)

### subset for loop
ft_n_na_1 <- ft_n_na %>%
  filter(TREATMENT_ == "Broadcast Burn")
rm(ft_n_na)
gc()

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_na_1$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_na_1[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_na_1$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_other_treat_burn <- ft_n_na_1[1, ]
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_other_treat_burn) <- NULL

### drop cols
n_other_treat_burn <- n_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_other_treat_burn <- rbind(n_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_other_treat_burn <- n_other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(n_other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/n_other_burned_na_1.csv")
```

###### purpose: NA, not broadcast burn/thinning/biomass removal/machine pile burn
```{r}
### restrict 
ft_n_na <- ft_n %>%
  filter(is.na(PURPOSE_CO))

### subset for loop
ft_n_na_2 <- ft_n_na %>%
  filter(!TREATMENT_ %in% c("Broadcast Burn",
                            "Thinning",
                            "Machine Pile Burn",
                            "Biomass Removal"))
rm(ft_n_na)
gc()

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_na_2$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_na_2[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_na_2$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_other_treat_burn <- ft_n_na_2[1, ]
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_other_treat_burn) <- NULL

### drop cols
n_other_treat_burn <- n_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_other_treat_burn <- rbind(n_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_other_treat_burn <- n_other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(n_other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/n_other_burned_na_2.csv")
```


###### purpose: NA, biomass removal/machine pile burn
```{r}
### restrict 
ft_n_na <- ft_n %>%
  filter(is.na(PURPOSE_CO))

### subset for loop
ft_n_na_3 <- ft_n_na %>%
  filter(TREATMENT_ %in% c("Machine Pile Burn",
                            "Biomass Removal"))
rm(ft_n_na)
gc()

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_na_3$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_na_3[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_na_3$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_other_treat_burn <- ft_n_na_3[1, ]
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_other_treat_burn) <- NULL

### drop cols
n_other_treat_burn <- n_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_other_treat_burn <- rbind(n_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_other_treat_burn <- n_other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(n_other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/n_other_burned_na_3.csv")
```

###### purpose: NA, thinning before 2011
```{r}
### restrict 
ft_n_na <- ft_n %>%
  filter(is.na(PURPOSE_CO))

### subset for loop
ft_n_na_4 <- ft_n_na %>%
  filter(TREATMENT_ %in% c("Thinning"))
table(ft_n_na_4$year_comp)

### subset years
ft_n_na_4 <- ft_n_na_4 %>%
  filter(year_comp < 2011)

rm(ft_n_na)
gc()

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_na_4$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_na_4[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_na_4$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_other_treat_burn <- ft_n_na_4[1, ]
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_other_treat_burn) <- NULL

### drop cols
n_other_treat_burn <- n_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_other_treat_burn <- rbind(n_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_other_treat_burn <- n_other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(n_other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/n_other_burned_na_4.csv")
```

###### purpose: NA, thinning 2011 onwards
```{r}
### restrict 
ft_n_na <- ft_n %>%
  filter(is.na(PURPOSE_CO))

### subset for loop
ft_n_na_5 <- ft_n_na %>%
  filter(TREATMENT_ %in% c("Thinning"))%>%
  filter(year_comp > 2010)

rm(ft_n_na)
gc()

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_na_5$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_na_5[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_na_5$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_other_treat_burn <- ft_n_na_5[1, ]
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_other_treat_burn) <- NULL

### drop cols
n_other_treat_burn <- n_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_other_treat_burn <- rbind(n_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_other_treat_burn <- n_other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(n_other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/n_other_burned_na_5.csv")
```

###### combine northern states
```{r}
### open all csvs
n_1 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/n_burned_ft_part1.csv")
n_2 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/n_other_burned.csv")
n_3 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/n_other_burned_na_1.csv")
n_4 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/n_other_burned_na_2.csv")
n_5 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/n_other_burned_na_3.csv")
n_6 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/n_other_burned_na_4.csv")
n_7 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/n_other_burned_na_5.csv")

### combine
n_fts_all <- rbind(n_1, n_2, n_3, n_4,
                   n_5, n_6, n_7)

### write out
write_csv(n_fts_all,
          "E:/usda_2023/usfs_fuel_treatments/western_us/n_burned_ft_all_updated.csv")

### check
ft_n_check <- ft_n %>%
  dplyr::filter(ft_id %in% n_fts_all$ft_id)
st_write(ft_n_check, "E:/usda_2023/usfs_fuel_treatments/western_us/n_burned_ft_check_updated.shp")

```

##### pacific states
```{r}
### open ft 
ft_pac <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_treatments.shp")

### Add date cols for treatments
ft_pac <- ft_pac %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL))

### when did the treatments occur?
range(ft_pac$year_comp)
### treatments completed range from 1939-2023

### drop treatments that were completed before or after mtbs time series
ft_pac <- ft_pac %>%
  filter(year_comp > 1983 &
           year_comp < 2021)

### spatial filter on MTBS to pac states and adjacent states
mtbs_pac <- mtbs %>%
  mutate(state = stringr::str_extract(Event_ID, "^.{2}"))
mtbs_pac <- mtbs_pac %>%
  filter(state %in% c("WA", "OR", "CA",
                      "ID", "NV", "AZ"))

### treatment types
table(ft_pac$PURPOSE_CO)
### 22 brush disposal
### 1 TES species
### 2 cultural resources
### 2 disease
### 97 wildlife
### 7 fisheries
### 144 timber stand improvement
### 295 timber management
### 300 fuels
### 2817 fire
### 11217 fuels treatment - maintenance
### 5819 fuels treatment - final
### 32449 fuels treatment - initial/interim
### 40 reforestation
```

###### purpose: not FT and not NA
```{r}
### restrict 
ft_pac_other <- ft_pac %>%
  filter(!PURPOSE_CO %in% c("FTM",
                            "FTF",
                            "FTI")) %>%
  filter(!is.na(PURPOSE_CO))

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_other$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_other[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_other$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_other_treat_burn <- ft_pac_other[1, ]
pac_other_treat_burn <- pac_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_other_treat_burn) <- NULL

### drop cols
pac_other_treat_burn <- pac_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_other_treat_burn <- pac_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_other_treat_burn <- rbind(pac_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_other_treat_burn <- pac_other_treat_burn %>%
  filter(!ft_id == "empty")

### 1517 fuel treatments burned

write_csv(pac_other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_other.csv")
rm(store_intersect_all, mtbs_n_temp, ft_pac_other)
```

###### purpose: FTF
```{r}
### restrict 
ft_pac_ftf <- ft_pac %>%
  filter(PURPOSE_CO == "FTF") 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_ftf$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_ftf[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_ftf$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_ftf_treat_burn <- ft_pac_ftf[1, ]
pac_ftf_treat_burn <- pac_ftf_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_ftf_treat_burn) <- NULL

### drop cols
pac_ftf_treat_burn <- pac_ftf_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_ftf_treat_burn <- pac_ftf_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_ftf_treat_burn <- rbind(pac_ftf_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_ftf_treat_burn <- pac_ftf_treat_burn %>%
  filter(!ft_id == "empty")

### 362 fuel treatments burned

write_csv(pac_ftf_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_ftf.csv")
rm(store_intersect_all, mtbs_n_temp)
rm(ft_pac_ftf)
```

###### purpose: FTM
```{r}
### restrict 
ft_pac_ftm <- ft_pac %>%
  filter(PURPOSE_CO == "FTM") 

table(ft_pac_ftm$TREATMENT_)

### run for mpb
ft_pac_ftm_mp <- ft_pac_ftm %>%
  filter(TREATMENT_ == "Machine Pile Burn") 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_ftm_mp$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_ftm_mp[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_ftm_mp$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_ftm_mp_treat_burn <- ft_pac_ftm_mp[1, ]
pac_ftm_mp_treat_burn <- pac_ftm_mp_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_ftm_mp_treat_burn) <- NULL

### drop cols
pac_ftm_mp_treat_burn <- pac_ftm_mp_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_ftm_mp_treat_burn <- pac_ftm_mp_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_ftm_mp_treat_burn <- rbind(pac_ftm_mp_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_ftm_mp_treat_burn <- pac_ftm_mp_treat_burn %>%
  filter(!ft_id == "empty")

rm(ft_pac_ftm_mp)

### 105 fuel treatments burned

########################
########################

table(ft_pac_ftm$TREATMENT_)

### run for mpb
ft_pac_ftm_mpp <- ft_pac_ftm %>%
  filter(TREATMENT_ == "Machine Pile") 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_ftm_mpp$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_ftm_mpp[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_ftm_mpp$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_ftm_mpp_treat_burn <- ft_pac_ftm_mpp[1, ]
pac_ftm_mpp_treat_burn <- pac_ftm_mpp_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_ftm_mpp_treat_burn) <- NULL

### drop cols
pac_ftm_mpp_treat_burn <- pac_ftm_mpp_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_ftm_mpp_treat_burn <- pac_ftm_mpp_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_ftm_mpp_treat_burn <- rbind(pac_ftm_mpp_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_ftm_mpp_treat_burn <- pac_ftm_mpp_treat_burn %>%
  filter(!ft_id == "empty")

### 200 fuel treatments burned

# ### combine and write out
# pca_ftm_2 <- rbind(pac_ftm_mp_treat_burn,
#                    pac_ftm_mpp_treat_burn)
# write_csv(pca_ftm_2,
#           "E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_ftm_1.csv")

########################
########################

table(ft_pac_ftm$TREATMENT_)

### run for Thinning
ft_pac_ftm_thin <- ft_pac_ftm %>%
  filter(TREATMENT_ == "Thinning") 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_ftm_thin$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_ftm_thin[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_ftm_thin$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_ftm_thin_treat_burn <- ft_pac_ftm_thin[1, ]
pac_ftm_thin_treat_burn <- pac_ftm_thin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_ftm_thin_treat_burn) <- NULL

### drop cols
pac_ftm_thin_treat_burn <- pac_ftm_thin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_ftm_thin_treat_burn <- pac_ftm_thin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_ftm_thin_treat_burn <- rbind(pac_ftm_thin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_ftm_thin_treat_burn <- pac_ftm_thin_treat_burn %>%
  filter(!ft_id == "empty")

### 651 treatments burned

########################
########################

table(ft_pac_ftm$TREATMENT_)

### run for the rest of the treatments
ft_pac_ftm_remain <- ft_pac_ftm %>%
  filter(!TREATMENT_ %in% c("Thinning",
                            "Machine Pile",
                            "Machine Pile Burn")) 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_ftm_remain$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_ftm_remain[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_ftm_remain$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_ftm_remain_treat_burn <- ft_pac_ftm_remain[1, ]
pac_ftm_remain_treat_burn <- pac_ftm_remain_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_ftm_remain_treat_burn) <- NULL

### drop cols
pac_ftm_remain_treat_burn <- pac_ftm_remain_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_ftm_remain_treat_burn <- pac_ftm_remain_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_ftm_remain_treat_burn <- rbind(pac_ftm_remain_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_ftm_remain_treat_burn <- pac_ftm_remain_treat_burn %>%
  filter(!ft_id == "empty")

### 250 treatments burned

### combine and write out
pac_ftm_all <- rbind(pac_ftm_mp_treat_burn,
                     pac_ftm_mpp_treat_burn,
                     pac_ftm_thin_treat_burn,
                     pac_ftm_remain_treat_burn)

write_csv(pac_ftm_all,
          "E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_ftm_all.csv")
rm(store_intersect_all, pac_ftm_all, pac_ftm_mp_treat_burn, pac_ftm_mpp_treat_burn,
   pac_ftm_remain_treat_burn, pac_ftm_thin_treat_burn)
```

###### purpose: FTI
```{r}
### restrict 
ft_pac_fti <- ft_pac %>%
  filter(PURPOSE_CO == "FTI") 

table(ft_pac_fti$TREATMENT_)

 #   Biomass Removal     Broadcast Burn           Chipping           Crushing 
 #              2708                701                359                380 
 #          Fire Use       Jackpot Burn    Lop and Scatter       Machine Pile 
 #                91                 77               1573               6837 
 # Machine Pile Burn Mastication/Mowing                N/A           Thinning 
 #              4308                 22                  2              15368 

### run for mp
ft_pac_fti_mp <- ft_pac_fti %>%
  filter(TREATMENT_ == "Machine Pile") 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_mp$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_mp[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_mp$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_mp_treat_burn <- ft_pac_fti_mp[1, ]
pac_fti_mp_treat_burn <- pac_fti_mp_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_mp_treat_burn) <- NULL

### drop cols
pac_fti_mp_treat_burn <- pac_fti_mp_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_mp_treat_burn <- pac_fti_mp_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_mp_treat_burn <- rbind(pac_fti_mp_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_mp_treat_burn <- pac_fti_mp_treat_burn %>%
  filter(!ft_id == "empty")

# rm(ft_pac_fti_mp)

### 290 fuel treatments burned
write_csv(pac_fti_mp_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_fti_machpile.csv")

########################
########################

table(ft_pac_fti$TREATMENT_)

 #   Biomass Removal     Broadcast Burn           Chipping           Crushing 
 #              2708                701                359                380 
 #          Fire Use       Jackpot Burn    Lop and Scatter       Machine Pile 
 #                91                 77               1573               6837 
 # Machine Pile Burn Mastication/Mowing                N/A           Thinning 
 #              4308                 22                  2              15368 

### run for mpb
ft_pac_fti_mpb <- ft_pac_fti %>%
  filter(TREATMENT_ == "Machine Pile Burn") 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_mpb$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_mpb[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_mpb$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_mpb_treat_burn <- ft_pac_fti_mpb[1, ]
pac_fti_mpb_treat_burn <- pac_fti_mpb_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_mpb_treat_burn) <- NULL

### drop cols
pac_fti_mpb_treat_burn <- pac_fti_mpb_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_mpb_treat_burn <- pac_fti_mpb_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_mpb_treat_burn <- rbind(pac_fti_mpb_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_mpb_treat_burn <- pac_fti_mpb_treat_burn %>%
  filter(!ft_id == "empty")

### 300 fuel treatments burned

write_csv(pac_fti_mpb_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_fti_machpileburn.csv")

########################
########################

table(ft_pac_fti$TREATMENT_)

### run for biomass removal
ft_pac_fti_biomass <- ft_pac_fti %>%
  filter(TREATMENT_ == "Biomass Removal") 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_biomass$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_biomass[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_biomass$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_biomass_treat_burn <- ft_pac_fti_biomass[1, ]
pac_fti_biomass_treat_burn <- pac_fti_biomass_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_biomass_treat_burn) <- NULL

### drop cols
pac_fti_biomass_treat_burn <- pac_fti_biomass_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_biomass_treat_burn <- pac_fti_biomass_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_biomass_treat_burn <- rbind(pac_fti_biomass_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_biomass_treat_burn <- pac_fti_biomass_treat_burn %>%
  filter(!ft_id == "empty")

### 208 fuel treatments burned

write_csv(pac_fti_biomass_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_fti_biomass_removal.csv")

rm(ft_pac_fti_biomass,
   pac_fti_biomass_treat_burn)
rm(store_intersect_all, mtbs_n_temp)
gc()
########################
########################

table(ft_pac_fti$TREATMENT_)

### run for thinning
ft_pac_fti_thin <- ft_pac_fti %>%
  filter(TREATMENT_ == "Thinning") 

### there are a lot of thinning treatments!
table(ft_pac_fti_thin$ACTIVITY)
#                                          Commercial Thin 
#                                                     4975 
#                                               Fuel Break 
#                                                       79 
#                                       Precommercial Thin 
#                                                     6650 
#                        Precommercial thinning for visual 
#                                                       20 
#                                                    Prune 
#                                                      273 
# Pruning to Raise Canopy Height and Discourage Crown Fire 
#                                                      542 
#   Salvage Cut (intermediate treatment, not regeneration) 
#                                                      966 
#                                           Sanitation Cut 
#                                                      102 
#                    Site Preparation for Planting - Other 
#                                                       32 
#                   Thinning for Hazardous Fuels Reduction 
#                                                     1483 
#                                    Tree Release and Weed 
#                                                      122 
#                        Wildlife Habitat Intermediate cut 
#                                                        6 
#                  Wildlife Habitat Precommercial thinning 
#                                                      118 

rm(ft_pac_fti_thin)

### run for commercial thinning
ft_pac_fti_commthin <- ft_pac_fti %>%
  filter(TREATMENT_ == "Thinning") %>%
  filter(ACTIVITY == "Commercial Thin")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_commthin$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_commthin[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_commthin$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_fti_commthin[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

### 387 fuel treatments burned

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_fti_comm_thin.csv")

rm(pac_fti_commthin_treat_burn, ft_pac_fti_commthin,
   store_intersect_all)
gc()
########################
########################
```
###### more fti subsets
```{r}
### there are a lot of thinning treatments!
# table(ft_pac_fti_thin$ACTIVITY)
#                                          Commercial Thin 
#                                                     4975 
#                                               Fuel Break 
#                                                       79 
#                                       Precommercial Thin 
#                                                     6650 
#                        Precommercial thinning for visual 
#                                                       20 
#                                                    Prune 
#                                                      273 
# Pruning to Raise Canopy Height and Discourage Crown Fire 
#                                                      542 
#   Salvage Cut (intermediate treatment, not regeneration) 
#                                                      966 
#                                           Sanitation Cut 
#                                                      102 
#                    Site Preparation for Planting - Other 
#                                                       32 
#                   Thinning for Hazardous Fuels Reduction 
#                                                     1483 
#                                    Tree Release and Weed 
#                                                      122 
#                        Wildlife Habitat Intermediate cut 
#                                                        6 
#                  Wildlife Habitat Precommercial thinning 
#                                                      118 

### run for Precommercial Thin
ft_pac_fti_precommthin <- ft_pac_fti %>%
  filter(TREATMENT_ == "Thinning") %>%
  filter(ACTIVITY == "Precommercial Thin")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_precommthin$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_precommthin[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_precommthin$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_precommthin_treat_burn <- ft_pac_fti_precommthin[1, ]
pac_fti_precommthin_treat_burn <- pac_fti_precommthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_precommthin_treat_burn) <- NULL

### drop cols
pac_fti_precommthin_treat_burn <- pac_fti_precommthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_precommthin_treat_burn <- pac_fti_precommthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_precommthin_treat_burn <- rbind(pac_fti_precommthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_precommthin_treat_burn <- pac_fti_precommthin_treat_burn %>%
  filter(!ft_id == "empty")

### 387 fuel treatments burned

write_csv(pac_fti_precommthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_fti_precomm_thin.csv")

rm(pac_fti_precommthin_treat_burn, ft_pac_fti_precommthin,
   store_intersect_all)
gc()
########################
########################

### run for Thinning for Hazardous Fuels Reduction
ft_pac_fti_thin_haz <- ft_pac_fti %>%
  filter(TREATMENT_ == "Thinning") %>%
  filter(ACTIVITY == "Thinning for Hazardous Fuels Reduction")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_thin_haz$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_thin_haz[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_thin_haz$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_thinhaz_treat_burn <- ft_pac_fti_thin_haz[1, ]
pac_fti_thinhaz_treat_burn <- pac_fti_thinhaz_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_thinhaz_treat_burn) <- NULL

### drop cols
pac_fti_thinhaz_treat_burn <- pac_fti_thinhaz_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_thinhaz_treat_burn <- pac_fti_thinhaz_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_thinhaz_treat_burn <- rbind(pac_fti_thinhaz_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_thinhaz_treat_burn <- pac_fti_thinhaz_treat_burn %>%
  filter(!ft_id == "empty")

### 387 fuel treatments burned

write_csv(pac_fti_thinhaz_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_fti_hazfuel_thin.csv")

rm(pac_fti_thinhaz_treat_burn, ft_pac_fti_thin_haz,
   store_intersect_all)
gc()
########################
########################
### remaining thinning treatments
ft_pac_fti_remain <- ft_pac_fti %>%
  filter(TREATMENT_ == "Thinning") %>%
  filter(!ACTIVITY %in% c("Thinning for Hazardous Fuels Reduction",
                          "Precommercial Thin",
                          "Commercial Thin"))

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_remain$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_remain[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_remain$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_remain_treat_burn <- ft_pac_fti_remain[1, ]
pac_fti_remain_treat_burn <- pac_fti_remain_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_remain_treat_burn) <- NULL

### drop cols
pac_fti_remain_treat_burn <- pac_fti_remain_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_remain_treat_burn <- pac_fti_remain_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_remain_treat_burn <- rbind(pac_fti_remain_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_remain_treat_burn <- pac_fti_remain_treat_burn %>%
  filter(!ft_id == "empty")

### 387 fuel treatments burned

write_csv(pac_fti_remain_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_fti_remaining_thin.csv")

# rm(pac_fti_thinhaz_treat_burn, ft_pac_fti_thin_haz,
#    store_intersect_all)
# gc()
```

###### combine pacific
```{r}
p1 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_ftf.csv")
p2 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_ftm_all.csv")
p3 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_fti_machpile.csv")
p4 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_fti_machpileburn.csv")
p5 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_fti_biomass_removal.csv")
p6 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_fti_comm_thin.csv")
p7 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_fti_precomm_thin.csv")
p8 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_fti_hazfuel_thin.csv")
p9 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_fti_remaining_thin.csv")

### combine
all_fti <- rbind(p1, p2, p3, p4, p5,
                 p6, p7, p8, p9)

### write out
write_csv(all_fti,
          "E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_ft_all.csv")
```


##### combine all regions
```{r}
n_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/n_burned_ft_all.csv")
sw_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/sw_burned_ft_all.csv")

### combine all
all_fts <- rbind(all_fti,
                 n_fts,
                 sw_fts)

### write out
write_csv(all_fts,
          "E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fts_w_us.csv")
```

### treatment footprints without wildfire treatments 
ex. Wildfire - Human Ignition, Wildland Fire Use
```{r}
### open fuel treatment footprints
ft_adj <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/adj_treatments.shp")
ft_pacific <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_treatments.shp")
ft_northern <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/northern_treatments.shp")
ft_sw <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/sw_treatments.shp")

### combine
ft_all <- rbind(ft_adj,
                ft_pacific,
                ft_sw,
                ft_northern)

### remove wildfires
ft_all <- ft_all %>%
  filter(!ACTIVITY %in% c("Wildfire - Fuels Benefit",
                          "Wildfire - Human Ignition",
                          "Wildfire - Natural Ignition",
                          "Planned Treatment Burned in Wildfire",
                          "Wildland Fire Use"))

### write out for visualization
st_write(ft_all, "E:/usda_2023/usfs_fuel_treatments/western_us/all_treatments_non_wf.shp")
```

## Burned treatment footprints (take 1)
Did this before I re-did the loop to catch stray burned FTs
```{r}
### Open csv of all burned footprints
all_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fts_w_us.csv")

### Open all MTBS fires
mtbs_all <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_west.shp")

### restrict to fires that subsequently burned fuel treatments
mtbs_all <- mtbs_all %>% 
  filter(Event_ID %in% all_fts$Event_ID)
st_write(mtbs_all,
          "E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_fuel_treats.shp")

### Open fuel treatment database
ft <- st_read("E:/usda_2023/usfs_fuel_treatments/S_USA.Activity_HazFuelTrt_PL.shp") %>%
  mutate(., ft_id = row_number())

### restrict to fuel treatments that subsequently burned
ft_burned <- ft %>%
  filter(ft_id %in% all_fts$ft_id)

### are some of the fuel treatments in the burned dataset more than once?
length(unique(all_fts$ft_id))
### yes!

### add sf to ft's
ft_burned_shp <- ft_burned %>%
  dplyr::select(ft_id,
                STATE_ABBR,
                ACTIVITY_C,
                ACTIVITY,
                TREATMENT_,
                TREATMENT1,
                geometry)
st_write(ft_burned_shp,
         "E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats.shp")

### Make table of activity counts by state
ft_burned_csv <- ft_burned_shp 
st_geometry(ft_burned_csv) <- NULL
ft_burned_summ <- ft_burned_csv %>%
  group_by(STATE_ABBR,
           ACTIVITY) %>%
  summarise(treatment_count = length(unique(ft_id)))
write_csv(ft_burned_csv,
          "E:/usda_2023/usfs_fuel_treatments/western_us/ft_summary.csv")

### limit to CA and CO
ca_co_summ <- ft_burned_summ %>%
  filter(STATE_ABBR %in% c("CO", "CA"))
write_csv(ca_co_summ,
          "E:/usda_2023/usfs_fuel_treatments/western_us/ft_summary_ca_co.csv")
```

## Treatments that might have been missed in loops
```{r}
### burned treatments
ft_burned <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats.shp")

### all fuel treatment footprints (minus wildfire ones)
all_fts <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/all_treatments_non_wf.shp")

### filter out treatments that I know burned
all_fts_unb <- all_fts %>%
  filter(!ft_id %in% ft_burned$ft_id)

# st_write(all_fts_unb,
#          "E:/usda_2023/usfs_fuel_treatments/western_us/fts_to_check.shp")

### remove intermediates
rm(all_fts, ft_burned)

### do some of the fuel treatments overlap with MTBS (regardless of temporal sequence?)

### open mtbs
mtbs <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_west.shp")

### subset to ft's within MTBS borders
fts_mtbs <- st_intersection(all_fts_unb,
                            mtbs)

length(unique(all_fts_unb$ft_id)) ## 213021
length(unique(fts_mtbs$ft_id))    ## 39071

### get full polygons for footprints that overlap
fts_mtbs_comp <- all_fts_unb %>%
  filter(ft_id %in% fts_mtbs$ft_id)

rm(all_fts_unb, fts_mtbs)

### table
table(fts_mtbs_comp$PURPOSE_CO)

### Add date cols for treatments
fts_mtbs_comp <- fts_mtbs_comp %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL))
```

#### loop through for subsequent fires
##### FTM 
```{r}
### subset
ftm <- fts_mtbs_comp %>%
  filter(PURPOSE_CO == "FTM")

### mtbs is only through 2020 so restrict ftm
ftm <- ftm %>%
  filter(year_comp < 2021)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ftm$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ftm[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ftm$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- ftm[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

### 1517 fuel treatments burned

write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/second_loop_1.csv")
```

##### FTF (2416)
```{r}
### subset
ftf <- fts_mtbs_comp %>%
  filter(PURPOSE_CO == "FTF")

### mtbs is only through 2020 so restrict ftf
ftf <- ftf %>%
  filter(year_comp < 2021)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ftf$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ftf[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ftf$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- ftf[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

### 1517 fuel treatments burned

write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/second_loop_2.csv")
```

##### not NA, FTF, FTI, or FTM
```{r}
### subset
ft_other <- fts_mtbs_comp %>%
  filter(!PURPOSE_CO %in% c("FTF", "FTM", "FTI")) %>%
  filter(!is.na(PURPOSE_CO))

### mtbs is only through 2020 so restrict ft_other
ft_other <- ft_other %>%
  filter(year_comp < 2021)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_other$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_other[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_other$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- ft_other[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

### 1517 fuel treatments burned

write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/second_loop_3.csv")
```

##### FTI
```{r}
### subset
fti <- fts_mtbs_comp %>%
  filter(PURPOSE_CO == "FTI") 

### mtbs is only through 2020 so restrict fti
fti <- fti %>%
  filter(year_comp < 2021)

### fti overlap with mtbs
fti_mtbs <- st_intersection(mtbs, fti)

### restrict mtbs to these
mtbs_fti <- mtbs %>%
  filter(Event_ID %in% fti_mtbs$Event_ID)
rm(fti_mtbs)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(fti$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- fti[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_fti %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(fti$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- fti[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

### 1517 fuel treatments burned

write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/second_loop_4.csv")
```

##### FTI 2
```{r}
### r crashed part way through
check_csv <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/second_loop_4.csv")

### the last ft_id in the extraction was 464745

### make row names a column
fti <- fti %>%
  rownames_to_column()

### see which row 464745 is
fti_464745 <- fti %>%
  filter(ft_id == "464745") 
## rowname is 6449

### subset to fti's that are after this point
fti_2 <- fti %>%
  filter(rowname > 6449)

### fti overlap with mtbs
fti_mtbs <- st_intersection(mtbs, fti_2)

### restrict fti to these
mtbs_fti <- mtbs %>%
  filter(Event_ID %in% fti_mtbs$Event_ID)
rm(fti_mtbs)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(fti_2$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- fti_2[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_fti %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(fti_2$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- fti_2[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/second_loop_5.csv")
```

##### purpose code = NA
```{r}
### subset
pc_na <- fts_mtbs_comp %>%
  filter(is.na(PURPOSE_CO)) 

### mtbs is only through 2020 so restrict pc_na
pc_na <- pc_na %>%
  filter(year_comp < 2021)

### 21,030 rows - too many for a single loop!

### pc_na overlap with mtbs
pc_na_mtbs <- st_intersection(mtbs, pc_na)

### restrict mtbs to these
mtbs_na <- mtbs %>%
  filter(Event_ID %in% pc_na_mtbs$Event_ID)
rm(pc_na_mtbs)

table(pc_na$ACTIVITY)
```

##### purpose code = NA, ACTIVITY = Underburn - Low Intensity (Majority of Unit)
```{r}
### subset
pc_na_1 <- pc_na %>%
  filter(ACTIVITY == "Underburn - Low Intensity (Majority of Unit)") 

### pc_na overlap with mtbs
pc_na_1_mtbs <- st_intersection(mtbs, pc_na_1)

### restrict mtbs to these
mtbs_na_1 <- mtbs %>%
  filter(Event_ID %in% pc_na_1_mtbs$Event_ID)
rm(pc_na_1_mtbs)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(pc_na_1$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- pc_na_1[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_na_1 %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(pc_na_1$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- pc_na_1[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/second_loop_6.csv")
```
##### purpose code = NA, ACTIVITY = Burning of Piled Material)
```{r}
### subset
pc_na_2 <- pc_na %>%
  filter(ACTIVITY == "Burning of Piled Material") 

### pc_na overlap with mtbs
pc_na_2_mtbs <- st_intersection(mtbs, pc_na_2)

### restrict mtbs to these
mtbs_na_2 <- mtbs %>%
  filter(Event_ID %in% pc_na_2_mtbs$Event_ID)
rm(pc_na_2_mtbs)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(pc_na_2$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- pc_na_2[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_na_2 %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(pc_na_2$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- pc_na_2[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/second_loop_7.csv")
```

##### purpose code = NA, ACTIVITY = Thinning for Hazardous Fuels Reduction and Salvage Cut (intermediate treatment, not regeneration))
```{r}
### subset
pc_na_3 <- pc_na %>%
  filter(ACTIVITY %in% c("Thinning for Hazardous Fuels Reduction",
                         "Salvage Cut (intermediate treatment, not regeneration)")) 

### pc_na overlap with mtbs
pc_na_3_mtbs <- st_intersection(mtbs, pc_na_3)

### restrict mtbs to these
mtbs_na_3 <- mtbs %>%
  filter(Event_ID %in% pc_na_3_mtbs$Event_ID)
rm(pc_na_3_mtbs)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(pc_na_3$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- pc_na_3[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_na_3 %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(pc_na_3$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- pc_na_3[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/second_loop_8.csv")
```

##### purpose code = NA, ACTIVITY = Piling of Fuels, Hand or Machine
```{r}
### subset
pc_na_4 <- pc_na %>%
  filter(ACTIVITY == "Piling of Fuels, Hand or Machine") 

### pc_na overlap with mtbs
pc_na_4_mtbs <- st_intersection(mtbs, pc_na_4)

### restrict mtbs to these
mtbs_na_4 <- mtbs %>%
  filter(Event_ID %in% pc_na_4_mtbs$Event_ID)
rm(pc_na_4_mtbs)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(pc_na_4$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- pc_na_4[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_na_4 %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(pc_na_4$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- pc_na_4[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/second_loop_9.csv")
```

##### purpose code = NA, ACTIVITY = Pre-commercial and commercial thin
```{r}
### subset
pc_na_5 <- pc_na %>%
  filter(ACTIVITY %in% c("Commercial Thin",
                         "Precommercial Thin")) 

### pc_na overlap with mtbs
pc_na_5_mtbs <- st_intersection(mtbs, pc_na_5)

### restrict mtbs to these
mtbs_na_5 <- mtbs %>%
  filter(Event_ID %in% pc_na_5_mtbs$Event_ID)
rm(pc_na_5_mtbs)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(pc_na_5$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- pc_na_5[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_na_5 %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(pc_na_5$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- pc_na_5[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/second_loop_10.csv")
```

##### purpose code = NA, ACTIVITY = other
```{r}
### subset
pc_na_6 <- pc_na %>%
  filter(!ACTIVITY %in% c("Commercial Thin",
                         "Precommercial Thin",
                         "Piling of Fuels, Hand or Machine",
                         "Thinning for Hazardous Fuels Reduction",
                         "Salvage Cut (intermediate treatment, not regeneration)",
                         "Burning of Piled Material",
                         "Underburn - Low Intensity (Majority of Unit)")) 

### pc_na overlap with mtbs
pc_na_6_mtbs <- st_intersection(mtbs, pc_na_6)

### restrict mtbs to these
mtbs_na_6 <- mtbs %>%
  filter(Event_ID %in% pc_na_6_mtbs$Event_ID)
rm(pc_na_6_mtbs)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(pc_na_6$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- pc_na_6[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_na_6 %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(pc_na_6$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- pc_na_6[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/second_loop_11.csv")
```

###### loop dropped at some point
```{r}
### read in output from previous chunk
loop_drop <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/second_loop_11.csv")

### subset to what the previous chunk was working on, make rownames a column
pc_na_6 <- pc_na %>%
  filter(!ACTIVITY %in% c("Commercial Thin",
                         "Precommercial Thin",
                         "Piling of Fuels, Hand or Machine",
                         "Thinning for Hazardous Fuels Reduction",
                         "Salvage Cut (intermediate treatment, not regeneration)",
                         "Burning of Piled Material",
                         "Underburn - Low Intensity (Majority of Unit)")) %>%
  rownames_to_column()

### get last ft_id in loop_drop
tail(loop_drop$ft_id) ## 454628

### figure out row name for that ft_id
pc_na_6_last <- pc_na_6 %>%
  filter(ft_id == "454628") ## 5898

### subset pc_na_6 to the ft_id's that didn't come through
pc_na_6_remain <- pc_na_6 %>%
  filter(rowname > 5898)

### drop rowname column
pc_na_6_remain <- pc_na_6_remain %>%
  dplyr::select(-rowname)

### continue with loop
### pc_na overlap with mtbs
pc_na_6_remain_mtbs <- st_intersection(mtbs, pc_na_6_remain)

### restrict mtbs to these
mtbs_na_6 <- mtbs %>%
  filter(Event_ID %in% pc_na_6_remain_mtbs$Event_ID)
rm(pc_na_6_remain_mtbs)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(pc_na_6_remain$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- pc_na_6_remain[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_na_6 %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(pc_na_6_remain$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- pc_na_6_remain[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/second_loop_12.csv")
```

###### combine second round of loops
```{r}
### list files
loop_files <- list.files(path = "E:/usda_2023/usfs_fuel_treatments/western_us/",
                        pattern = "^second_loop_",
                        full.names = TRUE)

### open them
loop_files <- lapply(loop_files, read.csv)

### combine
loop_files <- do.call("rbind", loop_files)

### write out
write_csv(loop_files,
          "E:/usda_2023/usfs_fuel_treatments/western_us/remaining_burned_fts.csv")

### open original with full dataset
all_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fts_w_us.csv")

### combine
all_fts <- rbind(all_fts,
                 loop_files)

### write out
write_csv(all_fts,
          "E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fts_w_us_updated.csv")
```

### chemical and grazing treatments
```{r, warning = FALSE}
### Open fuel treatment database
ft <- st_read("E:/usda_2023/usfs_fuel_treatments/S_USA.Activity_HazFuelTrt_PL.shp") 

### add column for unique identifier
ft <- ft %>%
  mutate(ft_id = row_number())

### Filter out chemical and grazing
ft_ac <- ft %>%
  filter(METHOD %in% c("Animal",
                       "Chemical") |
           TREATMENT_ %in% c("Chemical",
                             "Grazing"))

### Subset to states of the western US (and adjacent states)
ft_ac <- ft_ac %>%
  filter(STATE_ABBR %in% c("AZ", "CA",
                           "CO", "ID",
                           "MT", "NM",
                           "NV", "OR",
                           "UT", "WA", "WY",
                           
                           ### adjacent states
                           "ND", "SD",
                           "NE", "KS", 
                           "OK", "TX"))
rm(ft)

### Reproject fuel treatments
ft_ac <- ft_ac %>%
  st_transform(crs = 6350)

### open western states boundaries
w_us <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/west_states.shp")

### subset ft to w_ud
ft_ac <- st_intersection(ft_ac, w_us)

### Take out treatments where completed date = NA
ft_ac <- ft_ac %>%
  drop_na(DATE_COMPL)

###########################
#### OVERLAP WITH WILDFIRES
###########################

### open fires that burned treatments
mtbs_all <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_west.shp")

### check for overlaps with wildfires
ft_ac_mtbs <- st_intersection(ft_ac,
                              mtbs_all)

### subset fts to those that spatially overlap with wildfires in the western us
ft_ac <- ft_ac %>%
  filter(ft_id %in% ft_ac_mtbs$ft_id)

### subset mtbs to those that spatially overlap with the FTs
mtbs_ac <- mtbs_all %>%
  filter(Event_ID %in% ft_ac_mtbs$Event_ID)
rm(mtbs_all)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_ac$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_ac[i, ]
  
  ### subset to fires that burned after
  mtbs_temp <- mtbs_ac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_ac$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
treat_burn <- ft_ac[1, ]
treat_burn <- treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(treat_burn) <- NULL

### drop cols
treat_burn <- treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
treat_burn <- treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    treat_burn <- rbind(treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
treat_burn <- treat_burn %>%
  filter(!ft_id == "empty")

write_csv(treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_grazing_chemical.csv")

#### add in the rest of the treatments!!!!!
all_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fts_w_us_updated.csv")

### combine
all_fts <- rbind(all_fts,
                 treat_burn)
write_csv(all_fts,
          "E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fts_w_us_updated.csv")

##### SHP
### subset ft_ac to burned 
ft_ac_burned <- ft_ac %>%
  filter(ft_id %in% treat_burn$ft_id)

### restrict columns
ft_ac_burned <- ft_ac_burned %>%
  dplyr::select(ft_id,
                STATE_ABBR,
                ACTIVITY_C,
                ACTIVITY,
                TREATMENT_,
                TREATMENT1,
                geometry)
st_write(ft_ac_burned,
         "E:/usda_2023/usfs_fuel_treatments/western_us/burned_fuel_treats_ac.shp")
```

## Burned treatment footprints (take 2)
Now redo the "Burned treatment footprints" chunk with the additional burned FTs
```{r}
### Open csv of all burned footprints
all_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fts_w_us_updated.csv") ## increases number of burned FTs from 5280 to 20371!!!!

### Open all MTBS fires
mtbs_all <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_west.shp")

### restrict to fires that subsequently burned fuel treatments
mtbs_all <- mtbs_all %>% 
  filter(Event_ID %in% all_fts$Event_ID)
st_write(mtbs_all,
          "E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_fuel_treats_updated.shp")

### Open fuel treatment database
ft <- st_read("E:/usda_2023/usfs_fuel_treatments/S_USA.Activity_HazFuelTrt_PL.shp") %>%
  mutate(., ft_id = row_number())

### restrict to fuel treatments that subsequently burned
ft_burned <- ft %>%
  filter(ft_id %in% all_fts$ft_id)

### are some of the fuel treatments in the burned dataset more than once?
length(unique(all_fts$ft_id))
### yes! 

### add sf to ft's
ft_burned_shp <- ft_burned %>%
  dplyr::select(ft_id,
                STATE_ABBR,
                ACTIVITY_C,
                ACTIVITY,
                TREATMENT_,
                TREATMENT1,
                geometry)
st_write(ft_burned_shp,
         "E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats_updated.shp")

### reproject
ft_burned_shp <- ft_burned_shp %>%
  st_transform(6350)

### add in chemical and animal footprints
burned_ac <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/burned_fuel_treats_ac.shp")

### combine
all_ft_burned <- rbind(ft_burned_shp,
                       burned_ac)

### write this out
st_write(all_ft_burned,
         "E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats_updated.shp")

### this gives the entire fuel treatment footprint, including parts that did not burn

### Make table of activity counts by state
ft_burned_csv <- ft_burned_shp 
st_geometry(ft_burned_csv) <- NULL
ft_burned_summ <- ft_burned_csv %>%
  group_by(STATE_ABBR,
           ACTIVITY) %>%
  summarise(treatment_count = length(unique(ft_id)))
write_csv(ft_burned_csv,
          "E:/usda_2023/usfs_fuel_treatments/western_us/ft_summary.csv")

### limit to CA and CO
ca_co_summ <- ft_burned_summ %>%
  filter(STATE_ABBR %in% c("CO", "CA"))
write_csv(ca_co_summ,
          "E:/usda_2023/usfs_fuel_treatments/western_us/ft_summary_ca_co.csv")
```

## UPDATE update_mtbs.Rmd FROM HERE
### Burned footprints subset to fire perimeter
```{r, warning = FALSE}
### Open csv of all burned footprints
all_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fts_w_us_updated.csv") %>%
  distinct()

### Open all MTBS fires that subsequently burned fuel treatments
mtbs_all <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_fuel_treats_updated.shp")

### Open fuel treatment database
ft <- st_read("E:/usda_2023/usfs_fuel_treatments/S_USA.Activity_HazFuelTrt_PL.shp") %>%
  mutate(., ft_id = row_number())

### restrict to fuel treatments that subsequently burned
ft <- ft %>%
  filter(ft_id %in% all_fts$ft_id)

### add sf to ft's
ft <- ft %>%
  dplyr::select(ft_id,
                STATE_ABBR,
                ACTIVITY_C,
                ACTIVITY,
                TREATMENT_,
                TREATMENT1,
                geometry)

### make valid
ft <- st_make_valid(ft)

### add in info from all_fts
all_fts <- merge(x = ft,
                 y = all_fts,
                 by = "ft_id",
                 all.y = TRUE)
### this gives the entire fuel treatment footprint, including parts that did not burn

# ### ft_id's that appear more than once
# ft_dup <- all_fts
# st_geometry(ft_dup) <- NULL
# ft_dup <- ft_dup %>%
#   group_by(ft_id) %>%
#   summarise(n_rows = n()) %>%
#   filter(n_rows > 1)
# ft_dup <- all_fts %>%
#   filter(ft_id %in% ft_dup$ft_id)
# ### these duplicates burned in more than one fire
# rm(ft_dup)

### I just want the geometry of the part that burned in the wildfire (not the whole fuel treatment footprint)

### convert geom
all_fts <- all_fts %>%
  st_transform(6350)

### simplify mtbs
mtbs_all <- mtbs_all %>%
  dplyr::select(Event_ID, geometry)

### get dummy df
temp_ft_dummy <- all_fts[4, ]
temp_mtbs_dummy <- mtbs_all %>%
  filter(Event_ID %in% temp_ft_dummy$Event_ID)
ft_intersect_dummy <- st_intersection(temp_ft_dummy,
                                temp_mtbs_dummy)
ft_intersect_dummy <- ft_intersect_dummy %>%
  dplyr::select(-Event_ID.1)
ft_intersect_dummy$STATE_ABBR[ft_intersect_dummy$STATE_ABBR == "ID"] <- "dummy_row"

### get the overlapping geometry
# for (i in 1:nrow(all_fts)) {
for (i in 7136:nrow(all_fts)) {
# for (i in 1:10) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### subset to that row
  temp_ft <- all_fts[i, ]
  
  ### make valid
  temp_ft <- st_make_valid(temp_ft)
  
  ### subset to fire
  temp_mtbs <- mtbs_all %>%
    filter(Event_ID %in% temp_ft$Event_ID)
  
  ### intersect geom
  ft_intersect <- st_intersection(temp_ft,
                                  temp_mtbs)
  
  ### drop extra col
  ft_intersect <- ft_intersect %>%
    dplyr::select(-Event_ID.1)
  
  ### add it to the df
  ft_intersect_dummy <- rbind(ft_intersect_dummy,
                              ft_intersect)
  ### there can be multiple polygons for each intersection
}

### it ran just fine until i = 7136
#### error: TopologyException: Input geom 0 is invalid: Self-intersection at -857814.68257419334 1951649.566126128

### write out
st_write(ft_intersect_dummy,
         "E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fts_polygons.shp")
```

## Wildfires for CBI
```{r}
### open mtbs in western us
mtbs_burned <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_fuel_treats_updated.shp")
### these shapefiles have splits at state boundaries, but I want the complete MTBS perimeters (one polygon per fire)

### open the original fire perimeters
mtbs <- st_read("E:/fire_sev_rdd/mtbs/mtbs_perims_DD.shp") %>%
  st_transform(crs = 6350)

### subset mtbs to fires in fts
mtbs <- mtbs %>%
  filter(Event_ID %in% mtbs_burned$Event_ID)

### combine columns 

### prep mtbs_burned for merge
st_geometry(mtbs_burned) <- NULL
mtbs_burned <- mtbs_burned %>%
  distinct()

### prep mtbs for merge
mtbs <- mtbs %>%
  dplyr::select(Event_ID, Incid_Type)

### merge
mtbs <- merge(mtbs,
              mtbs_burned,
              by = c("Event_ID", "Incid_Type"))

### export fire perimeters for CBI analysis
# - Fire_ID
# - Fire_Year
# - Start_Day (start day of fire season in Julian days)
# - End_Day (end day of fire season in Julian days)

### extract state as column
mtbs <- mtbs %>%
  mutate(state = stringr::str_extract(Event_ID, "^.{2}"))

### Fire seasons
#### In Parks et al. 2019, they use the following seasons:
#### AZ and NM: April 1-June 30 (julian 91-181)
#### CA, ID, MT, OR, UT, WA, WY: June 1-Sept 15 (julian 152-258)
#### assume it's the same for CO, NV
#### use these
# other_julian <- c("CA", "CO", "ID",
#                   "MT", "NV", "OR",
#                   "SD", "TX",
#                   "UT", "WA", "WY")

### use julian fire season dates for CA, ID, MT, OR, UT, WA, WY

### assign julian start and end date based on state dates from Parks et al. 2019
mtbs <- mtbs %>%
  mutate(Start_Day = ifelse(state %in% c("AZ", "NM"), 91, 152),
         End_Day = ifelse(state %in% c("AZ", "NM"), 181, 258))

### Select columns for GEE
### export fire perimeters for CBI analysis
# - Fire_ID
# - Fire_Year
# - Start_Day (start day of fire season in Julian days)
# - End_Day (end day of fire season in Julian days)
mtbs <- mtbs %>%
  dplyr::select(Fire_ID = Event_ID,
                Fire_Year = year,
                Start_Day,
                End_Day,
                Incid_Type,
                geometry)

### Make sure date columns don't get read in with decimals
mtbs$Fire_Year <- as.character(mtbs$Fire_Year, 0)
mtbs$Start_Day <- as.character(mtbs$Start_Day, 0)
mtbs$End_Day <- as.character(mtbs$End_Day, 0)

### Write out shp for gee
st_write(mtbs,
         "E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_gee.shp")
```

#### some of the fires didn't run in GEE
```{r}
### folder url
folder_mtbs_url <- "https://drive.google.com/drive/u/3/folders/1hPYTx_mENifIuoZQXHqWQ0lfeVk7AVIb"

### identify the folder
folder_mtbs <- drive_get(as_id(folder_mtbs_url))

### identify the rasters in that folder
drive_mtbs <- drive_ls(folder_mtbs)

### figure out which fires ran

### make df
mtbs_ran <- as.data.frame(drive_mtbs[, c(1:2)])

### split fire name strings
mtbs_ran$name <- gsub('_CBI_bc.tif', '', mtbs_ran$name)

### which fires are missing?
mtbs_missing <- mtbs %>%
  filter(!Fire_ID %in% mtbs_ran$name)

### write these out for GEE
st_write(mtbs_missing,
         "E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_gee_2.shp")

```

### download CBI from google drive -- they've all run now
```{r}
### folder url
folder_mtbs_url <- "https://drive.google.com/drive/u/3/folders/1hPYTx_mENifIuoZQXHqWQ0lfeVk7AVIb"

### identify the folder
folder_mtbs <- drive_get(as_id(folder_mtbs_url))

### identify the rasters in that folder
drive_mtbs <- drive_ls(folder_mtbs)

### set download path
mtbs_path <- "E:/fire_sev_rdd/cbi_gee/cbi_gee_mtbs/"

### run through files to download
for (i in seq_along(drive_mtbs$name)) {
  drive_download(
    as_id(drive_mtbs$id[[i]]),
    path = file.path(mtbs_path, drive_mtbs$name[[i]]),
    overwrite = TRUE
  )
}
```
## FiredPy
```{r}
### open western US firedpy events
firedpy <- st_read("E:/fired_py_data/fired_west_events.shp")

### drop fire perimeters that are definitely not in forests
firedpy <- firedpy %>%
  filter(!lc_name %in% c("Grasslands", "Barren", "Croplands",
                         "Permanent Wetlands", "Water Bodies",
                         "Urban and Built-up Lands", "Permanent Snow and Ice"))

### transform
firedpy <- firedpy %>%
  st_transform(6350)

### drop fires that are big enough to be included in MTBS (1000 acres or more)
### in firedpy data, tot_ar_km2 = total area burned over course of fire (km2)
firedpy <- firedpy %>%
  mutate(tot_ar_acre = tot_ar_km2 * 247.105) %>%
  filter(tot_ar_acre < 1000)
```

### spatial divisions
```{r}
### Open northern boundaries
n_bound <- raster::getData(name = "GADM",
                            country = 'USA',
                            level = 1) %>%
  st_as_sf() %>%
  filter(NAME_1 %in% c("Idaho", "Montana", 
                       "Nevada", "Wyoming")) %>%
  st_transform(6350)

### Open pacific boundaries
p_bound <- raster::getData(name = "GADM",
                            country = 'USA',
                            level = 1) %>%
  st_as_sf() %>%
  filter(NAME_1 %in% c("California", "Oregon", 
                      "Washington")) %>%
  st_transform(6350)

### Open sw boundaries
s_bound <- raster::getData(name = "GADM",
                            country = 'USA',
                            level = 1) %>%
  st_as_sf() %>%
  filter(NAME_1 %in% c("Arizona", "Utah", 
                      "Colorado", "New Mexico")) %>%
  st_transform(6350)

### subset firedpy polygons

### northern
firedpy_north <- st_intersection(firedpy, n_bound)
st_write(firedpy_north,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_north.shp")
rm(firedpy_north, n_bound)

### southwest
firedpy_sw <- st_intersection(firedpy, s_bound)
st_write(firedpy_sw,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_sw.shp")
rm(firedpy_sw, s_bound)

### pacific
firedpy_p <- st_intersection(firedpy, p_bound)
st_write(firedpy_p,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_pac.shp")
rm(firedpy_p, p_bound)
```

### figure out which firedpy polygons are actually just rx fires!
#### northern
```{r}
### open firedpy for north
firedpy_north <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_north.shp")

### open northern ft shp
ft_north <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/northern_treatments_all.shp") 
  
### filter to rx fires
ft_north <- ft_north %>%
  filter(ACTIVITY %in% c("Underburn - Low Intensity (Majority of Unit)",
                         "Broadcast Burning - Covers a majority of the unit",
                         "Site Preparation for Planting - Burning",
                         "Control of Understory Vegetation- Burning",
                         "Burning of Piled Material",
                         "Jackpot Burning - Scattered concentrations",
                         "Wildlife Habitat Prescribed fire",
                         "Site Preparation for Natural Regeneration - Burning"))

### have any of these overlapped with firedpy perimeters?
ft_north_firedpy <- st_intersection(firedpy_north, ft_north) 

### add year column for ft
ft_north_firedpy <- ft_north_firedpy %>%
  mutate(ft_year = year(DATE_COMPL))

### subset to overlaps in the same year
ft_north_firedpy <- ft_north_firedpy %>%
  filter(ft_year == ig_year)

### 233 instances where there was a firedpy detection that overlapped with a fuel treatment in the same year

### drop these from the firedpy dataset
firedpy_north <- firedpy_north %>%
  filter(!id %in% ft_north_firedpy$id)

### write out
st_write(firedpy_north,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_north_norx.shp")
```

#### southwestern
```{r}
### open firedpy for sw
firedpy_sw <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_sw.shp")

### open northern ft shp
ft_sw <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/sw_treatments_all.shp") 
  
### filter to rx fires
ft_sw <- ft_sw %>%
  filter(ACTIVITY %in% c("Underburn - Low Intensity (Majority of Unit)",
                         "Broadcast Burning - Covers a majority of the unit",
                         "Site Preparation for Planting - Burning",
                         "Control of Understory Vegetation- Burning",
                         "Burning of Piled Material",
                         "Jackpot Burning - Scattered concentrations",
                         "Wildlife Habitat Prescribed fire",
                         "Site Preparation for Natural Regeneration - Burning",
                         "Natural regeneration - prescribed fire"))

### have any of these overlapped with firedpy perimeters?
ft_sw_firedpy <- st_intersection(firedpy_sw, ft_sw) 

### add year column for ft
ft_sw_firedpy <- ft_sw_firedpy %>%
  mutate(ft_year = year(DATE_COMPL)) %>%
  
  ### subset to overlaps in the same year
  filter(ft_year == ig_year)

### 175 instances where there was a firedpy detection that overlapped with a fuel treatment in the same year

### drop these from the firedpy dataset
firedpy_sw <- firedpy_sw %>%
  filter(!id %in% ft_sw_firedpy$id)

### write out
st_write(firedpy_sw,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_sw_norx.shp")
```

#### pacific
```{r}
### open firedpy for pac
firedpy_pac <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_pac.shp")

### open northern ft shp
ft_pac <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_treatments_all.shp") 
  
### filter to rx fires
ft_pac <- ft_pac %>%
  filter(ACTIVITY %in% c("Underburn - Low Intensity (Majority of Unit)",
                         "Broadcast Burning - Covers a majority of the unit",
                         "Site Preparation for Planting - Burning",
                         "Control of Understory Vegetation- Burning",
                         "Burning of Piled Material",
                         "Jackpot Burning - Scattered concentrations",
                         "Wildlife Habitat Prescribed fire",
                         "Site Preparation for Natural Regeneration - Burning",
                         "Natural regeneration - prescribed fire",
                         "Invasives - Cultural /Fire"))

### have any of these overlapped with firedpy perimeters?
ft_pac_firedpy <- st_intersection(firedpy_pac, ft_pac) 

### add year column for ft
ft_pac_firedpy <- ft_pac_firedpy %>%
  mutate(ft_year = year(DATE_COMPL)) %>%
  
  ### subset to overlaps in the same year
  filter(ft_year == ig_year)

### 297 instances where there was a firedpy detection that overlapped with a fuel treatment in the same year

### drop these from the firedpy dataset
firedpy_pac <- firedpy_pac %>%
  filter(!id %in% ft_pac_firedpy$id)

### write out
st_write(firedpy_pac,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_pac_norx.shp")
```

### overlap firedpy with treatments
after removing rx fires from firedpy dataset
#### ft_adj
```{r}
# ### open first ft shp
# ft_adj <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/adj_treatments_all.shp") 
#   
# ### have any of these overlapped with firedpy perimeters?
# ft_adj_firedpy <- st_intersection(firedpy, ft_adj) 
# ### no overlaps
# rm(ft_adj, ft_adj_firedpy)
```

#### ft_northern
```{r, warning = FALSE}
### open northern ft shp
ft_north <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/northern_treatments_all.shp") 
  
### filter to out wildfires
ft_north <- ft_north %>%
  filter(!ACTIVITY %in% c("Wildland Fire Use",
                          "Wildfire - Human Ignition",
                          "Wildfire - Natural Ignition",
                          "Wildfire - Fuels Benefit"))

### open non-rx firedpy
firedpy_n <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_north_norx.shp")

### quick overlap
firedpy_ov <- st_intersection(ft_north,
                              firedpy_n)

### restrict data sets for speed
ft_north <- ft_north %>%
  filter(ft_id %in% firedpy_ov$ft_id)
firedpy_n <- firedpy_n %>%
  filter(id %in% firedpy_ov$id)

#### time to loop!
### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_north$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_north[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- firedpy_n %>%
    filter(ig_date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_north$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- ft_north[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = NA,
         id = NA, 
         ig_date = NA,
         ig_day = NA, ig_mnth = NA, ig_year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  id, ig_date,
                  ig_day, ig_mnth, ig_year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_ft_burned_north.csv")
```

#### sw
```{r, warning = FALSE}
### open northern ft shp
ft_sw <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/sw_treatments_all.shp") 
  
### filter to out wildfires
ft_sw <- ft_sw %>%
  filter(!ACTIVITY %in% c("Wildland Fire Use",
                          "Wildfire - Human Ignition",
                          "Wildfire - Natural Ignition",
                          "Wildfire - Fuels Benefit",
                          "Planned Treatment Burned in Wildfire"))

### open non-rx firedpy
firedpy_sw <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_sw_norx.shp")

### quick overlap
firedpy_ov <- st_intersection(ft_sw,
                              firedpy_sw)

### restrict data sets for speed
ft_sw <- ft_sw %>%
  filter(ft_id %in% firedpy_ov$ft_id)
firedpy_sw <- firedpy_sw %>%
  filter(id %in% firedpy_ov$id)

#### time to loop!
### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- firedpy_sw %>%
    filter(ig_date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- ft_sw[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = NA,
         id = NA, 
         ig_date = NA,
         ig_day = NA, ig_mnth = NA, ig_year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  id, ig_date,
                  ig_day, ig_mnth, ig_year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_ft_burned_sw.csv")
```

#### pac
```{r, warning = FALSE}
### open northern ft shp
ft_pac <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_treatments_all.shp") 
  
### filter to out wildfires
ft_pac <- ft_pac %>%
  filter(!ACTIVITY %in% c("Wildland Fire Use",
                          "Wildfire - Human Ignition",
                          "Wildfire - Natural Ignition",
                          "Wildfire - Fuels Benefit",
                          "Planned Treatment Burned in Wildfire"))

### open non-rx firedpy
firedpy_pac <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_pac_norx.shp")

### quick overlap
firedpy_ov <- st_intersection(ft_pac,
                              firedpy_pac)

### restrict data sets for speed
ft_pac <- ft_pac %>%
  filter(ft_id %in% firedpy_ov$ft_id)
firedpy_pac <- firedpy_pac %>%
  filter(id %in% firedpy_ov$id)

#### time to loop!
### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- firedpy_pac %>%
    filter(ig_date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- ft_pac[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = NA,
         id = NA, 
         ig_date = NA,
         ig_day = NA, ig_mnth = NA, ig_year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  id, ig_date,
                  ig_day, ig_mnth, ig_year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_ft_burned_pac.csv")
```

### combine firedpy regions
"Burned treatment footprints" chunk for FTs that burned in firedpy
```{r}
### open firedpy regional csvs
n_fp <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_ft_burned_north.csv")
p_fp <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_ft_burned_pac.csv")
sw_fp <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_ft_burned_sw.csv")

### combine
fp_all <- rbind(n_fp, sw_fp, p_fp)
rm(n_fp, p_fp, sw_fp)

########################################################
### how many of these FTs also burned in MTBS perimeters?
########################################################

### open mtbs FTs
mtbs_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fts_w_us_updated.csv") %>%
  
  ### fix ignition date
  mutate(Ig_Date = make_date(year, month, date))

### check for overlaps
fp_mtbs <- fp_all %>%
  filter(ft_id %in% mtbs_fts$ft_id)
length(unique(fp_mtbs$ft_id))
### 1554 fts burned in firedpy and mtbs dataset

### were these in different years?
fp_mtbs <- merge(x = fp_mtbs,
                 y = mtbs_fts,
                 by = "ft_id",
                 all.x = TRUE)

### remove firedpy in 2021
fp_mtbs <- fp_mtbs %>%
  filter(ig_date < 2021)

### if the ignition date is exactly the same, these are the same fire
fp_mtbs_drop <- fp_mtbs %>%
  filter(ig_date == Ig_Date)

### sometimes these are the same month and year -- probably the same fire

### calculate number of days between ignition dates
fp_mtbs <- fp_mtbs %>%
  mutate(interval_ig = abs(round(as.numeric(difftime(ig_date,
                                  Ig_Date, units = "days")))))

### landsat overpass is 16 days. if ignition intervals are within a month, assume they are the same fire
fp_mtbs_drop_2 <- fp_mtbs %>%
  filter(interval_ig < 31)

### same year?
fp_mtbs <- fp_mtbs %>%
  mutate(same_yr = ifelse(ig_year == year, 1, 0))

### subset firedpy and mtbs shps to these
firedpy <- st_read("E:/fired_py_data/fired_west_events.shp") %>%
  filter(., id %in% fp_mtbs$id) %>%
  st_transform(., 6350)
mtbs_all <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_west.shp") %>%
  filter(., Event_ID %in% fp_mtbs$Event_ID)

# ### get spatial overlap
# overlap_fm <- st_intersection(firedpy, mtbs_all)
# 
# ### time between these
# overlap_fm <- overlap_fm %>%
#   mutate(interval_ig = abs(round(as.numeric(difftime(ig_date,
#                                                      Ig_Date, 
#                                                      units = "days")))))
# 
# ### drop if spatially overlap and ignition interval < one month
# overlap_fm <- overlap_fm %>%
#   filter(interval_ig > 31)

### keep firedpy fuel treatments from fp_mtbs where interval > 30 days 
fp_keep <- fp_all %>%
  
  ### drop the ones where the ignition dates are the same
  filter(!ft_id %in% fp_mtbs_drop$ft_id) %>%
  
  ### drop ignition dates within a month of each other
  filter(!ft_id %in% fp_mtbs_drop_2$ft_id)

### write out complete csv
write_csv(fp_keep,
          "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_ft_burned_all.csv")
  
### Open fuel treatment database
ft <- st_read("E:/usda_2023/usfs_fuel_treatments/S_USA.Activity_HazFuelTrt_PL.shp") %>%
  mutate(., ft_id = row_number())

### restrict to fuel treatments that subsequently burned in firedpy
ft <- ft %>%
  filter(ft_id %in% fp_keep$ft_id)

### are some of the fuel treatments in the burned dataset more than once?
length(unique(ft$ft_id))
### no

### add sf to ft's
ft_burned_shp <- ft %>%
  dplyr::select(ft_id,
                STATE_ABBR,
                ACTIVITY_C,
                ACTIVITY,
                TREATMENT_,
                TREATMENT1,
                geometry)
st_write(ft_burned_shp,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_fuel_treats_burned.shp")

### reproject
ft_burned_shp <- ft_burned_shp %>%
  st_transform(6350)

### open the mtbs burned fuel treatments
mtbs_ft_burned <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats_updated.shp")

### combing
all_fts_burned <- rbind(mtbs_ft_burned,
                        ft_burned_shp)

### write this out
st_write(all_fts_burned,
         "E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats_mtbs_firedpy.shp")

### this gives the entire fuel treatment footprint, including parts that did not burn
```

### firedpy cbi
```{r}
### restrict to fires i care about
firedpy_keep <- firedpy %>%
  filter(id %in% fp_keep$id)

### export fire perimeters for CBI analysis
# - Fire_ID
# - Fire_Year
# - Start_Day (start day of fire season in Julian days)
# - End_Day (end day of fire season in Julian days)

### need to get the states for each firedpy polygon
w_bound <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/west_states.shp")

### overlap to get states
firedpy_keep <- st_intersection(firedpy_keep,
                                w_bound)

### Fire seasons
#### In Parks et al. 2019, they use the following seasons:
#### AZ and NM: April 1-June 30 (julian 91-181)
#### CA, ID, MT, OR, UT, WA, WY: June 1-Sept 15 (julian 152-258)
#### assume it's the same for CO, NV
#### use these
# other_julian <- c("CA", "CO", "ID",
#                   "MT", "NV", "OR",
#                   "SD", "TX",
#                   "UT", "WA", "WY")

### use julian fire season dates for CA, ID, MT, OR, UT, WA, WY

### assign julian start and end date based on state dates from Parks et al. 2019
firedpy_keep <- firedpy_keep %>%
  mutate(Start_Day = ifelse(NAME_1 %in% c("Arizona", 
                                          "New Mexico"), 
                            91, 152),
         End_Day = ifelse(NAME_1 %in% c("Arizona", 
                                        "New Mexico"), 
                          181, 258))

### Select columns for GEE
### export fire perimeters for CBI analysis
# - Fire_ID
# - Fire_Year
# - Start_Day (start day of fire season in Julian days)
# - End_Day (end day of fire season in Julian days)
firedpy_keep <- firedpy_keep %>%
  dplyr::select(Fire_ID = id,
                Fire_Year = ig_year,
                Start_Day,
                End_Day,
                geometry)

### Make sure date columns don't get read in with decimals
firedpy_keep$Fire_Year <- as.character(firedpy_keep$Fire_Year, 0)
firedpy_keep$Start_Day <- as.character(firedpy_keep$Start_Day, 0)
firedpy_keep$End_Day <- as.character(firedpy_keep$End_Day, 0)
```

### Are some of these fires completely contained by MTBS perimeters?
```{r, warning = FALSE}
### open shp of burned FTs
burned_ft <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats_year_updated_polygons.shp")

### open csv for firedpy
fp <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_ft_burned_all.csv")

### open csv for mtbs
mtbs_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fts_w_us_updated.csv") %>%
  
  ### fix ignition date
  mutate(Ig_Date = make_date(year, month, date))

### rename cols for both csvs
fp <- fp %>%
  dplyr::select(ft_id, 
                firedpy_id = id,
                firedpy_ig_date = ig_date,
                firedpy_ig_day = ig_day,
                firedpy_ig_month = ig_mnth,
                firedpy_ig_year = ig_year)
mtbs_fts <- mtbs_fts %>%
  dplyr::select(ft_id, 
                mtbs_id = Event_ID,
                mtbs_ig_date = Ig_Date,
                mtbs_ig_day = date,
                mtbs_ig_month = month,
                mtbs_ig_year = year)

### merge in data
burned_mtbs <- merge(x = burned_ft,
                     y = mtbs_fts,
                     by = "ft_id",
                     all.x = TRUE)
burned_m_p <- merge(x = burned_mtbs,
                    y = fp,
                    by = "ft_id",
                    all.x = TRUE) 

### drop geom
burned_mp <- burned_m_p
st_geometry(burned_mp) <- NULL
burned_mp <- burned_mp %>%
  distinct()

### subset to ft's that burned in both in the same year
burned_mp <- burned_mp %>%
  filter(!is.na(mtbs_id)) %>%
  filter(!is.na(firedpy_id)) %>%
  filter(mtbs_ig_year == firedpy_ig_year)

### add unique rowname
burned_mp <- burned_mp %>%
  mutate(uid = row_number())

### split mtbs and firedpy
b_m <- burned_mp %>%
  dplyr::select(uid, mtbs_id)
b_f <- burned_mp %>%
  dplyr::select(uid, firedpy_id)

### open fire perimeters
firedpy <- st_read("E:/fired_py_data/fired_west_events.shp") %>%
  filter(id %in% b_f$firedpy_id) %>%
  st_transform(., 6350)
mtbs <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_gee.shp") %>%
  filter(Fire_ID %in% b_m$mtbs_id)

### add geom to the dfs
b_m <- merge(y = b_m, 
             x = mtbs,
             by.y = "mtbs_id",
             by.x = "Fire_ID",
             all.y = TRUE)
b_f <- merge(y = b_f, 
             x = firedpy,
             by.y = "firedpy_id",
             by.x = "id",
             all.y = TRUE)

### make df to fill
uid <- NA
mtbs_id <- NA
firedpy_id <- NA
complete_over <- NA
store_comp_overlap <- as.data.frame(cbind(uid, mtbs_id, 
                                          firedpy_id, complete_over))

### loop through and figure out if any of the firedpy are completely within the mtbs perimeters
for (i in 1:nrow(b_f)) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### identify firedpy row
  fp_poly <- b_f[i, ]
  
  ### get mtbs row
  mtbs_poly <- b_m %>%
    filter(uid %in% fp_poly$uid)
  
  ### make cols
  uid <- fp_poly$uid
  mtbs_id <- mtbs_poly$Fire_ID
  firedpy_id <- fp_poly$id
  
  ### make col for overlap
  complete_over <- as.numeric(unlist(st_covered_by(fp_poly,
                                                   mtbs_poly)))
  # complete_unlist <- unlist(complete_over)
  
  if(length(complete_over) > 0) {
  
  ### make df
  df_i <- as.data.frame(cbind(uid, mtbs_id, 
                              firedpy_id, complete_over))
  
  ### store output
  store_comp_overlap <- rbind(store_comp_overlap,
                              df_i)
  }}

### drop empty row
store_comp_overlap <- store_comp_overlap %>%
  filter(!is.na(uid))

### remove these firedpy id's from the cbi dataset
firedpy_keep_keep <- firedpy_keep %>%
  filter(!Fire_ID %in% store_comp_overlap$firedpy_id)

### Write out shp for gee
st_write(firedpy_keep_keep,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_gee.shp")
```
## run firedpy through GEE CBI after mtbs finishes running 

### FROM HERE -- ADDED FIREDPY

## Overlapping treatments
```{r}
### open shp of fuel treatments that subsequently burned
# burned_ft <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats_updated.shp")
# burned_ft <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fts_polygons.shp")
### to include firedpy:
burned_ft <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats_mtbs_firedpy.shp")

### Some of these treatment records are different activities that took place at the same location at the same time (ex. thinning and biomass removal)

### geometry valid
burned_ft <- st_make_valid(burned_ft)

### Open full fuel treatment database
ft <- st_read("E:/usda_2023/usfs_fuel_treatments/S_USA.Activity_HazFuelTrt_PL.shp") %>%
  mutate(., 
         ft_id = row_number()) %>%
  filter(.,
         ft_id %in% burned_ft$ft_id)

### plot one treatment and the overlap
check_ft <- ft %>% filter(ft_id == "8629")
check_burned <- burned_ft %>% filter(ft_id == "8629")
ggplot() +
  geom_sf(data = check_ft, color = "red", fill = NA) +
  geom_sf(data = check_burned, color = "blue", fill = NA) +
  NULL
### they overlap completely
st_geometry(check_ft)==st_geometry(check_burned)
## FALSE -- but why????

### get completion date and state
ft_date <- ft %>%
  dplyr::select(ft_id,
                STATE_ABBR,
                DATE_COMPL,
                geometry)
st_geometry(ft_date) <- NULL

### separate out date components
ft_date <- ft_date %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL))

### merge in
burned_ft <- merge(x = burned_ft,
                   y = ft_date,
                   by = c("ft_id",
                          "STATE_ABBR"),
                   all.x = TRUE)

### write out
# st_write(burned_ft,
#          "E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats_year.shp")
# st_write(burned_ft,
#          "E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats_year_updated.shp")
st_write(burned_ft,
         "E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats_year_updated_polygons.shp")
```

## STOP HERE!!!!!! NO MORE ON THIS RMD.

### quick stab at overlaps
```{r}
# ### make version of this with just the geometry
# ft_shp <- burned_ft %>%
#   dplyr::select(geometry) %>%
#   distinct()
# 
# ### give it a column for a uid for the footprint
# ft_shp <- ft_shp %>%
#   mutate(fpt_id = row_number())
# 
# ### make geom character strings
# ft_shp <- ft_shp %>%
#   mutate(geom_char = as.character(geometry))
# burned_ft <- burned_ft %>%
#   mutate(geom_char = as.character(geometry))
# 
# ### make ft_shp a df
# st_geometry(ft_shp) <- NULL
# 
# ### merge with burned_ft
# overlap_ft <- merge(x = burned_ft,
#                     y = ft_shp,
#                     by = "geom_char",
#                     all = TRUE)
# 
# ### remove geom_char col
# overlap_ft <- overlap_ft %>%
#   dplyr::select(-geom_char)
# 
# ### overlap as a df
# overlap_df <- overlap_ft
# st_geometry(overlap_df) <- NULL
# 
# ### which footprints have multiple methods?
# overlap_summ <- overlap_df %>%
#   group_by(fpt_id) %>%
#   summarise(list_treatments = list(ACTIVITY))
# 
# ### what've we got here?
# unique(overlap_summ$list_treatments)
```

### include incomplete overlaps
Too big to run on all states at the same time

```{r}
table(burned_ft$STATE_ABBR)
```
       AZ        CA        CO dummy_row        ID        MT        NM 
      950      9275      1049         1       737       602       235 
       NV        OR        UT        WA        WY 
       29      5194       176      1180       574

#### test with nevada
```{r, warning=FALSE}
### for each footprint, I want to know if another footprint overlaps it
### so the output I want is a df with a column for ft_id 1, ft_id 2, and true/false whether they overlap

### subset to NV
test_neva <- burned_ft %>%
  filter(STATE_ABBR == "NV")

### make two sf dfs for dummy df
nv_1 <- burned_ft %>%
  filter(ft_id == "87244")
nv_2 <- burned_ft %>%
  filter(ft_id == "421221")

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2)

### change columns for dummy df
ft_fill <- ft_fill %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

# i <- 1
### make loop
for (i in 1:nrow(test_neva)) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- test_neva[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- test_neva %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in 2:(nrow(test_state)-1)) {
    
    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)
    
    if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      # ### store intersections as a list
      # store_overlaps[j] <- temp_overlap
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
    
  }
  
}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### make valid
ft_fill <- st_make_valid(ft_fill)

# ### add area
# ft_fill$area_overlap <- as.numeric(sf::st_area(ft_fill))

# ### remove problem geoms
# ft_fill <- ft_fill %>%
#   filter(area_overlap > 905)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "E:/usda_2023/usfs_fuel_treatments/western_us/fuel_treat_overlaps_neva_updated2.shp")
```

#### utah
```{r, warning=FALSE}
### subset to UT
utah <- burned_ft %>%
  filter(STATE_ABBR == "UT")

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
for (i in 1:nrow(utah)) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- utah[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- utah %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in 2:(nrow(test_state)-1)) {
    
    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)
    
    if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }
  
}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### add area
ft_fill$area_overlap <- as.numeric(sf::st_area(ft_fill))

### remove tiny geoms
ft_fill <- ft_fill %>%
  filter(area_overlap > 0)
ft_fill$area_overlap <- NULL

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

### write out
st_write(ft_fill_split,
         "E:/usda_2023/usfs_fuel_treatments/western_us/fuel_treat_overlaps_utah_updated.shp")

rm(utah, ft_fill_split)
```

#### new mexico
```{r, warning=FALSE}
### subset to NM
nmex <- burned_ft %>%
  filter(STATE_ABBR == "NM")

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
for (i in 1:nrow(nmex)) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- nmex[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- nmex %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in 2:(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

    if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "E:/usda_2023/usfs_fuel_treatments/western_us/fuel_treat_overlaps_nmex_updated.shp")

rm(nmex, ft_fill_split)
```

### still need to re-run these states!
#### WY
```{r, warning=FALSE}
### subset to WY
wyom <- burned_ft %>%
  filter(STATE_ABBR == "WY")
rm(burned_ft)
gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
for (i in 1:nrow(wyom)) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- wyom[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- wyom %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in 2:(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "E:/usda_2023/usfs_fuel_treatments/western_us/fuel_treat_overlaps_wyom_updated.shp")

rm(wyom)
```

#### montana
```{r, warning=FALSE}
# burned_ft <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats_year_updated_polygons.shp")

### subset to MT
mont <- burned_ft %>%
  filter(STATE_ABBR == "MT")

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
i <- 1
for (i in 1:nrow(mont)) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- mont[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- mont %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in 2:(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

    if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "E:/usda_2023/usfs_fuel_treatments/western_us/fuel_treat_overlaps_mont_updated.shp")
rm(mont)
```

#### idaho
```{r, warning = FALSE}
### subset to ID
idah <- burned_ft %>%
  filter(STATE_ABBR == "ID")

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
i <- 1
for (i in 1:nrow(idah)) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- idah[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- idah %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in 2:(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

    if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_idah.shp")

rm(idah)
```

#### washington
```{r, warning=FALSE}
### subset to WA
wash <- burned_ft %>%
  filter(STATE_ABBR == "WA")

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
for (i in 1:nrow(wash)) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- wash[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- wash %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in 2:(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_wash.shp")

rm(wash)
```

#### OR (568 treatments)
```{r, warning=FALSE}
### subset to OR
oreg <- burned_ft %>%
  filter(STATE_ABBR == "OR")

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop for the first 100 treatments in oregon
for (i in 1:100) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- oreg[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- oreg %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_oreg_100.shp")

rm(ft_fill)
```

##### repeat for rest of dataset
```{r, warning=FALSE}
### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop for the first 100 treatments in oregon
# for (i in 101:200) {
# for (i in 201:300) {
# for (i in 301:400) {
# for (i in 401:500) {
for (i in 501:nrow(oreg)) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- oreg[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- oreg %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_oreg_200.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_oreg_300.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_oreg_400.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_oreg_500.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_oreg_600.shp")

rm(ft_fill)
```

##### combine oregon
```{r}
### open individ files
o1 <- st_read("fuel_treat_overlaps_oreg_100.shp")
o2 <- st_read("fuel_treat_overlaps_oreg_200.shp")
o3 <- st_read("fuel_treat_overlaps_oreg_300.shp")
o4 <- st_read("fuel_treat_overlaps_oreg_400.shp")
o5 <- st_read("fuel_treat_overlaps_oreg_500.shp")
o6 <- st_read("fuel_treat_overlaps_oreg_600.shp")

### combine
o_all <- rbind(o1, o2, o3, o4, o5, o6)

### write out
st_write(o_all,
         "fuel_treat_overlaps_oreg_all.shp")

rm(o1, o2, o3, o4, o5, o6)
rm(o_all)
```


#### CO (635 treatments)
```{r, warning=FALSE}
### subset to CO
colo <- burned_ft %>%
  filter(STATE_ABBR == "CO")

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:100) {
for (i in 101:200) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- colo[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- colo %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_colo_100.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_colo_200.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:100) {
# for (i in 101:200) {
for (i in 201:300) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- colo[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- colo %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_colo_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_colo_200.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_colo_300.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:100) {
# for (i in 101:200) {
# for (i in 201:300) {
for (i in 301:400) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- colo[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- colo %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_colo_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_colo_200.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_colo_300.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_colo_400.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:100) {
# for (i in 101:200) {
# for (i in 201:300) {
# for (i in 301:400) {
for (i in 401:500) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- colo[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- colo %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_colo_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_colo_200.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_colo_300.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_colo_400.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_colo_500.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:100) {
# for (i in 101:200) {
# for (i in 201:300) {
# for (i in 301:400) {
# for (i in 401:500) {
for (i in 501:nrow(colo)) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- colo[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- colo %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_colo_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_colo_200.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_colo_300.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_colo_400.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_colo_500.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_colo_600.shp")


rm(ft_fill)
```

##### combine colo
```{r}
c1 <- st_read("fuel_treat_overlaps_colo_100.shp")
c2 <- st_read("fuel_treat_overlaps_colo_200.shp")
c3 <- st_read("fuel_treat_overlaps_colo_300.shp")
c4 <- st_read("fuel_treat_overlaps_colo_400.shp")
c5 <- st_read("fuel_treat_overlaps_colo_500.shp")
c6 <- st_read("fuel_treat_overlaps_colo_600.shp")

### combine
co_all <- rbind(c1, c2, c3, c4, c5, c6)

### write out
st_write(co_all,
         "fuel_treat_overlaps_colo_all.shp")
rm(c1, c2, c3, c4, c5, c6)
rm(co_all, colo)
```


#### AZ (721 treatments)
```{r, warning=FALSE}
### subset to AZ
ariz <- burned_ft %>%
  filter(STATE_ABBR == "AZ")

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
for (i in 1:100) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- ariz[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- ariz %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_ariz_100.shp")

rm(ft_fill)
gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:100) {
for (i in 101:200) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- ariz[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- ariz %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_100.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_ariz_200.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:100) {
# for (i in 101:200) {
for (i in 201:300) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- ariz[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- ariz %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_200.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_ariz_300.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:100) {
# for (i in 101:200) {
# for (i in 201:300) {
for (i in 301:400) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- ariz[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- ariz %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_200.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_300.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_ariz_400.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:100) {
# for (i in 101:200) {
# for (i in 201:300) {
# for (i in 301:400) {
for (i in 401:500) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- ariz[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- ariz %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_200.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_300.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_400.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_ariz_500.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:100) {
# for (i in 101:200) {
# for (i in 201:300) {
# for (i in 301:400) {
# for (i in 401:500) {
for (i in 501:600) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- ariz[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- ariz %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_200.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_300.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_400.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_500.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_ariz_600.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:100) {
# for (i in 101:200) {
# for (i in 201:300) {
# for (i in 301:400) {
# for (i in 401:500) {
# for (i in 501:600) {
for (i in 601:nrow(ariz)) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- ariz[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- ariz %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_200.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_300.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_400.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_500.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_ariz_600.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_ariz_700.shp")


rm(ft_fill)
```

##### combine ariz
```{r}
c1 <- st_read("fuel_treat_overlaps_ariz_100.shp")
c2 <- st_read("fuel_treat_overlaps_ariz_200.shp")
c3 <- st_read("fuel_treat_overlaps_ariz_300.shp")
c4 <- st_read("fuel_treat_overlaps_ariz_400.shp")
c5 <- st_read("fuel_treat_overlaps_ariz_500.shp")
c6 <- st_read("fuel_treat_overlaps_ariz_600.shp")
c7 <- st_read("fuel_treat_overlaps_ariz_700.shp")

### combine
az_all <- rbind(c1, c2, c3, c4, c5, c6, c7)

### write out
st_write(az_all,
         "fuel_treat_overlaps_ariz_all.shp")
rm(c1, c2, c3, c4, c5, c6, c7)
rm(az_all, ariz)
```

#### CA (2333 treatments)
```{r, warning=FALSE}
### subset to CA
cali <- burned_ft %>%
  filter(STATE_ABBR == "CA")

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
for (i in 1:50) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_50.shp")

rm(ft_fill)
gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
for (i in 51:100) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_100.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
# for (i in 51:100) {
for (i in 101:151) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_150.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
# for (i in 51:100) {
# for (i in 101:151) {
for (i in 151:200) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_150.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_200.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
for (i in 201:250) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_250.shp")

rm(ft_fill)
gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
for (i in 251:300) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_300.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
# for (i in 51:100) {
for (i in 301:351) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_350.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
# for (i in 51:100) {
# for (i in 101:151) {
for (i in 351:400) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_150.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_400.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
# for (i in 51:100) {
for (i in 401:450) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_450.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
# for (i in 51:100) {
# for (i in 101:151) {
for (i in 451:500) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

        if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_150.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_500.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
for (i in 501:526) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_526.shp")


rm(ft_fill)

gc()

### 526 doesn't overlap with any fuel treatments

### 527
### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### run loop for i = 527
### when j = 2286 and 2287, it breaks (but there isn't actually any intersection between the two footprints [ft_id = 45982,  ft_id = 458878, and ft_id = 458926])
### get polygon
temp_1 <- cali[527, ] %>%
  dplyr::select(ft_id, STATE_ABBR,
                ACTIVITY,
                date_comp, month_comp, year_comp,
                geometry)
  
### filter dataset by the state of interest
test_state <- cali %>%
  filter(STATE_ABBR == temp_1$STATE_ABBR)
  
for (j in (527+1):2285) {
  
  ### progress bar
  print(paste0("STEP ", j))
  
  ### get polygon 2
  temp_2 <- test_state[j, ] %>%
    dplyr::select(ft_id_2 = ft_id,
                  state_2 = STATE_ABBR,
                  activity_2 = ACTIVITY,
                  date_comp_2 = date_comp,
                  month_comp_2 = month_comp,
                  year_comp_2 = year_comp,
                  geometry)
  
  ### intersect
  temp_overlap <- st_intersection(temp_1,
                                  temp_2)
  
  # ### store intersections as a list
  # store_overlaps[j] <- temp_overlap
  
  ### add to df
  ft_fill <- rbind(ft_fill,
                   temp_overlap)
}

### skip j = 2286, 2287

for (j in 2288:(nrow(test_state)-1)) {
  
  ### progress bar
  print(paste0("STEP ", j))
  
  ### get polygon 2
  temp_2 <- test_state[j, ] %>%
    dplyr::select(ft_id_2 = ft_id,
                  state_2 = STATE_ABBR,
                  activity_2 = ACTIVITY,
                  date_comp_2 = date_comp,
                  month_comp_2 = month_comp,
                  year_comp_2 = year_comp,
                  geometry)
  
  ### intersect
  temp_overlap <- st_intersection(temp_1,
                                  temp_2)
  
  # ### store intersections as a list
  # store_overlaps[j] <- temp_overlap
  
  ### add to df
  ft_fill <- rbind(ft_fill,
                   temp_overlap)
}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_550.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
# for (i in 51:100) {
for (i in 551:600) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_600.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
# for (i in 51:100) {
# for (i in 101:151) {
for (i in 601:650) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_150.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_650.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
# for (i in 51:100) {
for (i in 651:700) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_700.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
# for (i in 51:100) {
# for (i in 101:151) {
for (i in 701:750) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_150.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_750.shp")


rm(ft_fill)

gc()
```

##### more ca
```{r, warning=FALSE}
### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
# for (i in 51:100) {
# for (i in 101:151) {
# for (i in 701:750) {
for (i in 751:800) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_150.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_750.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_800.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
# for (i in 51:100) {
# for (i in 101:151) {
# for (i in 701:750) {
# for (i in 751:800) {
for (i in 801:850) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_150.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_750.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_800.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_850.shp")


rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
# for (i in 51:100) {
# for (i in 101:151) {
# for (i in 701:750) {
# for (i in 751:800) {
# for (i in 801:850) {
for (i in 851:900) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_150.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_750.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_800.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_850.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_900.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
# for (i in 51:100) {
# for (i in 101:151) {
# for (i in 701:750) {
# for (i in 751:800) {
# for (i in 801:850) {
# for (i in 851:900) {
for (i in 901:950) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_150.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_750.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_800.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_850.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_900.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_950.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1:50) {
# for (i in 51:100) {
# for (i in 101:151) {
# for (i in 701:750) {
# for (i in 751:800) {
# for (i in 801:850) {
# for (i in 851:900) {
# for (i in 901:950) {
for (i in 951:1000) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

       if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_50.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_100.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_150.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_750.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_800.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_850.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_900.shp")
# st_write(ft_fill_split,
#          "fuel_treat_overlaps_cali_950.shp")
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1000.shp")

rm(ft_fill)

gc()
```

##### more ca
```{r, warning=FALSE}
### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
for (i in 1001:1050) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1050.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
for (i in 1051:1100) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1100.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
# for (i in 1051:1100) {
for (i in 1101:1150) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1150.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
# for (i in 1051:1100) {
# for (i in 1101:1150) {
for (i in 1151:1200) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1200.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
# for (i in 1051:1100) {
# for (i in 1101:1150) {
# for (i in 1151:1200) {
for (i in 1201:1250) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1250.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
# for (i in 1051:1100) {
# for (i in 1101:1150) {
# for (i in 1151:1200) {
# for (i in 1201:1250) {
for (i in 1251:1300) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1300.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
# for (i in 1051:1100) {
# for (i in 1101:1150) {
# for (i in 1151:1200) {
# for (i in 1201:1250) {
# for (i in 1251:1300) {
for (i in 1301:1350) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1350.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
# for (i in 1051:1100) {
# for (i in 1101:1150) {
# for (i in 1151:1200) {
# for (i in 1201:1250) {
# for (i in 1251:1300) {
# for (i in 1301:1350) {
for (i in 1351:1400) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1400.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
for (i in 1401:1450) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1450.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
for (i in 1451:1500) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1500.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
# for (i in 1051:1100) {
for (i in 1501:1550) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1550.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
# for (i in 1051:1100) {
# for (i in 1101:1150) {
for (i in 1551:1600) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1600.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
# for (i in 1051:1100) {
# for (i in 1101:1150) {
# for (i in 1151:1200) {
for (i in 1601:1650) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1650.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
# for (i in 1051:1100) {
# for (i in 1101:1150) {
# for (i in 1151:1200) {
# for (i in 1201:1250) {
for (i in 1651:1700) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1700.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
# for (i in 1051:1100) {
# for (i in 1101:1150) {
# for (i in 1151:1200) {
# for (i in 1201:1250) {
# for (i in 1251:1300) {
for (i in 1701:1750) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1750.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
# for (i in 1051:1100) {
# for (i in 1101:1150) {
# for (i in 1151:1200) {
# for (i in 1201:1250) {
# for (i in 1251:1300) {
# for (i in 1301:1350) {
for (i in 1751:1800) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1800.shp")

rm(ft_fill)

gc()
```

##### last of ca
```{r, warning=FALSE}
### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
# for (i in 1051:1100) {
# for (i in 1101:1150) {
# for (i in 1151:1200) {
# for (i in 1201:1250) {
# for (i in 1251:1300) {
for (i in 1801:1850) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1850.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
# for (i in 1051:1100) {
# for (i in 1101:1150) {
# for (i in 1151:1200) {
# for (i in 1201:1250) {
# for (i in 1251:1300) {
# for (i in 1301:1350) {
for (i in 1851:1900) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1900.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
for (i in 1901:1950) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_1950.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
for (i in 1951:2000) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_2000.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
for (i in 2001:2050) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_2050.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
# for (i in 1001:1050) {
# for (i in 1051:1100) {
# for (i in 1101:1150) {
# for (i in 1151:1200) {
# for (i in 1201:1250) {
# for (i in 1251:1300) {
# for (i in 1301:1350) {
for (i in 2051:2100) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_2100.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
for (i in 2101:2150) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_2150.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)

### make loop
for (i in 2151:2200) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_2200.shp")

rm(ft_fill)

gc()

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2) %>%
  dplyr::select(ft_id, 
                STATE_ABBR,
                ACTIVITY,
                date_comp,
                month_comp,
                year_comp,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_comp_2 = date_comp.1,
                month_comp_2 = month_comp.1,
                year_comp_2 = year_comp.1)


### make loop for the last of california
for (i in 2201:nrow(cali)) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- cali[i, ] %>%
    dplyr::select(ft_id, STATE_ABBR,
                  ACTIVITY,
                  date_comp, month_comp, year_comp,
                  geometry)
  
  ### filter dataset by the state of interest
  test_state <- cali %>%
    filter(STATE_ABBR == temp_1$STATE_ABBR)
  
  for (j in (i+1):(nrow(test_state)-1)) {

    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_comp_2 = date_comp,
                    month_comp_2 = month_comp,
                    year_comp_2 = year_comp,
                    geometry)

      if(temp_1$ft_id != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    }
  }

}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### remove nevada row
ft_fill <- ft_fill %>%
  filter(!STATE_ABBR == "NV")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# write out
st_write(ft_fill_split,
         "fuel_treat_overlaps_cali_2333.shp")

rm(ft_fill)

gc()
```

##### combine CA
```{r}
### list of ca files
ca_files <- list.files(path = "C:/Users/kjsie/Documents/fuel_treat_effects",
                       pattern = glob2rx("fuel_treat_overlaps_cali*.shp"),
                       full.names = TRUE)

### open all
ca_overlap_all <- lapply(ca_files, st_read)

### combine
ca_overlap_all <- do.call(rbind, ca_overlap_all)

### make sure there aren't any dups
ca_overlap_all <- ca_overlap_all %>% distinct()

### write out
st_write(ca_overlap_all,
         "fuel_treat_overlaps_cali_all.shp")

### clean up
rm(cali, nv_1, nv_2, temp_1, temp_2, temp_overlap, test_state, ca_files)
rm(ca_overlap_all)
```

### temporal filter on overlaps
How many years apart did the different, overlapping treatments occur? 
```{r}
### open overlaps for all states
ariz <- st_read("fuel_treat_overlaps_ariz_all.shp")
cali <- st_read("fuel_treat_overlaps_cali_all.shp")
colo <- st_read("fuel_treat_overlaps_colo_all.shp")
idah <- st_read("fuel_treat_overlaps_idah.shp")
mont <- st_read("fuel_treat_overlaps_mont.shp")
neva <- st_read("fuel_treat_overlaps_neva.shp")
nmex <- st_read("fuel_treat_overlaps_nmex.shp")
oreg <- st_read("fuel_treat_overlaps_oreg_all.shp")
utah <- st_read("fuel_treat_overlaps_utah.shp")
wash <- st_read("fuel_treat_overlaps_wash.shp")
wyom <- st_read("fuel_treat_overlaps_wyom.shp")

### combine
all_overlaps <- rbind(ariz, cali, colo, idah,
                      mont, neva, nmex, oreg,
                      utah, wash, wyom)

### rename cols
all_overlaps <- all_overlaps %>%
  rename(STATE_ABBR = STATE_A,
         activity_1 = ACTIVIT,
         date_comp_1 = dat_cmp,
         month_comp_1 = mnth_cm,
         year_comp_1 = yer_cmp,
         activity_2 = actvt_2,
         date_comp_2 = dt_cm_2,
         month_comp_2 = mnth__2,
         year_comp_2 = yr_cm_2)

### how many years apart did the treatments occur?
all_overlaps <- all_overlaps %>%
  mutate(year_diff = abs(year_comp_1 - year_comp_2))

### what's the range here?
range(all_overlaps$year_diff)
### 0-16 years between treatments

### plot this
ggplot(data = all_overlaps,
       aes(x = year_diff)) +
  geom_histogram(binwidth = 1) +
  theme_bw() +
  xlab("years between treatments") +
  NULL

### What are the overlapping treatments? Are some of these the same treatment type?
all_overlaps <- all_overlaps %>%
  mutate(overlap_same = ifelse(activity_1 == activity_2,
                               1, 0))
all_overlaps$overlap_same <- as.factor(all_overlaps$overlap_same)
### for 2258 of these rows, the overlapping polygons are for the same treatment type

### plot this
ggplot(data = all_overlaps,
       aes(x = year_diff,
           color = overlap_same,
           fill = overlap_same)) +
  geom_histogram(binwidth = 1) +
  theme_bw() +
  xlab("years between treatments") +
  NULL

### treatment order
all_overlaps <- all_overlaps %>%
  mutate(act_1_first = ifelse(year_comp_1 < year_comp_2, 1, 
                              ifelse(year_comp_1 == year_comp_2 & 
                                       month_comp_1 < month_comp_2, 1, 0)),
         first_treat_year = ifelse(act_1_first > 0, 
                                   year_comp_1,
                                   year_comp_2),
         first_treat = ifelse(act_1_first > 0,
                              activity_1,
                              activity_2),
         second_treat_year = ifelse(act_1_first < 1,
                                    year_comp_1,
                                    year_comp_2),
         second_treat = ifelse(act_1_first > 0, 
                               activity_2,
                               activity_1),
         first_ft_id = ifelse(act_1_first > 0,
                              ft_id, ft_id_2),
         second_ft_id = ifelse(act_1_first < 1,
                               ft_id, ft_id_2))

### make a column for unique ft overlap id
all_overlaps <- all_overlaps %>%
  mutate(overlap_id = row_number())
st_write(all_overlaps, 
         "all_overlap_fts.shp")
```

#### wildfire relative to overlap
```{r}
### Open csv of all burned footprints
all_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fts_w_us.csv")

### rename cols
all_fts <- all_fts %>%
  rename(wf_date = date,
         wf_month = month,
         wf_year = year)

### some fuel treatments burned in more than 1 fire

### first_treat
all_fts_first_treat <- all_fts %>%
  filter(ft_id %in% all_overlaps$first_ft_id)

### second_treat
all_fts_second_treat <- all_fts %>%
  filter(ft_id %in% all_overlaps$second_ft_id)

### are there fts that burned multiple times?

### start with first treatments
all_fts_first <- all_fts_first_treat %>%
  group_by(ft_id) %>%
  summarise(n_fires = n())

### first treatments that burned only once
first_burned_once <- all_fts_first %>%
  filter(n_fires < 2)

### plot
all_fts_first %>%
  filter(n_fires > 1) %>%
  ggplot(aes(x = n_fires)) +
  geom_histogram(binwidth = 1) +
  theme_bw() +
  NULL

### then second treatments
all_fts_second <- all_fts_second_treat %>%
  group_by(ft_id) %>%
  summarise(n_fires = n())

### second treatments that burned only once
second_burned_once <- all_fts_second %>%
  filter(n_fires < 2)

### plot
all_fts_second %>%
  filter(n_fires > 1) %>%
  ggplot(aes(x = n_fires)) +
  geom_histogram(binwidth = 1) +
  theme_bw() +
  NULL
```

##### without repeat burns
```{r}
### ok so first let's do the easy ones (not reburns)
### first_treat
first_treat_burned_once <- all_fts %>%
  filter(ft_id %in% first_burned_once$ft_id)

### second_treat
second_treat_burned_once <- all_fts %>%
  filter(ft_id %in% second_burned_once$ft_id)

### update columns
first_treat_burned_once <- first_treat_burned_once %>%
  rename(first_ft_id = ft_id,
         ft1_wf_id_mtbs = Event_ID,
         ft1_incid_type = Incid_Type,
         ft1_ig_date = Ig_Date,
         ft1_wf_day = wf_date,
         ft1_wf_month = wf_month,
         ft1_wf_year = wf_year)
second_treat_burned_once <- second_treat_burned_once %>%
  rename(second_ft_id = ft_id,
         ft2_wf_id_mtbs = Event_ID,
         ft2_incid_type = Incid_Type,
         ft2_ig_date = Ig_Date,
         ft2_wf_day = wf_date,
         ft2_wf_month = wf_month,
         ft2_wf_year = wf_year)

### add to first treatment wf to overlaps
all_overlaps_wf <- merge(x = all_overlaps,
                         y = first_treat_burned_once,
                         by = "first_ft_id",
                         all.x = TRUE)

### add to second treatment wf to overlaps
all_overlaps_wf <- merge(x = all_overlaps_wf,
                         y = second_treat_burned_once,
                         by = "second_ft_id",
                         all.x = TRUE)

### add column for whether or not ft's burned in the same fire
all_overlaps_wf <- all_overlaps_wf %>%
  mutate(diff_wf = ifelse(ft1_wf_id_mtbs == ft2_wf_id_mtbs,
                          0, 1))
table(all_overlaps_wf$diff_wf)
### in 212 of these overlaps, the different fuel treatments burned in different fires

### write out some examples
ex_burns <- all_overlaps_wf[c(1048, 1021), ]
st_write(ex_burns, "example_multi_burns.shp")
full_poly <- burned_fts %>%
  filter(ft_id %in% ex_burns$first_ft_id |
           ft_id %in% ex_burns$second_ft_id)
st_write(full_poly, "example_multi_burns_polys.shp")
mtbs <- st_read("E:/fire_sev_rdd/mtbs/mtbs_perims_DD.shp") %>%
  st_transform(crs = 6350) %>%
  filter(Event_ID %in% ex_burns$ft1_wf_id_mtbs |
           Event_ID %in% ex_burns$ft2_wf_id_mtbs)
st_write(mtbs, "ex_fires.shp")
```

Notes: need to overlay the overlaps with MTBS perimeters, because sometimes only 1 fire burned through the part of the fuel treatment footprint that overlapped with another fuel treatment footprint

### Overlay overlapping fuel treatments with MTBS
all_overlaps
```{r, warning=FALSE}
### make all_overlaps in 6350
all_overlaps <- all_overlaps %>%
  st_transform(6350)

### add columns for dates of completion for the fuel treatments!
all_overlaps <- all_overlaps %>%
  mutate(first_date_comp = ifelse(first_ft_id == ft_id,
                                  date_comp_1,
                                  date_comp_2),
         first_month_comp = ifelse(first_ft_id == ft_id,
                                   month_comp_1,
                                   month_comp_2),
         first_year_comp = ifelse(first_ft_id == ft_id,
                                   year_comp_1,
                                   year_comp_2),
         second_date_comp = ifelse(second_ft_id == ft_id,
                                  date_comp_1,
                                  date_comp_2),
         second_month_comp = ifelse(second_ft_id == ft_id,
                                   month_comp_1,
                                   month_comp_2),
         second_year_comp = ifelse(second_ft_id == ft_id,
                                   year_comp_1,
                                   year_comp_2))

### now make a column for the actual date
all_overlaps <- all_overlaps %>%
  mutate(date_comp_first_ft = dmy(paste(first_date_comp,
                                        first_month_comp,
                                        first_year_comp,
                                        sep = "/")))

### open mtbs, restrict to fires that overlap with treatments, and transform to 6350
mtbs <- st_read("E:/fire_sev_rdd/mtbs/mtbs_perims_DD.shp") %>%
  st_transform(crs = 6350) %>%
  filter(Event_ID %in% all_fts$Event_ID)

### reduce cols
mtbs <- mtbs %>%
  dplyr::select(Event_ID, Incid_Type, Ig_Date, geometry)
```

###### fires that burned after the first treatment
```{r}
### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(all_overlaps$overlap_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- all_overlaps[i, ]
  
  ### subset to fires that burned after
  mtbs_temp <- mtbs %>%
    filter(Ig_Date > tr_temp$date_comp_first_ft)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect,
                                   unique(all_overlaps$overlap_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
temp_intersect_store <- temp_intersect %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(temp_intersect_store) <- NULL

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL

  if(nrow(temp_data) > 0) {
    
    ### rbind with temp_intersect_store
    temp_intersect_store <- rbind(temp_intersect_store,
                           temp_data)
  } 
  
}

### temp_intersect_store has the mtbs intersections following the date of the first treatment

### did that fire also burn after the second treatment?

### make column for date of second treatment
temp_intersect_store <- temp_intersect_store %>%
  mutate(date_comp_sec_ft = dmy(paste(second_date_comp,
                                      second_month_comp,
                                      second_year_comp,
                                      sep = "/")))

### timing of fire vs. second treatment
temp_intersect_store <- temp_intersect_store %>%
  mutate(fire_1_post_sec_treat = ifelse(Ig_Date > date_comp_sec_ft,
                                        1, 0))
### 1 = fire burned after *both* treatments
table(temp_intersect_store$fire_1_post_sec_treat)
### 8512 of the treatment combos experienced wildfire after both treatments occurred
### 314 had treatment --> wildfire --> treatment

### write out
st_write(temp_intersect_store,
         "treatment_then_fire.shp")

```

###### fires that burned after the second treatment
```{r}
### add column for date of second treatment 
second_trt <- all_overlaps %>%
  mutate(date_comp_sec_ft = dmy(paste(second_date_comp,
                                      second_month_comp,
                                      second_year_comp,
                                      sep = "/")))

### remove any rows where the overlapping treatments finished on the same date
second_trt <- second_trt %>%
  filter(!date_comp_first_ft==date_comp_sec_ft)

### Loop to figure out which treatments burned after treatment
store_intersect_second <- list()

for (i in 1:length(unique(second_trt$overlap_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- second_trt[i, ]
  
  ### subset to fires that burned after
  mtbs_temp <- mtbs %>%
    filter(Ig_Date > tr_temp$date_comp_sec_ft)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_temp)
  
  ### store intersections as a list
  store_intersect_second[[i]] <- list(temp_intersect,
                                   unique(second_trt$overlap_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
temp_intersect_store_2 <- temp_intersect %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(temp_intersect_store_2) <- NULL

for (i in 1:length(store_intersect_second)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_second[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL

  if(nrow(temp_data) > 0) {
    
    ### rbind with temp_intersect_store
    temp_intersect_store_2 <- rbind(temp_intersect_store_2,
                           temp_data)
  } 
  
}

### temp_intersect_store_2 has the mtbs intersections following the date of the second treatment

### write out
st_write(temp_intersect_store_2,
         "sec_treatment_then_fire.shp")

```


### DONT ACTUALLY DO THIS
#### break it down by ft type
```{r}
### drop geom
overlap_summ <- all_overlaps
st_geometry(overlap_summ) <- NULL

### summarize by treatment type
overlap_summ <- overlap_summ %>%
  group_by(activity_1, activity_2, 
           year_diff, overlap_same) %>%
  summarise(n_count = n())
```
##### broadcast burning
```{r}
### subset to bb
bb <- overlap_summ %>%
  filter(activity_1 == "Broadcast Burning - Covers a majority of the unit" |
  activity_2 == "Broadcast Burning - Covers a majority of the unit")

### make column for other activity
bb <- bb %>%
  mutate(other_ft = ifelse(activity_1 == "Broadcast Burning - Covers a majority of the unit", activity_2, activity_1))

### plot
ggplot(data = bb,
       aes(x = year_diff,
           color = other_ft,
           fill = other_ft)) +
  geom_histogram(binwidth = 1) +
  theme_bw() +
  xlab("years between treatments") +
  scale_fill_viridis(discrete = TRUE,
                     option = "turbo") + 
  scale_color_viridis(discrete = TRUE,
                     option = "turbo") + 
  scale_x_continuous(breaks = seq(0, 10, by = 1)) +
  NULL
ggsave("overlap_broadcastburn.png")
```
##### underburns
```{r}
### subset to underburn
underburn <- overlap_summ %>%
  filter(activity_1 == "Underburn - Low Intensity (Majority of Unit)" |
  activity_2 == "Underburn - Low Intensity (Majority of Unit)")

### make column for other activity
underburn <- underburn %>%
  mutate(other_ft = ifelse(activity_1 == "Underburn - Low Intensity (Majority of Unit)", activity_2, activity_1))

### plot
ggplot(data = underburn,
       aes(x = year_diff,
           color = other_ft,
           fill = other_ft)) +
  geom_histogram(binwidth = 1) +
  theme_bw() +
  xlab("years between treatments") +
  scale_fill_viridis(discrete = TRUE,
                     option = "turbo") + 
  scale_color_viridis(discrete = TRUE,
                     option = "turbo") + 
  scale_x_continuous(breaks = seq(0, 10, by = 1)) +
  NULL
ggsave("overlap_underburn.png")
```
##### year_diff > 5
Which treatment combinations happen more than 5 years apart?
```{r, fig.width=12}
### drop geom
over5 <- all_overlaps %>%
  filter(year_diff > 5)
st_geometry(over5) <- NULL

### treatment order
over5 <- over5 %>%
  mutate(act_1_first = ifelse(year_comp_1 < year_comp_2, 1, 0),
         first_treat_year = ifelse(act_1_first > 0, 
                                   year_comp_1,
                                   year_comp_2),
         first_treat = ifelse(act_1_first > 0,
                              activity_1,
                              activity_2),
         second_treat = ifelse(act_1_first > 0, 
                               activity_2,
                               activity_1))

### summarize
summ_over5 <- over5 %>%
  group_by(first_treat, 
           second_treat,
           year_diff) %>%
  summarise(n_count = n())

### what if i didn't care about how many years elapsed between treatments?
summ_over5_group <- summ_over5 %>%
  group_by(first_treat,
           second_treat) %>%
  summarise(n_count = sum(n_count))

### shorten names
summ_over5_group <- summ_over5_group %>%
  mutate(first_treat = ifelse(first_treat == "Broadcast Burning - Covers a majority of the unit", "broadcast burn", ifelse(first_treat == "Burning of Piled Material", "pile burn", ifelse(first_treat == "Piling of Fuels, Hand or Machine", "fuel piling", ifelse(first_treat == "Salvage Cut (intermediate treatment, not regeneration)", "salvage cut", ifelse(first_treat == "Single-tree Selection Cut (UA/RH/FH)", "single tree cut", ifelse(first_treat == "Thinning for Hazardous Fuels Reduction", "thin hazardous fuel", ifelse(first_treat == "Underburn - Low Intensity (Majority of Unit)", "underburn", ifelse(first_treat == "Yarding - Removal of Fuels by Carrying or Dragging", "yarding fuels", first_treat)))))))))

summ_over5_group <- summ_over5_group %>%
  mutate(second_treat = ifelse(second_treat == "Broadcast Burning - Covers a majority of the unit", "broadcast burn", ifelse(second_treat == "Burning of Piled Material", "pile burn", ifelse(second_treat == "Piling of Fuels, Hand or Machine", "fuel piling", ifelse(second_treat == "Stand Clearcut (EA/RH/FH)", "stand clearcut", ifelse(second_treat == "Single-tree Selection Cut (UA/RH/FH)", "single tree cut", ifelse(second_treat == "Thinning for Hazardous Fuels Reduction", "thin hazardous fuel", ifelse(second_treat == "Underburn - Low Intensity (Majority of Unit)", "underburn", ifelse(second_treat == "Yarding - Removal of Fuels by Carrying or Dragging", "yarding fuels", ifelse(second_treat == "Wildfire - Human Ignition", "wildfire (anthro)", second_treat))))))))))

### visualize
ggplot() +
  geom_bar(data = summ_over5_group,
           aes(x = first_treat,
               y = n_count,
               color = second_treat,
               fill = second_treat),
           stat = "identity") +
  scale_x_discrete(labels = label_wrap(10)) +
  scale_fill_viridis(discrete = TRUE,
                     option = "turbo") + 
  scale_color_viridis(discrete = TRUE,
                     option = "turbo") +
  theme_bw(base_size = 24) +
    theme_bw() +
  NULL

ggsave("overlap_over_5yrs.png", width = 15)
```



## non-overlapping sections
Now I have polygons for the sections of treatments that overlap. But I also need the non-overlapping sections of the overlapping fuel treatments.

### demo with nevada

```{r}
### open full fuel treatments 
burned_fts <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats_year_updated.shp")

### open overlapping polygons
overlap_neva <- st_read("fuel_treat_overlaps_neva.shp")
```
## SOME INTERSECTIONS ARE JUST DUE TO POLYGON LINES NOT ALIGNING PERFECTLY

## Group by TREATMENT_
```{r}
### Drop method_summ column
ft_5ha_footprint$method_summ <- NULL

## Do these treatments have multiple methods?
unique(ft_5ha_footprint$TREATMENT_)

### methods categorizing
TREATMENT_ <- unique(ft_5ha_footprint$TREATMENT_)
category_tr <- c("fire", "combined", "mechanical",
                 "mechanical", "mechanical", "mechanical",
                 "fire", "fire", "mechanical",
                 "mechanical", "grazing", "NA", "NA")
treat_cat <- cbind.data.frame(TREATMENT_,
                              category_tr)

### Add this in
ft_5ha_footprint <- merge(ft_5ha_footprint,
                          treat_cat,
                          by = "TREATMENT_")

### Look at grazing
grazing <- ft_5ha_footprint %>%
  filter(category_tr == "grazing")

### Drop grazing
ft_5ha_footprint <- ft_5ha_footprint %>%
  filter(!category_tr == "grazing")

### Do these treatments have multiple methods?
mech_fire <- ft_5ha_footprint
st_geometry(mech_fire) <- NULL

#### List methods in each footprint
unique_methods <- mech_fire %>%
  group_by(footprint_id) %>%
  summarise(all_methods = list(unique(category_tr)))

### Get footprint IDs for methods
fire_meth <- unique_methods %>% 
  filter(all_methods == "fire") %>%
  mutate(method_summ = "fire")
mech_meth <- unique_methods %>% 
  filter(all_methods == "mechanical") %>%
  mutate(method_summ = "mechanical")
combined_meth <- unique_methods %>% 
  filter(all_methods == "combined") %>%
  mutate(method_summ = "combined")
na_meth <- unique_methods %>% 
  filter(is.na(all_methods)) %>%
  mutate(method_summ = "NA")

### Combine
methods_summary <- rbind(fire_meth,
                         mech_meth,
                         combined_meth,
                         na_meth)
methods_summary$all_methods <- NULL

### Footprints with multiple methods
mult_meth <- mech_fire %>%
  filter(!footprint_id %in% methods_summary$footprint_id) %>%
  dplyr::select(footprint_id) %>%
  mutate(method_summ = "combined")

### rbind
all_methods <- rbind(mult_meth, methods_summary)
all_methods <- distinct(all_methods)

### Number of footprints per method
table(all_methods$method_summ)

### Bring into shp
ft_5ha_footprint <- merge(ft_5ha_footprint,
                          all_methods,
                          by = "footprint_id",
                          all = TRUE)

### Save as shp 
st_write(ft_5ha_footprint, 
         "C:/Users/Katherine Siegel/Documents/Dee Lab/USDA AFRI/co_treatments_subset_for_analysis.shp")
```

## Smaller wildfires
FiredPy, filtered to fires in the western US, size < MTBS cut-off, in forested systems 
("Savannas", "Woody Savannas", "Deciduous Broadleaf Forests", "Evergreen Needleleaf Forests", "Cropland/Natural Vegetation Mosaics", "Evergreen Broadleaf Forests", "Mixed Forests")

**this dataset may include rx fires!!!**
```{r}
### open firedpy polygons
firedpy <- st_read("E:/fired_py_data/fired_west_forest_small.shp")

### reproject
firedpy <- firedpy %>%
  st_transform(crs = 6350)

#################################
#### PREP FUEL TREATMENT DATABASE
#################################

### Open fuel treatment database
ft <- st_read("E:/usda_2023/usfs_fuel_treatments/S_USA.Activity_HazFuelTrt_PL.shp") %>%
  mutate(., ft_id = row_number())

### Subset to states of the western US (and adjacent states)
ft <- ft %>%
  filter(STATE_ABBR %in% c("AZ", "CA",
                           "CO", "ID",
                           "MT", "NM",
                           "NV", "OR",
                           "UT", "WA", "WY",
                           
                           ### adjacent states
                           "ND", "SD",
                           "NE", "KS", 
                           "OK", "TX"))

### Filter out chemical and grazing
ft <- ft %>%
  filter(!METHOD %in% c("Animal",
                        "Chemical"))

### remove chemical and grazing
ft <- ft %>%
  filter(!TREATMENT_ %in% c("Chemical",
                            "Grazing"))

### Take out treatments where completed date = NA
ft <- ft %>%
  drop_na(DATE_COMPL)

### Reproject fuel treatments
ft <- ft %>%
  st_transform(crs = 6350)

### simplify columns
ft_simp <- ft %>%
  dplyr::select(ft_id, STATE_ABBR, geometry)

### Open western US boundary
w_bound <- raster::getData(name = "GADM",
                            country = 'USA',
                            level = 1) %>%
  st_as_sf() %>%
  filter(NAME_1 %in% c("Arizona", "California", 
                       "Colorado", "Idaho",
                       "Montana", "New Mexico",
                       "Nevada", "Oregon",
                       "Utah", "Washington",
                       "Wyoming"))

### Reproject w_bound
w_bound <- w_bound %>%
  st_transform(crs = 6350) %>%
  dplyr::select(NAME_1, geometry)

### divide up ft for overlap with western us (otherwise it's very large!)
ft_adj <- ft_simp %>%
  filter(STATE_ABBR %in% c("ND", "SD",
                           "NE", "KS", 
                           "OK", "TX"))
ft_pacific <- ft_simp %>%
  filter(STATE_ABBR %in% c("WA", "OR", "CA"))
ft_sw <- ft_simp %>%
  filter(STATE_ABBR %in% c("AZ", "UT", "CO", "NM"))
ft_n <- ft_simp %>%
  filter(STATE_ABBR %in% c("ID", "NV", "WY", "MT"))

### Intersect treatment boundaries with western states
ft_adj <- st_intersection(ft_adj,
                          w_bound)
# ft_pacific <- st_intersection(ft_pacific,
#                               w_bound)
ft_sw <- st_intersection(ft_sw,
                         w_bound)
ft_n <- st_intersection(ft_n,
                        w_bound)

### subset ft
ft_adj <- ft %>%
  filter(ft_id %in% ft_adj$ft_id)
ft_pacific <- ft %>%
  filter(ft_id %in% ft_pacific$ft_id)
ft_sw <- ft %>%
  filter(ft_id %in% ft_sw$ft_id)
ft_n <- ft %>%
  filter(ft_id %in% ft_n$ft_id)

# ### combine
# ft_all <- rbind(ft_adj,
#                 ft_pacific,
#                 ft_sw,
#                 ft_n)

```

### intersect with fts (fire post-treatment)
##### adjacent states
```{r}
### Add date cols for treatments
ft_adj <- ft_adj %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL))

### treatments completed range from 2007-2022

### drop firedpy fires before 2007
firedpy_adj <- firedpy %>%
  filter(ig_year > 2006)

### drop treatments that were completed after end of MTBS time series
ft_adj <- ft_adj %>%
  filter(year_comp < 2021)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_adj$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_adj[i, ]
  
  ### subset to fires that burned after
  firedpy_temp <- firedpy_adj %>%
    filter(ig_year > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, firedpy_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_adj$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
adj_treat_firedpy <- ft_adj[1, ]
adj_treat_firedpy <- adj_treat_firedpy %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(adj_treat_firedpy) <- NULL

### drop cols
adj_treat_firedpy <- adj_treat_firedpy %>%
  dplyr::select(ft_id)

### add cols for merge
adj_treat_firedpy <- adj_treat_firedpy %>%
  mutate(id = NA, 
         ig_date = NA,
         ig_day = NA, 
         ig_month = NA, 
         ig_year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  id, 
                  ig_date,
                  ig_day, ig_month, ig_year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    adj_treat_firedpy <- rbind(adj_treat_firedpy,
                           temp_data)
  } 
  
}

### none of ft_adj burned
```

##### northern states
```{r}
### Add date cols for treatments
ft_n <- ft_n %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL))

### treatments completed range from 1900-2023

### drop treatments that were completed after end of MTBS time series
ft_n <- ft_n %>%
  filter(year_comp < 2021)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n[i, ]
  
  ### subset to fires that burned after
  firedpy_temp <- firedpy %>%
    filter(ig_year > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, firedpy_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
adj_treat_firedpy <- ft_n[1, ]
adj_treat_firedpy <- adj_treat_firedpy %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(adj_treat_firedpy) <- NULL

### drop cols
adj_treat_firedpy <- adj_treat_firedpy %>%
  dplyr::select(ft_id)

### add cols for merge
adj_treat_firedpy <- adj_treat_firedpy %>%
  mutate(id = NA, 
         ig_date = NA,
         ig_day = NA, 
         ig_month = NA, 
         ig_year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  id, 
                  ig_date,
                  ig_day, ig_month, ig_year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    adj_treat_firedpy <- rbind(adj_treat_firedpy,
                           temp_data)
  } 
  
}

### none of ft_n burned

### write out
write_csv(n_fts,
          "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_n_burned_ft.csv")
```

