---
title: "update_mtbs"
output: html_document
date: "2024-03-06"
---

## Description
Add MTBS fires for 2021 and 2022. Pulls code from west_us.Rmd and then ft_overlaps.Rmd.

## Set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

### Load packages
library(tidyverse)
library(sf)
library(lubridate)
library(raster)
# library(terra)
# library(viridis)
# library(scales)
library(lwgeom)
library(googledrive)
library(furrr)
```

## From west_us.Rmd
### MTBS fire perimeters 
#### subset to western US and 2021-2022
```{r}
### open all fires
mtbs <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_through_2022/mtbs_perims_DD.shp") %>%
  st_transform(., 
               crs = 6350) %>%
  
  ### make column for year
  mutate(ig_year = year(Ig_Date)) # %>%
  
  # ### filter to 2021-2022
  # filter(ig_year > 2020)
  

### get column for state
mtbs <- mtbs %>%
  mutate(state = stringr::str_extract(Event_ID, "^.{2}"))

### filter to western US and surrounding states
mtbs <- mtbs %>%
  filter(state %in% c("AZ", "CA", "CO", "ID", "MT", "NM",
                      "NV", "OR", "UT", "WA", "WY", "ND",
                      "SD", "NE", "KS", "OK", "TX"))

### pull out Nevada fire that gets messed up with I intersect with w_borders
weird_fire <- mtbs %>% filter(Event_ID == "NV4099711695019840830") %>%
  dplyr::select(Event_ID, Incid_Type, 
                Ig_Date, geometry)

### open western states
w_borders <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/west_states.shp")

### intersect with western US boundaries
mtbs <- st_intersection(mtbs, w_borders)

### reduce cols
mtbs <- mtbs %>%
  dplyr::select(Event_ID, Incid_Type, 
                Ig_Date, geometry)

### drop prescribed fires
mtbs <- mtbs %>%
  filter(!Incid_Type == "Prescribed Fire")

### drop weird fire, add it back
mtbs <- mtbs %>%
  filter(!Event_ID == "NV4099711695019840830")
mtbs <- rbind(mtbs,
              weird_fire)

### Separate out year as column
mtbs <- mtbs %>%
  mutate(date = day(Ig_Date),
         month = month(Ig_Date),
         year = year(Ig_Date))

### Write out
st_write(mtbs,
         "E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_1984_2022_west.shp")

rm(w_borders)
```

## DO NOT RUN: Overlapping treatments
Simplify treatments where the boundaries, SUID, and date completed completely overlap
```{r}
### try with ft_adj
ft_adj <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/adj_treatments_all.shp")

### pull out fts with multiple rows

### make version without sf
ft_adj_df <- ft_adj
st_geometry(ft_adj_df) <- NULL

### figure out which SUIDs have multiple rows
summ_ft_adj <- ft_adj_df %>%
  group_by(SUID) %>%
  summarise(n_rows = n()) %>%
  filter(n_rows > 1)

### check that completion dates are the same
summ_ft_adj_dates <- ft_adj_df %>%
  group_by(SUID, DATE_COMPL) %>%
  summarise(n_rows = n())

### pull those out
ft_adj_mult <- ft_adj %>%
  filter(SUID %in% summ_ft_adj$SUID) #%>%
  # dplyr::select(SUID, ACTIVITY, ACTIVITY_C,
  #               DATE_COMPL, ft_id, geometry)

### see if geometries are the same?
### make df with geometry as text string
ft_adj_mult_summ <- ft_adj_mult 
ft_adj_mult_summ$geom_text <- as.character(ft_adj_mult_summ$geometry)
st_geometry(ft_adj_mult_summ) <- NULL

### check if the geometries are the same for each SUID
ft_adj_mult_summ_geom <- ft_adj_mult_summ %>%
  group_by(SUID, geom_text) %>%
  summarise(n_rows = n())
### yes, each row with the same SUID has the same geometry

### make df with combined treatments
ft_adj_mult_df <- ft_adj_mult
st_geometry(ft_adj_mult_df) <- NULL

### fix row with NA for TREATMENT
ft_adj_mult_df$TREATMENT_[is.na(ft_adj_mult_df$TREATMENT_)] <- "Thinning"

### make treatment category column
ft_adj_mult_df <- ft_adj_mult_df %>%
  mutate(category_tr = ifelse(TREATMENT_ == "Machine Pile Burn",
                              "other fire",
                              "mechanical"))

### simplify cols
ft_adj_mult_df <- ft_adj_mult_df %>%
  dplyr::select(SUID, DATE_COMPL, category_tr) %>%
  distinct()

### group by SUID and date completed
ft_adj_mult_df <- ft_adj_mult_df %>%
  dplyr::select(SUID, DATE_COMPL, ACTIVITY, category_tr) %>%
  group_by(SUID, DATE_COMPL, ACTIVITY, category_tr) %>%
  summarize(all_activity = nrow(unique(ACTIVITY)))

  group_by(SUID, DATE_COMPL, geometry) %>%
  mutate(treatments = unique(ACTIVITY))
```



## Get burned fts for whole time series
### intersect with fts (fire post-treatment)
#### adjacent states
```{r}
### open MTBS, restrict to 2021 and 2022
mtbs <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_1984_2022_west.shp")

### open ft_adj
ft_adj <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/adj_treatments_all.shp")

### Add date cols for treatments
ft_adj <- ft_adj %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL))

### treatments completed range from 2007-2022

### drop MTBS fires before 2007
mtbs <- mtbs %>%
  filter(year > 2006)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_adj$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_adj[i, ]
  
  ### subset to fires that burned after
  mtbs_temp <- mtbs %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_adj$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
adj_treat_burn <- ft_adj[1, ]
adj_treat_burn <- adj_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(adj_treat_burn) <- NULL

### drop cols
adj_treat_burn <- adj_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
adj_treat_burn <- adj_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    adj_treat_burn <- rbind(adj_treat_burn,
                           temp_data)
  } 
  
}

### none of ft_adj burned

### clean up
rm(adj_treat_burn, ft_adj, mtbs_temp, mtbs, store_intersect_all)
gc()
```

#### southwestern states
```{r}
### open MTBS, restrict to 2021 and 2022
mtbs <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_1984_2022_west.shp")

### spatial filter on MTBS to sw states and adjacent states
mtbs_sw <- mtbs %>%
  mutate(state = stringr::str_extract(Event_ID, "^.{2}")) %>%
  filter(state %in% c("AZ", "CA", "CO", "ID", "NM",
                      "NV", "UT", "WY", 
                      "NE", "KS", "OK", "TX")) %>%
  dplyr::select(-state)

### open ft and intersect
ft_sw <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/sw_treatments.shp")

### Add date cols for treatments
ft_sw <- ft_sw %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL))

### when did the treatments occur?
range(ft_sw$year_comp)
### treatments completed range from 1997-2023

### drop MTBS fires before 2007
mtbs_sw <- mtbs_sw %>%
  filter(year > 1996)
```

##### purpose: fuels treatment - maintenance
```{r}
### restrict 
ft_sw_ftm <- ft_sw %>%
  filter(PURPOSE_CO == "FTM")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_ftm$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_ftm[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_ftm$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
sw_ftm_treat_burn <- ft_sw_ftm[1, ]
sw_ftm_treat_burn <- sw_ftm_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_ftm_treat_burn) <- NULL

### drop cols
sw_ftm_treat_burn <- sw_ftm_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_ftm_treat_burn <- sw_ftm_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_ftm_treat_burn <- rbind(sw_ftm_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_ftm_treat_burn <- sw_ftm_treat_burn %>%
  filter(!ft_id == "empty")

### 87 fuel treatments burned
```

##### purpose: fuels treatment - final
```{r}
### restrict 
ft_sw_ftf <- ft_sw %>%
  filter(PURPOSE_CO == "FTF")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_ftf$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_ftf[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_ftf$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
sw_ftf_treat_burn <- ft_sw_ftf[1, ]
sw_ftf_treat_burn <- sw_ftf_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_ftf_treat_burn) <- NULL

### drop cols
sw_ftf_treat_burn <- sw_ftf_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_ftf_treat_burn <- sw_ftf_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_ftf_treat_burn <- rbind(sw_ftf_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_ftf_treat_burn <- sw_ftf_treat_burn %>%
  filter(!ft_id == "empty")

### 170 fuel treatments burned
```

##### purpose: fuels treatment - initial/interim
```{r}
### restrict 
ft_sw_fti <- ft_sw %>%
  filter(PURPOSE_CO == "FTI")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_fti$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_fti[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_fti$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
sw_fti_treat_burn <- ft_sw_fti[1, ]
sw_fti_treat_burn <- sw_fti_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_fti_treat_burn) <- NULL

### drop cols
sw_fti_treat_burn <- sw_fti_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_fti_treat_burn <- sw_fti_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_fti_treat_burn <- rbind(sw_fti_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_fti_treat_burn <- sw_fti_treat_burn %>%
  filter(!ft_id == "empty")

### 275 fuel treatments burned

### clean
rm(ft_sw_fti, store_intersect_all)
gc()
```

##### purpose: other
```{r}
### restrict 
ft_sw_other <- ft_sw %>%
  filter(!PURPOSE_CO %in% c("FTI", "FTF", "FTM")) %>%
  filter(!is.na(PURPOSE_CO))

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_other$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_other[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_other$ft_id)[i])
  
}

### See how many treatments burned
sw_other_treat_burn <- ft_sw_other[1, ]
sw_other_treat_burn <- sw_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_other_treat_burn) <- NULL

### drop cols
sw_other_treat_burn <- sw_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_other_treat_burn <- sw_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_other_treat_burn <- rbind(sw_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_other_treat_burn <- sw_other_treat_burn %>%
  filter(!ft_id == "empty")

### 146 fuel treatments burned
```

###### combine so far
```{r}
### combine
ft_multiple <- rbind(sw_ftm_treat_burn,
                     sw_ftf_treat_burn,
                     sw_fti_treat_burn,
                     sw_other_treat_burn)

### write out
write_csv(ft_multiple,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/sw_burned_ft.csv")

### clean up
rm(ft_sw_other, sw_ftf_treat_burn, sw_fti_treat_burn, sw_other_treat_burn, sw_ftm_treat_burn)
rm(store_intersect_all, mtbs_sw_temp)
gc()
```
##### purpose: NA
```{r}
### restrict 
ft_sw_na <- ft_sw %>%
  filter(is.na(PURPOSE_CO))

table(ft_sw_na$TREATMENT_)
# Biomass Removal     Broadcast Burn           Chipping           Crushing 
#               1717               1250                316                188 
#           Fire Use       Jackpot Burn    Lop and Scatter       Machine Pile 
#                389                 46                452               1759 
#  Machine Pile Burn Mastication/Mowing                N/A           Thinning 
#               2133                  1                326               4150 

#### subset by treatment_

#################################
#################################
#################################
ft_sw_na_br <- ft_sw_na %>%
  filter(TREATMENT_ == "Biomass Removal")

### make list for storage
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_na_br$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_na_br[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_na_br$ft_id)[i])
  
}

### See how many treatments burned
sw_br_treat_burn <- ft_sw_na_br[1, ]
sw_br_treat_burn <- sw_br_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_br_treat_burn) <- NULL

### drop cols
sw_br_treat_burn <- sw_br_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_br_treat_burn <- sw_br_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_br_treat_burn <- rbind(sw_br_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_br_treat_burn <- sw_br_treat_burn %>%
  filter(!ft_id == "empty")

#################################
#################################
#################################
ft_sw_na_bb <- ft_sw_na %>%
  filter(TREATMENT_ == "Broadcast Burn")

### make list for storage
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_na_bb$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_na_bb[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_na_bb$ft_id)[i])
  
}

### See how many treatments burned
sw_other_bb_burn <- ft_sw_na_bb[1, ]
sw_other_bb_burn <- sw_other_bb_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_other_bb_burn) <- NULL

### drop cols
sw_other_bb_burn <- sw_other_bb_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_other_bb_burn <- sw_other_bb_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_other_bb_burn <- rbind(sw_other_bb_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_other_bb_burn <- sw_other_bb_burn %>%
  filter(!ft_id == "empty")

#################################
#################################
#################################
ft_sw_na_mp <- ft_sw_na %>%
  filter(TREATMENT_ == "Machine Pile")

### make list for storage
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_na_mp$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_na_mp[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_na_mp$ft_id)[i])
  
}

### See how many treatments burned
sw_other_mp_burn <- ft_sw_na_mp[1, ]
sw_other_mp_burn <- sw_other_mp_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_other_mp_burn) <- NULL

### drop cols
sw_other_mp_burn <- sw_other_mp_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_other_mp_burn <- sw_other_mp_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_other_mp_burn <- rbind(sw_other_mp_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_other_mp_burn <- sw_other_mp_burn %>%
  filter(!ft_id == "empty")

#################################
#################################
#################################
ft_sw_na_mpb <- ft_sw_na %>%
  filter(TREATMENT_ == "Machine Pile Burn")

### make list for storage
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_na_mpb$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_na_mpb[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_na_mpb$ft_id)[i])
  
}

### See how many treatments burned
sw_other_mpb_burn <- ft_sw_na_mpb[1, ]
sw_other_mpb_burn <- sw_other_mpb_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_other_mpb_burn) <- NULL

### drop cols
sw_other_mpb_burn <- sw_other_mpb_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_other_mpb_burn <- sw_other_mpb_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_other_mpb_burn <- rbind(sw_other_mpb_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_other_mpb_burn <- sw_other_mpb_burn %>%
  filter(!ft_id == "empty")

#################################
#################################
#################################

ft_sw_na_thin <- ft_sw_na %>%
  filter(TREATMENT_ == "Thinning")

### make list for storage
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_na_thin$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_na_thin[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw_na_thin$ft_id)[i])
  
}

### See how many treatments burned
sw_other_thin_burn <- ft_sw_na_thin[1, ]
sw_other_thin_burn <- sw_other_thin_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_other_thin_burn) <- NULL

### drop cols
sw_other_thin_burn <- sw_other_thin_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_other_thin_burn <- sw_other_thin_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_other_thin_burn <- rbind(sw_other_thin_burn,
                               temp_data)
  } 
  
}

### drop the empty row
sw_other_thin_burn <- sw_other_thin_burn %>%
  filter(!ft_id == "empty")

#################################
#################################
#################################
### combine
sw_na_combined <- rbind(sw_br_treat_burn, 
                        sw_other_bb_burn,
                        sw_other_mp_burn,
                        sw_other_mpb_burn,
                        sw_other_thin_burn)

### write out
write_csv(sw_na_combined,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/sw_burned_ft_part2.csv")

```

##### the rest of the NAs
```{r}
### restrict 
ft_sw_na_remaining <- ft_sw_na %>%
  filter(!TREATMENT_ %in% c("Biomass Removal",
                            "Broadcast Burn",
                            "Machine Pile",
                            "Machine Pile Burn",
                            "Thinning"))

### make list for storage
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw_na_remaining$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw_na_remaining[i, ]
  
  ### subset to fires that burned after
  mtbs_sw_temp <- mtbs_sw %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_sw_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect,
                                   unique(ft_sw_na_remaining$ft_id)[i])
  
}

### See how many treatments burned
sw_remaining_treat_burn <- ft_sw_na_remaining[1, ]
sw_remaining_treat_burn <- sw_remaining_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(sw_remaining_treat_burn) <- NULL

### drop cols
sw_remaining_treat_burn <- sw_remaining_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
sw_remaining_treat_burn <- sw_remaining_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    sw_remaining_treat_burn <- rbind(sw_remaining_treat_burn,
                                     temp_data)
  } 
  
}

### drop the empty row
sw_remaining_treat_burn <- sw_remaining_treat_burn %>%
  filter(!ft_id == "empty")

### 294 fuel treatments burned

### write out
write_csv(sw_remaining_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/sw_burned_ft_part3.csv")
```

##### combine sw
```{r}
### open all
sw_remaining_treat_burn <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/sw_burned_ft_part3.csv")
sw_1 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/sw_burned_ft.csv")
sw_2 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/sw_burned_ft_part2.csv")


### combine all
sw_na_all <- rbind(sw_remaining_treat_burn, 
                   sw_1,
                   sw_2)

### write out
write_csv(sw_na_all,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/sw_burned_ft_all.csv")

### clean up
rm(ft_sw, ft_sw_na, ft_sw_na_remaining, mtbs_sw, mtbs_sw_temp,
   store_intersect_all, sw_1, sw_2, sw_na_all, sw_remaining_treat_burn,
   temp_data, temp_intersect, tr_temp)
gc()
```

#### northern states
```{r}
### open ft 
ft_n <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/northern_treatments.shp")

### Add date cols for treatments
ft_n <- ft_n %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL))

### when did the treatments occur?
range(ft_n$year_comp)
sort(unique(ft_n$year_comp))
### treatments completed range from 1900-2023

### drop treatments that were completed before mtbs time series
ft_n <- ft_n %>%
  filter(year_comp > 1983)

### spatial filter on MTBS to sw states and adjacent states
mtbs_n <- mtbs %>%
  mutate(state = stringr::str_extract(Event_ID, "^.{2}"))
mtbs_n <- mtbs_n %>%
  filter(state %in% c("MT", "ID", "WY", "NV",
                      "WA", "OR", "CA", "UT",
                      "AZ", "CO", "NE", "SD", "ND"))

### treatment types
table(ft_n$PURPOSE_CO)
### 24 disease
### 7 wildlife
### 189 timber stand improvement
### 17 timber management
### 294 fuels
### 1135 fire
### 2719 fuels treatment - maintenance
### 6068 fuels treatment - final
### 20318 fuels treatment - initial/interim
### 1 recreation
### 3 reforestation
### 9 insect control
```

###### purpose: fuels treatment - maintenance
```{r}
### restrict 
ft_n_ftm <- ft_n %>%
  filter(PURPOSE_CO == "FTM")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_ftm$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_ftm[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_ftm$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_ftm_treat_burn <- ft_n_ftm[1, ]
n_ftm_treat_burn <- n_ftm_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_ftm_treat_burn) <- NULL

### drop cols
n_ftm_treat_burn <- n_ftm_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_ftm_treat_burn <- n_ftm_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_ftm_treat_burn <- rbind(n_ftm_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_ftm_treat_burn <- n_ftm_treat_burn %>%
  filter(!ft_id == "empty")

### 27 fuel treatments burned

rm(ft_n_ftm)
gc()

write_csv(n_ftm_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_burned_ft_part1_1.csv")
```

###### purpose: fuel treatments final 
```{r}
### restrict 
ft_n_ftf <- ft_n %>%
  filter(PURPOSE_CO == "FTF")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_ftf$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_ftf[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_ftf$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_ftf_treat_burn <- ft_n_ftf[1, ]
n_ftf_treat_burn <- n_ftf_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_ftf_treat_burn) <- NULL

### drop cols
n_ftf_treat_burn <- n_ftf_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_ftf_treat_burn <- n_ftf_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_ftf_treat_burn <- rbind(n_ftf_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_ftf_treat_burn <- n_ftf_treat_burn %>%
  filter(!ft_id == "empty")

rm(ft_n_ftf)
gc()

write_csv(n_ftf_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_burned_ft_part1_2.csv")
```

###### purpose: fuel treatments interim/intermed 
```{r}
###### purpose: fuel treatments interim/intermed 
### restrict 
ft_n_fti <- ft_n %>%
  filter(PURPOSE_CO == "FTI")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_fti$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_fti[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_fti$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_fti_treat_burn <- ft_n_fti[1, ]
n_fti_treat_burn <- n_fti_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_fti_treat_burn) <- NULL

### drop cols
n_fti_treat_burn <- n_fti_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_fti_treat_burn <- n_fti_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_fti_treat_burn <- rbind(n_fti_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_fti_treat_burn <- n_fti_treat_burn %>%
  filter(!ft_id == "empty")

rm(ft_n_fti)
gc()

write_csv(n_fti_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_burned_ft_part1_3.csv")
```

###### combine FTM, FTF, FTI
```{r}
### open all
n_ftm_treat_burn <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_burned_ft_part1_1.csv")
n_ftf_treat_burn <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_burned_ft_part1_2.csv")
n_fti_treat_burn <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_burned_ft_part1_3.csv")

### combine
n_fts <- rbind(n_ftm_treat_burn,
               n_ftf_treat_burn,
               n_fti_treat_burn)

### write out
write_csv(n_fts,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_burned_ft_part1.csv")
```

###### purpose: other than FTF, FTM, FTI (not NA)
```{r}
###### purpose: other than FTF, FTM, FTI 

### restrict 
ft_n_other <- ft_n %>%
  filter(!PURPOSE_CO %in% c("FTF", "FTM", "FTI")) %>%
  filter(!is.na(PURPOSE_CO))

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_other$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_other[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_other$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_other_treat_burn <- ft_n_other[1, ]
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_other_treat_burn) <- NULL

### drop cols
n_other_treat_burn <- n_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_other_treat_burn <- rbind(n_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_other_treat_burn <- n_other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(n_other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_other_burned.csv")
```

###### purpose: NA, broadcast burn
```{r}
### restrict 
ft_n_na <- ft_n %>%
  filter(is.na(PURPOSE_CO))

### counts
table(ft_n_na$TREATMENT_)

### subset for loop
ft_n_na_1 <- ft_n_na %>%
  filter(TREATMENT_ == "Broadcast Burn")
rm(ft_n_na)
gc()

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_na_1$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_na_1[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_na_1$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_other_treat_burn <- ft_n_na_1[1, ]
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_other_treat_burn) <- NULL

### drop cols
n_other_treat_burn <- n_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_other_treat_burn <- rbind(n_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_other_treat_burn <- n_other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(n_other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_other_burned_na_1.csv")
```

###### purpose: NA, not broadcast burn/thinning/biomass removal/machine pile burn
```{r}
### restrict 
ft_n_na <- ft_n %>%
  filter(is.na(PURPOSE_CO))

### subset for loop
ft_n_na_2 <- ft_n_na %>%
  filter(!TREATMENT_ %in% c("Broadcast Burn",
                            "Thinning",
                            "Machine Pile Burn",
                            "Biomass Removal"))
rm(ft_n_na)
gc()

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_na_2$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_na_2[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_na_2$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_other_treat_burn <- ft_n_na_2[1, ]
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_other_treat_burn) <- NULL

### drop cols
n_other_treat_burn <- n_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_other_treat_burn <- rbind(n_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_other_treat_burn <- n_other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(n_other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_other_burned_na_2.csv")
```

###### purpose: NA, biomass removal/machine pile burn
```{r}
### restrict 
ft_n_na <- ft_n %>%
  filter(is.na(PURPOSE_CO))

### subset for loop
ft_n_na_3 <- ft_n_na %>%
  filter(TREATMENT_ == "Machine Pile Burn")
rm(ft_n_na)
gc()

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_na_3$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_na_3[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_na_3$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_other_treat_burn <- ft_n_na_3[1, ]
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_other_treat_burn) <- NULL

### drop cols
n_other_treat_burn <- n_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_other_treat_burn <- rbind(n_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_other_treat_burn <- n_other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(n_other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_other_burned_na_3_1.csv")

### restrict 
ft_n_na <- ft_n %>%
  filter(is.na(PURPOSE_CO))

### subset for loop
ft_n_na_3 <- ft_n_na %>%
  filter(TREATMENT_ == "Biomass Removal")
rm(ft_n_na)
gc()

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_na_3$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_na_3[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_na_3$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_other_treat_burn <- ft_n_na_3[1, ]
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_other_treat_burn) <- NULL

### drop cols
n_other_treat_burn <- n_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_other_treat_burn <- rbind(n_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_other_treat_burn <- n_other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(n_other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_other_burned_na_3_2.csv")
```

###### purpose: NA, thinning before 2011
```{r}
### restrict 
ft_n_na <- ft_n %>%
  filter(is.na(PURPOSE_CO))

### subset for loop
ft_n_na_4 <- ft_n_na %>%
  filter(TREATMENT_ %in% c("Thinning"))
table(ft_n_na_4$year_comp)

### subset years
ft_n_na_4 <- ft_n_na_4 %>%
  filter(year_comp < 2011)

rm(ft_n_na)
gc()

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_na_4$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_na_4[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_na_4$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_other_treat_burn <- ft_n_na_4[1, ]
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_other_treat_burn) <- NULL

### drop cols
n_other_treat_burn <- n_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_other_treat_burn <- rbind(n_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_other_treat_burn <- n_other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(n_other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_other_burned_na_4.csv")
```

###### purpose: NA, thinning 2011 onwards
```{r}
### restrict 
ft_n_na <- ft_n %>%
  filter(is.na(PURPOSE_CO))

### subset for loop
ft_n_na_5 <- ft_n_na %>%
  filter(TREATMENT_ %in% c("Thinning"))%>%
  filter(year_comp > 2010)

rm(ft_n_na)
gc()

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_n_na_5$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_n_na_5[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_n %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_n_na_5$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
n_other_treat_burn <- ft_n_na_5[1, ]
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(n_other_treat_burn) <- NULL

### drop cols
n_other_treat_burn <- n_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
n_other_treat_burn <- n_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    n_other_treat_burn <- rbind(n_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
n_other_treat_burn <- n_other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(n_other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_other_burned_na_5.csv")

### clean up
rm(ft_n, ft_n_na_5, mtbs_n, mtbs_n_temp, 
   n_other_treat_burn, store_intersect_all,
   temp_data, temp_intersect, tr_temp)
gc()
```

###### combine northern states
```{r}
### open all csvs
n_1 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_burned_ft_part1.csv")
n_2 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_other_burned.csv")
n_3 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_other_burned_na_1.csv")
n_4 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_other_burned_na_2.csv")
n_5 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_other_burned_na_3_1.csv")
n_5_1 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_other_burned_na_3_2.csv")
n_6 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_other_burned_na_4.csv")
n_7 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_other_burned_na_5.csv")

### combine
n_fts_all <- rbind(n_1, n_2, n_3, n_4,
                   n_5, n_5_1, n_6, n_7)

### write out
write_csv(n_fts_all,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_burned_ft_all.csv")

### check
ft_n_check <- ft_n %>%
  dplyr::filter(ft_id %in% n_fts_all$ft_id)
st_write(ft_n_check, "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_burned_ft_check_updated.shp")

```

#### pacific states
```{r}
### open ft 
ft_pac <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_treatments.shp")

### Add date cols for treatments
ft_pac <- ft_pac %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL))

### when did the treatments occur?
range(ft_pac$year_comp)
### treatments completed range from 1939-2023

### drop treatments that were completed before mtbs time series
ft_pac <- ft_pac %>%
  filter(year_comp > 1983)

### spatial filter on MTBS to pac states and adjacent states
mtbs_pac <- mtbs %>%
  mutate(state = stringr::str_extract(Event_ID, "^.{2}"))
mtbs_pac <- mtbs_pac %>%
  filter(state %in% c("WA", "OR", "CA",
                      "ID", "NV", "AZ"))

### treatment types
table(ft_pac$PURPOSE_CO)
### 22 brush disposal
### 1 TES species
### 2 cultural resources
### 2 disease
### 97 wildlife
### 7 fisheries
### 144 timber stand improvement
### 295 timber management
### 300 fuels
### 3493 fire
### 13757 fuels treatment - maintenance
### 7492 fuels treatment - final
### 44057 fuels treatment - initial/interim
### 40 reforestation
```

###### purpose: not FT and not NA
```{r}
### restrict 
ft_pac_other <- ft_pac %>%
  filter(!PURPOSE_CO %in% c("FTM",
                            "FTF",
                            "FTI")) %>%
  filter(!is.na(PURPOSE_CO))

### clean
rm(ft_pac)
gc()

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_other$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_other[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_other$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_other_treat_burn <- ft_pac_other[1, ]
pac_other_treat_burn <- pac_other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_other_treat_burn) <- NULL

### drop cols
pac_other_treat_burn <- pac_other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_other_treat_burn <- pac_other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_other_treat_burn <- rbind(pac_other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_other_treat_burn <- pac_other_treat_burn %>%
  filter(!ft_id == "empty")

### 1517 fuel treatments burned

write_csv(pac_other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_other.csv")
rm(store_intersect_all, mtbs_n_temp, ft_pac_other)
```

###### purpose: FTF
```{r}
### open ft 
ft_pac <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_treatments.shp")

### Add date cols for treatments, restrict years
ft_pac <- ft_pac %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL)) %>%
  filter(year_comp > 1983)

### restrict 
ft_pac_ftf <- ft_pac %>%
  filter(PURPOSE_CO == "FTF") 

### restrict more
ft_pac_ftf_1 <- ft_pac_ftf %>%
  filter(TREATMENT_ == "Machine Pile Burn") 

### clean
rm(ft_pac, ft_pac_ftf)
gc()

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_ftf_1$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_ftf_1[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_ftf_1$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_ftf_treat_burn <- ft_pac_ftf_1[1, ]
pac_ftf_treat_burn <- pac_ftf_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_ftf_treat_burn) <- NULL

### drop cols
pac_ftf_treat_burn <- pac_ftf_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_ftf_treat_burn <- pac_ftf_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_ftf_treat_burn <- rbind(pac_ftf_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_ftf_treat_burn <- pac_ftf_treat_burn %>%
  filter(!ft_id == "empty")

### 362 fuel treatments burned

write_csv(pac_ftf_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftf_1.csv")
rm(store_intersect_all, mtbs_n_temp)
rm(ft_pac_ftf_1, pac_ftf_treat_burn)
```

###### purpose: FTF part 2
```{r}
### open ft 
ft_pac <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_treatments.shp")

### Add date cols for treatments, restrict years
ft_pac <- ft_pac %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL)) %>%
  filter(year_comp > 1983)

### restrict 
ft_pac_ftf <- ft_pac %>%
  filter(PURPOSE_CO == "FTF") 

### the last one
ft_pac_ftf_1 <- ft_pac_ftf %>%
  filter(TREATMENT_ == "Machine Pile Burn") 

### restrict more
ft_pac_ftf_2 <- ft_pac_ftf %>%
  filter(!ft_id %in% ft_pac_ftf_1$ft_id) 

### clean
rm(ft_pac, ft_pac_ftf, ft_pac_ftf_1)
gc()

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_ftf_2$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_ftf_2[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_ftf_2$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_ftf_treat_burn <- ft_pac_ftf_2[1, ]
pac_ftf_treat_burn <- pac_ftf_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_ftf_treat_burn) <- NULL

### drop cols
pac_ftf_treat_burn <- pac_ftf_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_ftf_treat_burn <- pac_ftf_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_ftf_treat_burn <- rbind(pac_ftf_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_ftf_treat_burn <- pac_ftf_treat_burn %>%
  filter(!ft_id == "empty")

### 362 fuel treatments burned

write_csv(pac_ftf_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftf_2.csv")
rm(store_intersect_all, mtbs_n_temp)
rm(ft_pac_ftf_2)
```

###### purpose: FTM - had to break up into pieces
```{r}
### restrict 
ft_pac_ftm <- ft_pac %>%
  filter(PURPOSE_CO == "FTM") 

table(ft_pac_ftm$TREATMENT_)

### run for mpb
ft_pac_ftm_mp <- ft_pac_ftm %>%
  filter(TREATMENT_ == "Machine Pile Burn") 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_ftm_mp$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_ftm_mp[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_ftm_mp$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_ftm_mp_treat_burn <- ft_pac_ftm_mp[1, ]
pac_ftm_mp_treat_burn <- pac_ftm_mp_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_ftm_mp_treat_burn) <- NULL

### drop cols
pac_ftm_mp_treat_burn <- pac_ftm_mp_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_ftm_mp_treat_burn <- pac_ftm_mp_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_ftm_mp_treat_burn <- rbind(pac_ftm_mp_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_ftm_mp_treat_burn <- pac_ftm_mp_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_ftm_mp_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_1.csv")

rm(ft_pac_ftm_mp, pac_ftm_mp_treat_burn)

### 105 fuel treatments burned

########################
########################

table(ft_pac_ftm$TREATMENT_)

### run for mpb
ft_pac_ftm_mpp <- ft_pac_ftm %>%
  filter(TREATMENT_ == "Machine Pile") 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_ftm_mpp$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_ftm_mpp[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_ftm_mpp$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_ftm_mpp_treat_burn <- ft_pac_ftm_mpp[1, ]
pac_ftm_mpp_treat_burn <- pac_ftm_mpp_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_ftm_mpp_treat_burn) <- NULL

### drop cols
pac_ftm_mpp_treat_burn <- pac_ftm_mpp_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_ftm_mpp_treat_burn <- pac_ftm_mpp_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_ftm_mpp_treat_burn <- rbind(pac_ftm_mpp_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_ftm_mpp_treat_burn <- pac_ftm_mpp_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_ftm_mpp_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_2.csv")

### 200 fuel treatments burned

# ### combine and write out
# pca_ftm_2 <- rbind(pac_ftm_mp_treat_burn,
#                    pac_ftm_mpp_treat_burn)
# write_csv(pca_ftm_2,
#           "E:/usda_2023/usfs_fuel_treatments/western_us/pacific_burned_ftm_1.csv")

########################
########################

table(ft_pac_ftm$TREATMENT_)

### run for Thinning in california
ft_pac_ftm_thin_ca <- ft_pac_ftm %>%
  filter(TREATMENT_ == "Thinning" &
           STATE_ABBR == "CA") 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_ftm_thin_ca$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_ftm_thin_ca[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_ftm_thin_ca$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_ftm_thin_treat_burn <- ft_pac_ftm_thin_ca[1, ]
pac_ftm_thin_treat_burn <- pac_ftm_thin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_ftm_thin_treat_burn) <- NULL

### drop cols
pac_ftm_thin_treat_burn <- pac_ftm_thin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_ftm_thin_treat_burn <- pac_ftm_thin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_ftm_thin_treat_burn <- rbind(pac_ftm_thin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_ftm_thin_treat_burn <- pac_ftm_thin_treat_burn %>%
  filter(!ft_id == "empty")

### 651 treatments burned

write_csv(pac_ftm_thin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_3.csv")

########################
########################

### run for Thinning NOT in california
ft_pac_ftm_thin_ow <- ft_pac_ftm %>%
  filter(TREATMENT_ == "Thinning" &
           STATE_ABBR %in% c("OR", "WA")) 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_ftm_thin_ow$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_ftm_thin_ow[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_ftm_thin_ow$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_ftm_thin_treat_burn <- ft_pac_ftm_thin_ow[1, ]
pac_ftm_thin_treat_burn <- pac_ftm_thin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_ftm_thin_treat_burn) <- NULL

### drop cols
pac_ftm_thin_treat_burn <- pac_ftm_thin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_ftm_thin_treat_burn <- pac_ftm_thin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_ftm_thin_treat_burn <- rbind(pac_ftm_thin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_ftm_thin_treat_burn <- pac_ftm_thin_treat_burn %>%
  filter(!ft_id == "empty")

### 651 treatments burned

write_csv(pac_ftm_thin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_4.csv")

################
################
################

table(ft_pac_ftm$TREATMENT_)

### run for the rest of the treatments
ft_pac_ftm_remain <- ft_pac_ftm %>%
  filter(!TREATMENT_ %in% c("Thinning",
                            "Machine Pile",
                            "Machine Pile Burn")) 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_ftm_remain$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_ftm_remain[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_ftm_remain$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_ftm_remain_treat_burn <- ft_pac_ftm_remain[1, ]
pac_ftm_remain_treat_burn <- pac_ftm_remain_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_ftm_remain_treat_burn) <- NULL

### drop cols
pac_ftm_remain_treat_burn <- pac_ftm_remain_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_ftm_remain_treat_burn <- pac_ftm_remain_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_ftm_remain_treat_burn <- rbind(pac_ftm_remain_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_ftm_remain_treat_burn <- pac_ftm_remain_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_ftm_remain_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_5.csv")

### 250 treatments burned

# ### open all ftm csvs
# p1 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_1.csv")
# p2 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_2.csv")
# p3 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_3.csv")
# p4 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_4.csv")
# p5 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_5.csv")
# 
# ### combine and write out
# pac_ftm_all <- rbind(p1, p2, p3, p4, p5)
# 
# write_csv(pac_ftm_all,
#           "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_all.csv")
rm(store_intersect_all, pac_ftm_all, pac_ftm_mp_treat_burn, pac_ftm_mpp_treat_burn,
   pac_ftm_remain_treat_burn)
```

###### purpose: FTI, Machine pile, machine pile burn, biomass removal
```{r}
### open ft 
ft_pac <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_treatments.shp")

### Add date cols for treatments, restrict years
ft_pac <- ft_pac %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL)) %>%
  filter(year_comp > 1983)

### restrict 
ft_pac_fti <- ft_pac %>%
  filter(PURPOSE_CO == "FTI") 

table(ft_pac_fti$TREATMENT_)

 #   Biomass Removal     Broadcast Burn           Chipping           Crushing 
 #              2708                701                359                380 
 #          Fire Use       Jackpot Burn    Lop and Scatter       Machine Pile 
 #                91                 77               1573               6837 
 # Machine Pile Burn Mastication/Mowing                N/A           Thinning 
 #              4308                 22                  2              15368 

### run for mp in oregon
ft_pac_fti_mp_or <- ft_pac_fti %>%
  filter(TREATMENT_ == "Machine Pile" &
           STATE_ABBR == "OR") 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_mp_or$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_mp_or[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_mp_or$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_mp_treat_burn <- ft_pac_fti_mp_or[1, ]
pac_fti_mp_treat_burn <- pac_fti_mp_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_mp_treat_burn) <- NULL

### drop cols
pac_fti_mp_treat_burn <- pac_fti_mp_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_mp_treat_burn <- pac_fti_mp_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_mp_treat_burn <- rbind(pac_fti_mp_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_mp_treat_burn <- pac_fti_mp_treat_burn %>%
  filter(!ft_id == "empty")

# rm(ft_pac_fti_mp)

### 290 fuel treatments burned
write_csv(pac_fti_mp_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_machpile_1.csv")

###################
####################
### run for mp in ca and wash
ft_pac_fti_mp_cw <- ft_pac_fti %>%
  filter(TREATMENT_ == "Machine Pile" &
           STATE_ABBR %in% c("CA", "WA")) 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_mp_cw$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_mp_cw[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_mp_cw$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_mp_treat_burn <- ft_pac_fti_mp_cw[1, ]
pac_fti_mp_treat_burn <- pac_fti_mp_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_mp_treat_burn) <- NULL

### drop cols
pac_fti_mp_treat_burn <- pac_fti_mp_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_mp_treat_burn <- pac_fti_mp_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_mp_treat_burn <- rbind(pac_fti_mp_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_mp_treat_burn <- pac_fti_mp_treat_burn %>%
  filter(!ft_id == "empty")

# rm(ft_pac_fti_mp)

### 290 fuel treatments burned
write_csv(pac_fti_mp_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_machpile_2.csv")

########################
########################

table(ft_pac_fti$TREATMENT_)

 #   Biomass Removal     Broadcast Burn           Chipping           Crushing 
 #              2708                701                359                380 
 #          Fire Use       Jackpot Burn    Lop and Scatter       Machine Pile 
 #                91                 77               1573               6837 
 # Machine Pile Burn Mastication/Mowing                N/A           Thinning 
 #              4308                 22                  2              15368 

### run for mpb
ft_pac_fti_mpb <- ft_pac_fti %>%
  filter(TREATMENT_ == "Machine Pile Burn") 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_mpb$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_mpb[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_mpb$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_mpb_treat_burn <- ft_pac_fti_mpb[1, ]
pac_fti_mpb_treat_burn <- pac_fti_mpb_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_mpb_treat_burn) <- NULL

### drop cols
pac_fti_mpb_treat_burn <- pac_fti_mpb_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_mpb_treat_burn <- pac_fti_mpb_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_mpb_treat_burn <- rbind(pac_fti_mpb_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_mpb_treat_burn <- pac_fti_mpb_treat_burn %>%
  filter(!ft_id == "empty")

### 300 fuel treatments burned

write_csv(pac_fti_mpb_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_machpileburn.csv")

########################
########################

table(ft_pac_fti$TREATMENT_)

### run for biomass removal
ft_pac_fti_biomass <- ft_pac_fti %>%
  filter(TREATMENT_ == "Biomass Removal") 

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_biomass$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_biomass[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_biomass$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_biomass_treat_burn <- ft_pac_fti_biomass[1, ]
pac_fti_biomass_treat_burn <- pac_fti_biomass_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_biomass_treat_burn) <- NULL

### drop cols
pac_fti_biomass_treat_burn <- pac_fti_biomass_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_biomass_treat_burn <- pac_fti_biomass_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_biomass_treat_burn <- rbind(pac_fti_biomass_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_biomass_treat_burn <- pac_fti_biomass_treat_burn %>%
  filter(!ft_id == "empty")

### 208 fuel treatments burned

write_csv(pac_fti_biomass_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_biomass_removal.csv")

rm(ft_pac_fti_biomass,
   pac_fti_biomass_treat_burn)
rm(store_intersect_all, mtbs_n_temp)
gc()
########################
########################

table(ft_pac_fti$TREATMENT_)

### run for thinning
ft_pac_fti_thin <- ft_pac_fti %>%
  filter(TREATMENT_ == "Thinning") 

### there are a lot of thinning treatments!
table(ft_pac_fti_thin$ACTIVITY)
#                                          Commercial Thin 
#                                                     6387 
#                                               Fuel Break 
#                                                       235 
#                                       Precommercial Thin 
#                                                     9146 
#                        Precommercial thinning for visual 
#                                                       22 
#                                                    Prune 
#                                                      428 
# Pruning to Raise Canopy Height and Discourage Crown Fire 
#                                                      829 
#   Salvage Cut (intermediate treatment, not regeneration) 
#                                                      1077 
#                                           Sanitation Cut 
#                                                      111 
#                    Site Preparation for Planting - Other 
#                                                       43 
#                   Thinning for Hazardous Fuels Reduction 
#                                                     2034 
#                                    Tree Release and Weed 
#                                                      385 
#                        Wildlife Habitat Intermediate cut 
#                                                        6 
#                  Wildlife Habitat Precommercial thinning 
#                                                      124 

rm(ft_pac_fti_thin)
```

##### purpose: FTI Thinning, Activity = Thinning for Hazardous Fuels Reduction
```{r}
### run for Thinning for Hazardous Fuels Reduction
ft_pac_fti_thin_haz <- ft_pac_fti %>%
  filter(TREATMENT_ == "Thinning") %>%
  filter(ACTIVITY == "Thinning for Hazardous Fuels Reduction")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_thin_haz$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_thin_haz[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_thin_haz$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_thinhaz_treat_burn <- ft_pac_fti_thin_haz[1, ]
pac_fti_thinhaz_treat_burn <- pac_fti_thinhaz_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_thinhaz_treat_burn) <- NULL

### drop cols
pac_fti_thinhaz_treat_burn <- pac_fti_thinhaz_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_thinhaz_treat_burn <- pac_fti_thinhaz_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_thinhaz_treat_burn <- rbind(pac_fti_thinhaz_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_thinhaz_treat_burn <- pac_fti_thinhaz_treat_burn %>%
  filter(!ft_id == "empty")

### 387 fuel treatments burned

write_csv(pac_fti_thinhaz_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_hazfuel_thin.csv")

rm(pac_fti_thinhaz_treat_burn, ft_pac_fti_thin_haz,
   store_intersect_all)
gc()
```

##### purpose: FTI thinning, Activity = Commerical thin
```{r}
### commercial thinning
ft_pac_fti_commthin <- ft_pac_fti %>%
  filter(TREATMENT_ == "Thinning") %>%
  filter(ACTIVITY == "Commercial Thin")

### oregon
ft_pac_fti_commthin_or <- ft_pac_fti_commthin %>%
  filter(STATE_ABBR == "OR")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_commthin_or$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_commthin_or[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_commthin_or$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_fti_commthin_or[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

### 387 fuel treatments burned

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_comm_thin_1.csv")

rm(pac_fti_commthin_treat_burn, ft_pac_fti_commthin,
   store_intersect_all)
gc()
########################
########################

### CA and WASH
ft_pac_fti_commthin_cw <- ft_pac_fti_commthin %>%
  filter(!STATE_ABBR == "OR")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_commthin_cw$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_commthin_cw[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_commthin_cw$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_fti_commthin_cw[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_comm_thin_2.csv")

rm(pac_fti_commthin_treat_burn, ft_pac_fti_commthin,
   store_intersect_all)
gc()
```

##### purpose: FTI Thinning, Activity = pre-commerical thin
```{r}
### pre-commercial thins
ft_pac_fti_pct_or <- ft_pac_fti %>%
  filter(TREATMENT_ == "Thinning" &
           ACTIVITY == "Precommercial Thin") %>%
  filter(STATE_ABBR == "OR")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_pct_or$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_pct_or[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_pct_or$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_fti_pct_or[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

### 387 fuel treatments burned

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_pct_1.csv")

rm(pac_fti_commthin_treat_burn, ft_pac_fti_commthin,
   store_intersect_all)
gc()
########################
########################

### CA and WASH
ft_pac_fti_pct_cw <- ft_pac_fti %>%
  filter(TREATMENT_ == "Thinning" &
           ACTIVITY == "Precommercial Thin") %>%
  filter(!STATE_ABBR == "OR")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_pct_cw$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_pct_cw[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_pct_cw$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_fti_pct_cw[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_pct_2.csv")

rm(pac_fti_commthin_treat_burn, ft_pac_fti_commthin,
   store_intersect_all)
gc()
```
##### purpose: FTI thinning, remaining activities
```{r}
ft_pac_fti_thinning <- ft_pac_fti %>%
  filter(TREATMENT_ == "Thinning") %>%
  filter(!ACTIVITY %in% c("Commercial Thin",
                          "Precommercial Thin",
                          "Thinning for Hazardous Fuels Reduction"))

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_thinning$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_thinning[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_thinning$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_fti_thinning[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_remain_thinn.csv")

rm(pac_fti_commthin_treat_burn, ft_pac_fti_commthin,
   store_intersect_all)
gc()
```

##### purpose: FTI, remaining activities
Not Biomass Removal, Machine Pile, Machine Pile Burn,  Thinning
```{r}
ft_pac_fti_remain <- ft_pac_fti %>%
  filter(!TREATMENT_ %in% c("Biomass Removal", 
                            "Machine Pile", 
                            "Machine Pile Burn",  
                            "Thinning"))

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_fti_remain$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_fti_remain[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_fti_remain$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_fti_remain[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_remaining.csv")
```

##### purpose: NA
```{r}
### open ft 
ft_pac <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_treatments.shp")

### Add date cols for treatments
ft_pac <- ft_pac %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL))

### drop treatments that were completed before mtbs time series
ft_pac <- ft_pac %>%
  filter(year_comp > 1983)

### restrict to PURPOSE = NA
ft_pac_na <- ft_pac %>%
  filter(is.na(PURPOSE_CO))

### What are all these treatments?
table(ft_pac_na$TREATMENT_)

###    Biomass Removal     Broadcast Burn           Chipping 
#               5137               3988               2567 
#           Crushing           Fire Use       Jackpot Burn 
#               1320                267                450 
#    Lop and Scatter       Machine Pile  Machine Pile Burn 
#               3250              11300              11983 
# Mastication/Mowing                N/A           Thinning 
#                 35                323              30757 
```

##### purpose: NA, TREATMENT_ = Chipping
```{r}
### restrict to TREATMENT_ = Chipping
ft_pac_na_ch <- ft_pac_na %>%
  filter(TREATMENT_ == "Chipping")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_ch$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_ch[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_ch$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_ch[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_chipping.csv")

rm(ft_pac_na_ch, pac_fti_commthin_treat_burn, 
   store_intersect_all, mtbs_n_temp)
gc()
```

##### purpose: NA, TREATMENT_ = Lop and Scatter
```{r}
### restrict to TREATMENT_ = Chipping
ft_pac_na_ls <- ft_pac_na %>%
  filter(TREATMENT_ == "Lop and Scatter")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_ls$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_ls[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_ls$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_ls[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_lopscat.csv")
```

##### purpose: NA, TREATMENT_ = Broadcast Burn
```{r}
### restrict to TREATMENT_ = Chipping
ft_pac_na_bb <- ft_pac_na %>%
  filter(TREATMENT_ == "Broadcast Burn")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_bb$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_bb[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_bb$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_bb[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_bb.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_bb)
gc()
```
##### purpose: NA, TREATMENT_ = Biomass Removal
```{r}
### restrict to TREATMENT_ = Biomass Removal
ft_pac_na_br <- ft_pac_na %>%
  filter(TREATMENT_ == "Biomass Removal")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_br$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_br[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_br$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_br[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_br.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_bb)
gc()
```
##### purpose: NA, TREATMENT_ = crushing, fire use, jackpot burn, mastication
```{r}
### restrict to TREATMENT_ = Biomass Removal
ft_pac_na_misc <- ft_pac_na %>%
  filter(TREATMENT_ %in% c("Crushing", "Fire Use",
                           "Jackpot Burn", "Mastication/Mowing"))

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_misc$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_misc[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_misc$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_misc[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_misc.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_bb)
gc()
```

##### purpose: NA, TREATMENT_ = NA
```{r}
### restrict to TREATMENT_ = Biomass Removal
ft_pac_na_na <- ft_pac_na %>%
  filter(TREATMENT_ == "N/A" | is.na(TREATMENT_))

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_na$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_na[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_na$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_na[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_na.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_na)
gc()
```

###### purpose: NA, TREATMENT_ = Machine Pile (11300),
```{r}
### restrict to TREATMENT_ = Machine Pile, Oregon
ft_pac_na_mp_or <- ft_pac_na %>%
  filter(TREATMENT_ == "Machine Pile" & STATE_ABBR == "OR")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_mp_or$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_mp_or[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_mp_or$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_mp_or[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_mp_or.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_mp_or)
gc()

################################################
################################################
### restrict to TREATMENT_ = Machine Pile, CA and WA
ft_pac_na_mp_cw <- ft_pac_na %>%
  filter(TREATMENT_ == "Machine Pile" & 
           STATE_ABBR %in% c("CA", "WA"))

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_mp_cw$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_mp_cw[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_mp_cw$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_mp_cw[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_mp_cw.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_mp_cw)
gc()
```

###### purpose: NA, TREATMENT_ = Machine Pile Burn (11983),
```{r}
### check states per machine pile burn
ft_pac_na_mpb <- ft_pac_na %>%
  filter(TREATMENT_ == "Machine Pile Burn")

#   CA   OR   WA 
# 5338 5425 1220 

### restrict to TREATMENT_ = Machine Pile, Washington
ft_pac_na_mpb_w <- ft_pac_na_mpb %>%
  filter(STATE_ABBR == "WA")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_mpb_w$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_mpb_w[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_mpb_w$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_mpb_w[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_mpb_w.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_mp_w)
gc()

################################################
################################################

### machine pile burn in CA and OR
ft_pac_na_mpb <- ft_pac_na_mpb %>%
  filter(!STATE_ABBR == "WA")

### restrict to before 2009
ft_pac_na_mpb_2009 <- ft_pac_na_mpb %>%
  filter(year_comp < 2009)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_mpb_2009$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_mpb_2009[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_mpb_2009$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_mpb_2009[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_mpb_2009.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_mpb_2009)
gc()

################################################
################################################

### restrict to 2009-2010
ft_pac_na_mpb_2010 <- ft_pac_na_mpb %>%
  filter(year_comp > 2008 & year_comp < 2011)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_mpb_2010$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_mpb_2010[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_mpb_2010$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_mpb_2010[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_mpb_2010.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_mpb_2010)
gc()

################################################
################################################

### restrict to 2011-2013
ft_pac_na_mpb_2013 <- ft_pac_na_mpb %>%
  filter(year_comp %in% c("2011", "2012", "2013"))

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_mpb_2013$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_mpb_2013[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_mpb_2013$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_mpb_2013[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_mpb_2013.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_mpb_2013)
gc()

################################################
################################################

### restrict to 2014-15
ft_pac_na_mpb_2014 <- ft_pac_na_mpb %>%
  filter(year_comp > 2013)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_mpb_2014$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_mpb_2014[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_mpb_2014$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_mpb_2014[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_mpb_2014.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_mpb_2014)
gc()
```

##### purpose: NA, TREATMENT_ = Thinning (30757)
```{r}
### restrict to TREATMENT_ = Thinning
ft_pac_na_thin <- ft_pac_na %>%
  filter(TREATMENT_ == "Thinning")

### natural breaks?
table(ft_pac_na_thin$STATE_ABBR)
#    CA    OR    WA 
# 10855 16231  3671 

### run for washington only
ft_pac_na_thin_wa <- ft_pac_na_thin %>%
  filter(STATE_ABBR == "WA")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_thin_wa$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_thin_wa[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_thin_wa$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_thin_wa[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_w.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_thin_wa)
gc()

####################
#######################
########################

### drop washington
ft_pac_na_thin_co <- ft_pac_na_thin %>%
  filter(!STATE_ABBR == "WA")

### before 2008
ft_pac_na_thin_co_2007 <- ft_pac_na_thin_co %>%
  filter(year_comp < 2008)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_thin_co_2007$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_thin_co_2007[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_thin_co_2007$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_thin_co_2007[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2007.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_thin_co_2007)
gc()

####################
#######################
########################

### 2008
ft_pac_na_thin_co_2008 <- ft_pac_na_thin_co %>%
  filter(year_comp == 2008)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_thin_co_2008$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_thin_co_2008[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_thin_co_2008$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_thin_co_2008[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2008.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_thin_co_2008)
gc()
```

##### purpose: NA, TREATMENT_ Thinning (30757) post-2008
```{r}
### 2009 only
ft_pac_na_thin_co_2009 <- ft_pac_na_thin_co %>%
  filter(year_comp == 2009)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_thin_co_2009$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_thin_co_2009[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_thin_co_2009$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_thin_co_2009[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2009.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_thin_co_2009)
gc()

#####################
###########################
##############################3

### 2010 only
ft_pac_na_thin_co_2010 <- ft_pac_na_thin_co %>%
  filter(year_comp == 2010)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_thin_co_2010$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_thin_co_2010[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_thin_co_2010$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_thin_co_2010[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2010.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_thin_co_2010)
gc()

#####################
###########################
##############################3

### 2011 only
ft_pac_na_thin_co_2011 <- ft_pac_na_thin_co %>%
  filter(year_comp == 2011)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_thin_co_2011$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_thin_co_2011[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_thin_co_2011$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_thin_co_2011[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2011.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_thin_co_2011)
gc()

#####################
###########################
##############################3

### 2012 only
ft_pac_na_thin_co_2012 <- ft_pac_na_thin_co %>%
  filter(year_comp == 2012)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_thin_co_2012$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_thin_co_2012[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_thin_co_2012$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_thin_co_2012[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2012.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_thin_co_2012)
gc()

#####################
###########################
##############################3

### 2013 only
ft_pac_na_thin_co_2013 <- ft_pac_na_thin_co %>%
  filter(year_comp == 2013)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_thin_co_2013$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_thin_co_2013[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_thin_co_2013$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_thin_co_2013[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2013.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_thin_co_2013)
gc()

#####################
###########################
##############################3

### 2014 only
ft_pac_na_thin_co_2014 <- ft_pac_na_thin_co %>%
  filter(year_comp == 2014)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_thin_co_2014$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_thin_co_2014[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_thin_co_2014$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_thin_co_2014[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2014.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_thin_co_2014)
gc()

#####################
###########################
##############################3

### after 2014 
ft_pac_na_thin_co_2015 <- ft_pac_na_thin_co %>%
  filter(year_comp > 2014)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac_na_thin_co_2015$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac_na_thin_co_2015[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_pac %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac_na_thin_co_2015$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
pac_fti_commthin_treat_burn <- ft_pac_na_thin_co_2015[1, ]
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(pac_fti_commthin_treat_burn) <- NULL

### drop cols
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    pac_fti_commthin_treat_burn <- rbind(pac_fti_commthin_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
pac_fti_commthin_treat_burn <- pac_fti_commthin_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(pac_fti_commthin_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2015.csv")

rm(pac_fti_commthin_treat_burn, store_intersect_all, mtbs_n_temp,
   ft_pac_na_thin_co_2015)
gc()
```


###### combine pacific
```{r}
### open all csvs
pac_other_treat_burn <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_other.csv")
pac_ftf_1 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftf_1.csv")
pac_ftf_2 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftf_2.csv")
pac_ftm_1 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_1.csv")
pac_ftm_2 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_2.csv")
pac_ftm_3 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_3.csv")
pac_ftm_4 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_4.csv")
pac_ftm_5 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ftm_5.csv")
pac_fti_machinepile_1 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_machpile_1.csv")
pac_fti_machinepile_2 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_machpile_2.csv")
pac_fti_mpburn <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_machpileburn.csv")
pac_fti_biomassremoval <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_biomass_removal.csv")
pac_fti_thinhaz <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_hazfuel_thin.csv")
pac_fti_commthin_1 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_comm_thin_1.csv")
pac_fti_commthin_2 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_comm_thin_2.csv")
pac_ft_precthin_1 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_pct_1.csv")
pac_fti_precthin_2 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_pct_2.csv")
pac_fti_other <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_fti_remain_thinn.csv")
pac_fti_na_chip <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_chipping.csv")
pac_fti_na_lop <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_lopscat.csv")
pac_fti_na_broadcast <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_bb.csv")
pac_fti_na_biomass <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_br.csv")
pac_fti_na_misc <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_misc.csv")
pac_fti_na_na <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_na.csv")
pac_fti_na_mp_1 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_mp_or.csv")
pac_fti_na_mp_2 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_mp_cw.csv")
pac_fti_na_mpb_1 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_mpb_w.csv")
pac_fti_na_mpb_2 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_mpb_2009.csv")
pac_fti_na_mpb_3 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_mpb_2010.csv")
pac_fti_na_mpb_4 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_mpb_2013.csv")
pac_fti_na_mpb_5 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_mpb_2014.csv")
pac_fti_na_thin_1 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_w.csv")
pac_fti_na_thin_2 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2007.csv")
pac_fti_na_thin_3 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2008.csv")
pac_fti_na_thin_4 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2009.csv")
pac_fti_na_thin_5 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2010.csv")
pac_fti_na_thin_6 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2011.csv")
pac_fti_na_thin_7 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2012.csv")
pac_fti_na_thin_8 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2013.csv")
pac_fti_na_thin_9 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2014.csv")
pac_fti_na_thin_10 <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_na_thin_co_2015.csv")

### identify all dfs in environment
df_env <- sapply(.GlobalEnv, is.data.frame)

### combine
all_pac <- do.call(rbind, mget(names(df_env)[df_env]))

### write out
write_csv(all_pac,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ft_all.csv")
```


### combine all regions
```{r}
### open northern, sw, and pacific (none of the adj burned)
n_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/n_burned_ft_all.csv")
sw_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/sw_burned_ft_all.csv")
pac_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/pacific_burned_ft_all.csv")

### combine all
all_fts <- rbind(n_fts,
                 sw_fts,
                 pac_fts)

### write out
write_csv(all_fts,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fts_w_us.csv")
```

### treatment footprints without wildfire treatments 
ex. Wildfire - Human Ignition, Wildland Fire Use
Don't need to re-run from old code -- output will be the same

file = "E:/usda_2023/usfs_fuel_treatments/western_us/all_treatments_non_wf.shp"

## Burned treatment footprints (take 1)
Did this before I re-did the loop to catch stray burned FTs
```{r}
### Open csv of all burned footprints
all_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fts_w_us.csv")

### Open all MTBS fires, including 2021 and 2022
mtbs_all <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_1984_2022_west.shp")

### restrict to fires that subsequently burned fuel treatments
mtbs_all <- mtbs_all %>% 
  filter(Event_ID %in% all_fts$Event_ID)
st_write(mtbs_all,
          "E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_1984_2022_fuel_treats.shp")

### Open fuel treatment database
ft <- st_read("E:/usda_2023/usfs_fuel_treatments/S_USA.Activity_HazFuelTrt_PL.shp") %>%
  mutate(., ft_id = row_number())

### restrict to fuel treatments that subsequently burned
ft_burned <- ft %>%
  filter(ft_id %in% all_fts$ft_id)

### are some of the fuel treatments in the burned dataset more than once?
length(unique(all_fts$ft_id))
### yes!

### add sf to ft's
ft_burned_shp <- ft_burned %>%
  dplyr::select(ft_id,
                STATE_ABBR,
                ACTIVITY_C,
                ACTIVITY,
                TREATMENT_,
                TREATMENT1,
                geometry)
st_write(ft_burned_shp,
         "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fuel_treats.shp")

### Make table of activity counts by state
ft_burned_csv <- ft_burned_shp 
st_geometry(ft_burned_csv) <- NULL
ft_burned_summ <- ft_burned_csv %>%
  group_by(STATE_ABBR,
           ACTIVITY) %>%
  summarise(treatment_count = length(unique(ft_id)))
write_csv(ft_burned_csv,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/ft_summary.csv")

### limit to CA and CO
ca_co_summ <- ft_burned_summ %>%
  filter(STATE_ABBR %in% c("CO", "CA"))
write_csv(ca_co_summ,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/ft_summary_ca_co.csv")
```

## Treatments that might have been missed in loops
```{r}
### burned treatments
ft_burned <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fuel_treats.shp")

### all fuel treatment footprints (minus wildfire ones)
all_fts <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/all_treatments_non_wf.shp")

### filter out treatments that I know burned
all_fts_unb <- all_fts %>%
  filter(!ft_id %in% ft_burned$ft_id)

# st_write(all_fts_unb,
#          "E:/usda_2023/usfs_fuel_treatments/western_us/fts_to_check.shp")

### remove intermediates
rm(all_fts, ft_burned)

### do some of the fuel treatments overlap with MTBS (regardless of temporal sequence?)

### open mtbs
mtbs <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_1984_2022_fuel_treats.shp")

### subset to ft's within MTBS borders
fts_mtbs <- st_intersection(all_fts_unb,
                            mtbs)

length(unique(all_fts_unb$ft_id)) ## 188215
length(unique(fts_mtbs$ft_id))    ## 16061

### get full polygons for footprints that overlap
fts_mtbs_comp <- all_fts_unb %>%
  filter(ft_id %in% fts_mtbs$ft_id)

rm(all_fts_unb, fts_mtbs)

### table
table(fts_mtbs_comp$PURPOSE_CO)

# FIRE  FTF  FTI  FTM FUEL   RF TMBR  TSI WILD 
# 1057 1604 8066 2544    2    1    8    6    6 

### Add date cols for treatments
fts_mtbs_comp <- fts_mtbs_comp %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL))
```
#### loop through for subsequent fires
##### FTM 
```{r}
### subset
ftm <- fts_mtbs_comp %>%
  filter(PURPOSE_CO == "FTM")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ftm$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ftm[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ftm$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- ftm[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

### 0 treatments burned

# write_csv(other_treat_burn,
#           "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/second_loop_1.csv")
```

##### FTF
```{r}
### subset
ftf <- fts_mtbs_comp %>%
  filter(PURPOSE_CO == "FTF")

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ftf$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ftf[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ftf$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- ftf[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

### 0 fuel treatments burned

# write_csv(other_treat_burn,
#           "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/second_loop_2.csv")
```

##### not NA, FTF, FTI, or FTM
```{r}
### subset
ft_other <- fts_mtbs_comp %>%
  filter(!PURPOSE_CO %in% c("FTF", "FTM", "FTI")) %>%
  filter(!is.na(PURPOSE_CO))

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_other$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_other[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_other$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- ft_other[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

### 12 fuel treatments burned

write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/second_loop_1.csv")
```

##### FTI
```{r}
### subset
fti <- fts_mtbs_comp %>%
  filter(PURPOSE_CO == "FTI") 

### fti overlap with mtbs
fti_mtbs <- st_intersection(mtbs, fti)

### restrict mtbs to these
mtbs_fti <- mtbs %>%
  filter(Event_ID %in% fti_mtbs$Event_ID)
rm(fti_mtbs)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(fti$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- fti[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_fti %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(fti$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- fti[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

### 463 fuel treatments burned

write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/second_loop_2.csv")

```

##### purpose code = NA
```{r}
### subset
pc_na <- fts_mtbs_comp %>%
  filter(is.na(PURPOSE_CO)) 

### pc_na overlap with mtbs
pc_na_mtbs <- st_intersection(mtbs, pc_na)

### restrict mtbs to these
mtbs_na <- mtbs %>%
  filter(Event_ID %in% pc_na_mtbs$Event_ID)
rm(pc_na_mtbs)

### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(pc_na$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- pc_na[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- mtbs_na %>%
    filter(Ig_Date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(pc_na$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- pc_na[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(Event_ID = NA, 
         Incid_Type = NA, 
         Ig_Date = NA,
         date = NA, month = NA, year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  Event_ID, Incid_Type, 
                  Ig_Date,
                  date, month, year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/second_loop_3.csv")
```

#### combine second round of loops
```{r}
### list files
loop_files <- list.files(path = "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/",
                        pattern = "^second_loop_",
                        full.names = TRUE)

### open them
loop_files <- lapply(loop_files, read.csv)

### combine
loop_files <- do.call("rbind", loop_files)

### write out
write_csv(loop_files,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/remaining_burned_fts.csv")

### open original with full dataset
all_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fts_w_us.csv")

### combine
all_fts <- rbind(all_fts,
                 loop_files)

### write out
write_csv(all_fts,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fts_w_us_updated.csv")
```

## Burned treatment footprints (take 2)
Now redo the "Burned treatment footprints" chunk with the additional burned FTs
```{r}
### Open csv of all burned footprints
all_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fts_w_us_updated.csv") 

### Open all MTBS fires
mtbs_all <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_through_2022/mtbs_perims_DD.shp")

### restrict to fires that subsequently burned fuel treatments
mtbs_all <- mtbs_all %>% 
  filter(Event_ID %in% all_fts$Event_ID)
st_write(mtbs_all,
          "E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_through_2022/mtbs_fuel_treats_updated.shp")

### Open fuel treatment database
ft <- st_read("E:/usda_2023/usfs_fuel_treatments/S_USA.Activity_HazFuelTrt_PL.shp") %>%
  mutate(., ft_id = row_number())

### restrict to fuel treatments that subsequently burned
ft_burned <- ft %>%
  filter(ft_id %in% all_fts$ft_id)

### are some of the fuel treatments in the burned dataset more than once?
length(unique(all_fts$ft_id))
### yes! 

### add sf to ft's
ft_burned_shp <- ft_burned %>%
  dplyr::select(ft_id,
                STATE_ABBR,
                ACTIVITY_C,
                ACTIVITY,
                TREATMENT_,
                TREATMENT1,
                geometry)

### reproject
ft_burned_shp <- ft_burned_shp %>%
  st_transform(6350)

### write this out
st_write(ft_burned_shp,
         "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fuel_treats_updated.shp")

### this gives the entire fuel treatment footprint, including parts that did not burn

### Make table of activity counts by state
ft_burned_csv <- ft_burned_shp 
st_geometry(ft_burned_csv) <- NULL
ft_burned_summ <- ft_burned_csv %>%
  group_by(STATE_ABBR,
           ACTIVITY) %>%
  summarise(treatment_count = length(unique(ft_id)))
write_csv(ft_burned_csv,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/ft_summary.csv")

### limit to CA and CO
ca_co_summ <- ft_burned_summ %>%
  filter(STATE_ABBR %in% c("CO", "CA"))
write_csv(ca_co_summ,
          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/ft_summary_ca_co.csv")
```
### Burned footprints subset to fire perimeter
```{r, warning = FALSE}
### Open csv of all burned footprints
all_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fts_w_us_updated.csv") %>%
  distinct()

### Open all MTBS fires that subsequently burned fuel treatments
mtbs_all <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_through_2022/mtbs_fuel_treats_updated.shp")

### Open fuel treatment database
ft <- st_read("E:/usda_2023/usfs_fuel_treatments/S_USA.Activity_HazFuelTrt_PL.shp") %>%
  mutate(., ft_id = row_number())

### restrict to fuel treatments that subsequently burned
ft <- ft %>%
  filter(ft_id %in% all_fts$ft_id)

### add sf to ft's
ft <- ft %>%
  dplyr::select(ft_id,
                STATE_ABBR,
                ACTIVITY_C,
                ACTIVITY,
                TREATMENT_,
                TREATMENT1,
                geometry)

### make valid
ft <- st_make_valid(ft)

### add in info from all_fts
all_fts <- merge(x = ft,
                 y = all_fts,
                 by = "ft_id",
                 all.y = TRUE)
### this gives the entire fuel treatment footprint, including parts that did not burn

# ### ft_id's that appear more than once
# ft_dup <- all_fts
# st_geometry(ft_dup) <- NULL
# ft_dup <- ft_dup %>%
#   group_by(ft_id) %>%
#   summarise(n_rows = n()) %>%
#   filter(n_rows > 1)
# ft_dup <- all_fts %>%
#   filter(ft_id %in% ft_dup$ft_id)
# ### these duplicates burned in more than one fire
# rm(ft_dup)

### I just want the geometry of the part that burned in the wildfire (not the whole fuel treatment footprint)

### clean up
rm(ft)
gc()

### convert geom
all_fts <- all_fts %>%
  st_transform(6350)

### simplify mtbs
mtbs_all <- mtbs_all %>%
  dplyr::select(Event_ID, geometry)

### transform geom
mtbs_all <- mtbs_all %>%
  st_transform(6350)

### get dummy df
temp_ft_dummy <- all_fts[4, ]
temp_mtbs_dummy <- mtbs_all %>%
  filter(Event_ID %in% temp_ft_dummy$Event_ID)
ft_intersect_dummy <- st_intersection(temp_ft_dummy,
                                temp_mtbs_dummy)
ft_intersect_dummy <- ft_intersect_dummy %>%
  dplyr::select(-Event_ID.1)
ft_intersect_dummy$STATE_ABBR[ft_intersect_dummy$STATE_ABBR == "ID"] <- "dummy_row"

### get the overlapping geometry
for (i in 1:nrow(all_fts)) {
# for (i in 7136:nrow(all_fts)) {
# for (i in 1:10) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### subset to that row
  temp_ft <- all_fts[i, ]
  
  ### make valid
  temp_ft <- st_make_valid(temp_ft)
  
  ### subset to fire
  temp_mtbs <- mtbs_all %>%
    filter(Event_ID %in% temp_ft$Event_ID)
  
  ### intersect geom
  ft_intersect <- st_intersection(temp_ft,
                                  temp_mtbs)
  
  ### drop extra col
  ft_intersect <- ft_intersect %>%
    dplyr::select(-Event_ID.1)
  
  ### add it to the df
  ft_intersect_dummy <- rbind(ft_intersect_dummy,
                              ft_intersect)
  ### there can be multiple polygons for each intersection
}

### write out
st_write(ft_intersect_dummy,
         "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fts_polygons.shp")
```

## Wildfires for CBI
Fires I need to add since updating the dataset
```{r}
### Fires I've already done CBI for
cbi_done <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_gee.shp")

### open the original fire perimeters
mtbs <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_through_2022/mtbs_perims_DD.shp") %>%
  st_transform(crs = 6350)

### open treated mtbs in western us
mtbs_burned <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_through_2022/mtbs_fuel_treats_updated.shp")

### these shapefiles have splits at state boundaries, but I want the complete MTBS perimeters (one polygon per fire)

### subset mtbs to fires in fts
mtbs <- mtbs %>%
  filter(Event_ID %in% mtbs_burned$Event_ID)

### subset to fires I don't already have CBI for
mtbs_need <- mtbs %>%
  filter(!Event_ID %in% cbi_done$Fire_ID)

### combine columns 

### prep mtbs_need for merge
st_geometry(mtbs_need) <- NULL
mtbs_need <- mtbs_need %>%
  distinct()

### prep mtbs for merge
mtbs <- mtbs %>%
  dplyr::select(Event_ID, Incid_Type)

### merge
mtbs <- merge(mtbs,
              mtbs_need,
              by = c("Event_ID", "Incid_Type"))

### export fire perimeters for CBI analysis
# - Fire_ID
# - Fire_Year
# - Start_Day (start day of fire season in Julian days)
# - End_Day (end day of fire season in Julian days)

### extract state as column
mtbs <- mtbs %>%
  mutate(state = stringr::str_extract(Event_ID, "^.{2}"))

### Fire seasons
#### In Parks et al. 2019, they use the following seasons:
#### AZ and NM: April 1-June 30 (julian 91-181)
#### CA, ID, MT, OR, UT, WA, WY: June 1-Sept 15 (julian 152-258)
#### assume it's the same for CO, NV
#### use these
# other_julian <- c("CA", "CO", "ID",
#                   "MT", "NV", "OR",
#                   "SD", "TX",
#                   "UT", "WA", "WY")

### use julian fire season dates for CA, ID, MT, OR, UT, WA, WY

### assign julian start and end date based on state dates from Parks et al. 2019
mtbs <- mtbs %>%
  mutate(Start_Day = ifelse(state %in% c("AZ", "NM"), 91, 152),
         End_Day = ifelse(state %in% c("AZ", "NM"), 181, 258))

### add year column
mtbs <- mtbs %>%
  mutate(year = year(Ig_Date))

### Select columns for GEE
### export fire perimeters for CBI analysis
# - Fire_ID
# - Fire_Year
# - Start_Day (start day of fire season in Julian days)
# - End_Day (end day of fire season in Julian days)
mtbs <- mtbs %>%
  dplyr::select(Fire_ID = Event_ID,
                Fire_Year = year,
                Start_Day,
                End_Day,
                Incid_Type,
                geometry)

### Make sure date columns don't get read in with decimals
mtbs$Fire_Year <- as.character(mtbs$Fire_Year, 0)
mtbs$Start_Day <- as.character(mtbs$Start_Day, 0)
mtbs$End_Day <- as.character(mtbs$End_Day, 0)

### Write out shp for gee
st_write(mtbs,
         "E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_through_2022/mtbs_gee.shp")
```

### download CBI from google drive -- they've all run now
```{r}
### folder url
folder_mtbs_url <- "https://drive.google.com/drive/u/1/folders/1IFwCWemfDsJck1qVIVhaHOOdTknP6v5t"

### identify the folder
folder_mtbs <- drive_get(as_id(folder_mtbs_url))

### identify the rasters in that folder
drive_mtbs <- drive_ls(folder_mtbs)

### set download path
mtbs_path <- "E:/fire_sev_rdd/cbi_gee/cbi_gee_mtbs/additional/"

### run through files to download
for (i in seq_along(drive_mtbs$name)) {
  drive_download(
    as_id(drive_mtbs$id[[i]]),
    path = file.path(mtbs_path, drive_mtbs$name[[i]]),
    overwrite = TRUE
  )
}
```

## Update FiredPy
Update to include FiredPy polygons through 2022 (to match updated MTBS). Previous version only had FiredPy polygons through 2021. So just grab the polygons from 2022 from the new FiredPy
```{r}
### open western US firedpy events
firedpy_24 <- st_read("E:/fired_py_data/firedpy_update_2024/fired_conus_ak_2000_to_2024_events.shp")

### restrict years
firedpy_24 <- firedpy_24 %>% 
  filter(ig_year < 2023)

### drop fire perimeters that are definitely not in forests
firedpy_24 <- firedpy_24 %>%
  filter(!lc_name %in% c("Grasslands", "Barren", "Croplands",
                         "Permanent Wetlands", "Water Bodies",
                         "Urban and Built-up Lands", "Permanent Snow and Ice",
                         "Closed Shrublands", "Open Shrublands"))

### transform
firedpy_24 <- firedpy_24 %>%
  st_transform(6350)

### drop fires that are big enough to be included in MTBS (1000 acres or more)
### in firedpy data, tot_ar_km2 = total area burned over course of fire (km2)
firedpy_24 <- firedpy_24 %>%
  mutate(tot_ar_acre = tot_ar_km2 * 247.105) %>%
  filter(tot_ar_acre < 1000)
```

### restrict to conus
```{r}
### open western states
w_borders <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/west_states.shp") %>%
  st_transform(., 6350)

### intersect
firedpy_24_conus <- st_intersection(firedpy_24, w_borders)

### subset firedpy to the IDs in firedpy_24_conus
firedpy_24 <- firedpy_24 %>%
  filter(id %in% firedpy_24_conus$id)

### clean up
rm(firedpy_24_conus)
gc()
```

### spatial divisions
```{r}
### Open northern boundaries
n_bound <- w_borders %>%
  filter(NAME_1 %in% c("Idaho", "Montana", 
                       "Nevada", "Wyoming"))

### Open pacific boundaries
p_bound <- w_borders %>%
  filter(NAME_1 %in% c("California", "Oregon", 
                      "Washington")) 

### Open sw boundaries
s_bound <- w_borders %>%
  filter(NAME_1 %in% c("Arizona", "Utah", 
                      "Colorado", "New Mexico"))

### subset firedpy polygons

### northern
firedpy_north <- st_intersection(firedpy_24, n_bound)
st_write(firedpy_north,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_north_2024.shp")
rm(firedpy_north, n_bound)

### southwest
firedpy_sw <- st_intersection(firedpy_24, s_bound)
st_write(firedpy_sw,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_sw_2024.shp")
rm(firedpy_sw, s_bound)

### pacific
firedpy_p <- st_intersection(firedpy_24, p_bound)
st_write(firedpy_p,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_pac_2024.shp")
rm(firedpy_p, p_bound)
```

### figure out which firedpy polygons are actually just rx fires!
#### northern
```{r}
### open firedpy for north
firedpy_north <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_north_2024.shp")

### open northern ft shp
ft_north <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/northern_treatments.shp") 
  
### filter to rx fires
ft_north <- ft_north %>%
  filter(ACTIVITY %in% c("Underburn - Low Intensity (Majority of Unit)",
                         "Broadcast Burning - Covers a majority of the unit",
                         "Site Preparation for Planting - Burning",
                         "Control of Understory Vegetation- Burning",
                         "Burning of Piled Material",
                         "Jackpot Burning - Scattered concentrations",
                         "Wildlife Habitat Prescribed fire",
                         "Site Preparation for Natural Regeneration - Burning"))

### have any of these overlapped with firedpy perimeters?
ft_north_firedpy <- st_intersection(firedpy_north, ft_north) 

### add year column for ft
ft_north_firedpy <- ft_north_firedpy %>%
  mutate(ft_year = year(DATE_COMPL))

### subset to overlaps in the same year
ft_north_firedpy <- ft_north_firedpy %>%
  filter(ft_year == ig_year)

### 259 instances where there was a firedpy detection that overlapped with a fuel treatment in the same year

### drop these from the firedpy dataset
firedpy_north <- firedpy_north %>%
  filter(!id %in% ft_north_firedpy$id)

### write out
st_write(firedpy_north,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_north_norx.shp")
```

#### southwestern
```{r}
### open firedpy for sw
firedpy_sw <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_sw_2024.shp")

### open northern ft shp
ft_sw <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/sw_treatments.shp") 
  
### filter to rx fires
ft_sw <- ft_sw %>%
  filter(ACTIVITY %in% c("Underburn - Low Intensity (Majority of Unit)",
                         "Broadcast Burning - Covers a majority of the unit",
                         "Site Preparation for Planting - Burning",
                         "Control of Understory Vegetation- Burning",
                         "Burning of Piled Material",
                         "Jackpot Burning - Scattered concentrations",
                         "Wildlife Habitat Prescribed fire",
                         "Site Preparation for Natural Regeneration - Burning",
                         "Natural regeneration - prescribed fire"))

### have any of these overlapped with firedpy perimeters?
ft_sw_firedpy <- st_intersection(firedpy_sw, ft_sw) 

### add year column for ft
ft_sw_firedpy <- ft_sw_firedpy %>%
  mutate(ft_year = year(DATE_COMPL)) %>%
  
  ### subset to overlaps in the same year
  filter(ft_year == ig_year)

### 156 instances where there was a firedpy detection that overlapped with a fuel treatment in the same year

### drop these from the firedpy dataset
firedpy_sw <- firedpy_sw %>%
  filter(!id %in% ft_sw_firedpy$id)

### write out
st_write(firedpy_sw,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_sw_norx.shp")
```

#### pacific
```{r}
### open firedpy for pac
firedpy_pac <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_pac_2024.shp")

### open northern ft shp
ft_pac <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_treatments_all.shp") 
  
### filter to rx fires
ft_pac <- ft_pac %>%
  filter(ACTIVITY %in% c("Underburn - Low Intensity (Majority of Unit)",
                         "Broadcast Burning - Covers a majority of the unit",
                         "Site Preparation for Planting - Burning",
                         "Control of Understory Vegetation- Burning",
                         "Burning of Piled Material",
                         "Jackpot Burning - Scattered concentrations",
                         "Wildlife Habitat Prescribed fire",
                         "Site Preparation for Natural Regeneration - Burning",
                         "Natural regeneration - prescribed fire",
                         "Invasives - Cultural /Fire"))

### have any of these overlapped with firedpy perimeters?
ft_pac_firedpy <- st_intersection(firedpy_pac, ft_pac) 

### add year column for ft
ft_pac_firedpy <- ft_pac_firedpy %>%
  mutate(ft_year = year(DATE_COMPL)) %>%
  
  ### subset to overlaps in the same year
  filter(ft_year == ig_year)

### 2478 instances where there was a firedpy detection that overlapped with a fuel treatment in the same year

### drop these from the firedpy dataset
firedpy_pac <- firedpy_pac %>%
  filter(!id %in% ft_pac_firedpy$id)

### write out
st_write(firedpy_pac,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_pac_norx.shp")
```

#### adjacent
```{r}
### open first ft shp
ft_adj <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/adj_treatments.shp")
  
### filter to rx fires
ft_adj <- ft_adj %>%
  filter(ACTIVITY %in% c("Underburn - Low Intensity (Majority of Unit)",
                         "Broadcast Burning - Covers a majority of the unit",
                         "Site Preparation for Planting - Burning",
                         "Control of Understory Vegetation- Burning",
                         "Burning of Piled Material",
                         "Jackpot Burning - Scattered concentrations",
                         "Wildlife Habitat Prescribed fire",
                         "Site Preparation for Natural Regeneration - Burning",
                         "Natural regeneration - prescribed fire",
                         "Invasives - Cultural /Fire"))

### have any of these overlapped with firedpy perimeters?
ft_adj_firedpy <- st_intersection(firedpy_24, ft_adj) 

### add year column for ft
ft_adj_firedpy <- ft_adj_firedpy %>%
  mutate(ft_year = year(DATE_COMPL)) %>%
  
  ### subset to overlaps in the same year
  filter(ft_year == ig_year)

### 0 instances where there was a firedpy detection that overlapped with a fuel treatment in the same year
```

### overlap firedpy with treatments
after removing rx fires from firedpy dataset
#### ft_adj
```{r}
### open first ft shp
ft_adj <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/adj_treatments.shp")

### filter to out wildfires
ft_adj <- ft_adj %>%
  filter(!ACTIVITY %in% c("Wildland Fire Use",
                          "Wildfire - Human Ignition",
                          "Wildfire - Natural Ignition",
                          "Wildfire - Fuels Benefit"))

### have any of these overlapped with firedpy perimeters?
ft_adj_firedpy <- st_intersection(ft_adj, firedpy_24)

### restrict data sets for speed
ft_adj <- ft_adj %>%
  filter(ft_id %in% ft_adj_firedpy$ft_id)

firedpy_adj <- firedpy_24 %>%
  filter(id %in% ft_adj_firedpy$id)

#### time to loop!
### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_adj$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_adj[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- firedpy_adj %>%
    filter(ig_date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_adj$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- ft_adj[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = NA,
         id = NA, 
         ig_date = NA,
         ig_day = NA, ig_mnth = NA, ig_year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  id, ig_date,
                  ig_day, ig_mnth = ig_month, 
                  ig_year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_ft_burned_adj.csv")
```

#### ft_northern
```{r, warning = FALSE}
### open northern ft shp
ft_north <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/northern_treatments.shp") 
  
### filter to out wildfires
ft_north <- ft_north %>%
  filter(!ACTIVITY %in% c("Wildland Fire Use",
                          "Wildfire - Human Ignition",
                          "Wildfire - Natural Ignition",
                          "Wildfire - Fuels Benefit"))

### open non-rx firedpy
firedpy_n <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_north_norx.shp")

### quick overlap
firedpy_ov <- st_intersection(ft_north,
                              firedpy_n)

### restrict data sets for speed
ft_north <- ft_north %>%
  filter(ft_id %in% firedpy_ov$ft_id)
firedpy_n <- firedpy_n %>%
  filter(id %in% firedpy_ov$id)

#### time to loop!
### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_north$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_north[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- firedpy_n %>%
    filter(ig_date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_north$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- ft_north[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = NA,
         id = NA, 
         ig_date = NA,
         ig_day = NA, ig_mnth = NA, ig_year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  id, ig_date,
                  ig_day, ig_mnth, ig_year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_ft_burned_north.csv")
```

#### sw
```{r, warning = FALSE}
### open northern ft shp
ft_sw <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/sw_treatments.shp") 
  
### filter to out wildfires
ft_sw <- ft_sw %>%
  filter(!ACTIVITY %in% c("Wildland Fire Use",
                          "Wildfire - Human Ignition",
                          "Wildfire - Natural Ignition",
                          "Wildfire - Fuels Benefit",
                          "Planned Treatment Burned in Wildfire"))

### open non-rx firedpy
firedpy_sw <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_sw_norx.shp")

### quick overlap
firedpy_ov <- st_intersection(ft_sw,
                              firedpy_sw)

### restrict data sets for speed
ft_sw <- ft_sw %>%
  filter(ft_id %in% firedpy_ov$ft_id)
firedpy_sw <- firedpy_sw %>%
  filter(id %in% firedpy_ov$id)

#### time to loop!
### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_sw$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_sw[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- firedpy_sw %>%
    filter(ig_date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_sw$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- ft_sw[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = NA,
         id = NA, 
         ig_date = NA,
         ig_day = NA, ig_mnth = NA, ig_year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  id, ig_date,
                  ig_day, ig_mnth, ig_year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_ft_burned_sw.csv")
```

#### pac
```{r, warning = FALSE}
### open northern ft shp
ft_pac <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/pacific_treatments.shp") 
  
### filter to out wildfires
ft_pac <- ft_pac %>%
  filter(!ACTIVITY %in% c("Wildland Fire Use",
                          "Wildfire - Human Ignition",
                          "Wildfire - Natural Ignition",
                          "Wildfire - Fuels Benefit",
                          "Planned Treatment Burned in Wildfire"))

### open non-rx firedpy
firedpy_pac <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_pac_norx.shp")

### quick overlap
firedpy_ov <- st_intersection(ft_pac,
                              firedpy_pac)

### restrict data sets for speed
ft_pac <- ft_pac %>%
  filter(ft_id %in% firedpy_ov$ft_id)
firedpy_pac <- firedpy_pac %>%
  filter(id %in% firedpy_ov$id)

#### time to loop!
### Loop to figure out which treatments burned after treatment
store_intersect_all <- list()

for (i in 1:length(unique(ft_pac$ft_id))) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- ft_pac[i, ]
  
  ### subset to fires that burned after
  mtbs_n_temp <- firedpy_pac %>%
    filter(ig_date > tr_temp$DATE_COMPL)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, mtbs_n_temp)
  
  ### store intersections as a list
  store_intersect_all[[i]] <- list(temp_intersect, unique(ft_pac$ft_id)[i])
  
}

### Now need code to see how many treatments actually burned
### See how many treatments burned
other_treat_burn <- ft_pac[1, ]
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = "empty")

### drop geom
st_geometry(other_treat_burn) <- NULL

### drop cols
other_treat_burn <- other_treat_burn %>%
  dplyr::select(ft_id)

### add cols for merge
other_treat_burn <- other_treat_burn %>%
  mutate(ft_id = NA,
         id = NA, 
         ig_date = NA,
         ig_day = NA, ig_mnth = NA, ig_year = NA)

for (i in 1:length(store_intersect_all)) {
# for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  temp_data <- as.data.frame(store_intersect_all[[i]][[1]])
  
  ### drop geom
  temp_data$geometry <- NULL
  
  ### Subset columns
  temp_data <- temp_data %>%
    dplyr::select(ft_id,
                  id, ig_date,
                  ig_day, ig_mnth, ig_year)
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    other_treat_burn <- rbind(other_treat_burn,
                               temp_data)
  } 
  
}

### drop the empty row
other_treat_burn <- other_treat_burn %>%
  filter(!ft_id == "empty")

### write out
write_csv(other_treat_burn,
          "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_ft_burned_pac.csv")
```

### combine firedpy regions
```{r}
### open firedpy regional csvs
n_fp <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_ft_burned_north.csv")
p_fp <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_ft_burned_pac.csv")
sw_fp <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_ft_burned_sw.csv")
adj_fp <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_ft_burned_adj.csv")

### combine
fp_all <- rbind(n_fp, sw_fp, p_fp, adj_fp)
rm(n_fp, p_fp, sw_fp, adj_fp)

########################################################
### how many of these FTs also burned in MTBS perimeters?
########################################################

### open mtbs FTs
mtbs_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fts_w_us_updated.csv") %>%
  
  ### fix ignition date
  mutate(Ig_Date = make_date(year, month, date))

### check for overlaps
fp_mtbs <- fp_all %>%
  filter(ft_id %in% mtbs_fts$ft_id)
length(unique(fp_mtbs$ft_id))
### 1582 fts burned in firedpy and mtbs dataset

### were these in different years?
fp_mtbs <- merge(x = fp_mtbs,
                 y = mtbs_fts,
                 by = "ft_id",
                 all.x = TRUE)

### if the ignition date is exactly the same, these are the same fire
fp_mtbs_drop <- fp_mtbs %>%
  filter(ig_date == Ig_Date)

### sometimes these are the same month and year -- probably the same fire

### calculate number of days between ignition dates
fp_mtbs <- fp_mtbs %>%
  mutate(interval_ig = abs(round(as.numeric(difftime(ig_date,
                                  Ig_Date, units = "days")))))

### landsat overpass is 16 days. if ignition intervals are within a month, assume they are the same fire
fp_mtbs_drop_2 <- fp_mtbs %>%
  filter(interval_ig < 31)

### same year?
fp_mtbs <- fp_mtbs %>%
  mutate(same_yr = ifelse(ig_year == year, 1, 0))

### subset firedpy and mtbs shps to these
firedpy <- st_read("E:/fired_py_data/firedpy_update_2024/fired_conus_ak_2000_to_2024_events.shp") %>%
  filter(., id %in% fp_mtbs$id) %>%
  st_transform(., 6350)
mtbs_all <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_1984_2022_west.shp") %>%
  filter(., Event_ID %in% fp_mtbs$Event_ID)

# ### get spatial overlap
# overlap_fm <- st_intersection(firedpy, mtbs_all)
# 
# ### time between these
# overlap_fm <- overlap_fm %>%
#   mutate(interval_ig = abs(round(as.numeric(difftime(ig_date,
#                                                      Ig_Date, 
#                                                      units = "days")))))
# 
# ### drop if spatially overlap and ignition interval < one month
# overlap_fm <- overlap_fm %>%
#   filter(interval_ig > 31)

### keep firedpy fuel treatments from fp_mtbs where interval > 30 days 
fp_keep <- fp_all %>%
  
  ### drop the ones where the ignition dates are the same
  filter(!ft_id %in% fp_mtbs_drop$ft_id) %>%
  
  ### drop ignition dates within a month of each other
  filter(!ft_id %in% fp_mtbs_drop_2$ft_id)

### write out complete csv
write_csv(fp_keep,
          "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_ft_burned_all.csv")
  
### Open fuel treatment database
ft <- st_read("E:/usda_2023/usfs_fuel_treatments/S_USA.Activity_HazFuelTrt_PL.shp") %>%
  mutate(., ft_id = row_number())

### restrict to fuel treatments that subsequently burned in firedpy
ft <- ft %>%
  filter(ft_id %in% fp_keep$ft_id)

### are some of the fuel treatments in the burned dataset more than once?
length(unique(ft$ft_id))
### no

### add sf to ft's
ft_burned_shp <- ft %>%
  dplyr::select(ft_id,
                STATE_ABBR,
                ACTIVITY_C,
                ACTIVITY,
                TREATMENT_,
                TREATMENT1,
                geometry)
st_write(ft_burned_shp,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_fuel_treats_burned.shp")

### reproject
ft_burned_shp <- ft_burned_shp %>%
  st_transform(6350)

### open the mtbs burned fuel treatments
mtbs_ft_burned <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fuel_treats_updated.shp")

### combing
all_fts_burned <- rbind(mtbs_ft_burned,
                        ft_burned_shp)

### write this out
st_write(all_fts_burned,
         "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fuel_treats_mtbs_firedpy.shp")

### this gives the entire fuel treatment footprint, including parts that did not burn
```

### firedpy cbi
```{r}
### restrict to fires i care about
firedpy_keep <- firedpy %>%
  filter(id %in% fp_keep$id)

### export fire perimeters for CBI analysis
# - Fire_ID
# - Fire_Year
# - Start_Day (start day of fire season in Julian days)
# - End_Day (end day of fire season in Julian days)

### need to get the states for each firedpy polygon
w_bound <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/west_states.shp")

### overlap to get states
firedpy_keep <- st_intersection(firedpy_keep,
                                w_bound)

### Fire seasons
#### In Parks et al. 2019, they use the following seasons:
#### AZ and NM: April 1-June 30 (julian 91-181)
#### CA, ID, MT, OR, UT, WA, WY: June 1-Sept 15 (julian 152-258)
#### assume it's the same for CO, NV
#### use these
# other_julian <- c("CA", "CO", "ID",
#                   "MT", "NV", "OR",
#                   "SD", "TX",
#                   "UT", "WA", "WY")

### use julian fire season dates for CA, ID, MT, OR, UT, WA, WY

### assign julian start and end date based on state dates from Parks et al. 2019
firedpy_keep <- firedpy_keep %>%
  mutate(Start_Day = ifelse(NAME_1 %in% c("Arizona", 
                                          "New Mexico"), 
                            91, 152),
         End_Day = ifelse(NAME_1 %in% c("Arizona", 
                                        "New Mexico"), 
                          181, 258))

### Select columns for GEE
### export fire perimeters for CBI analysis
# - Fire_ID
# - Fire_Year
# - Start_Day (start day of fire season in Julian days)
# - End_Day (end day of fire season in Julian days)
firedpy_keep <- firedpy_keep %>%
  dplyr::select(Fire_ID = id,
                Fire_Year = ig_year,
                Start_Day,
                End_Day,
                geometry)

### Make sure date columns don't get read in with decimals
firedpy_keep$Fire_Year <- as.character(firedpy_keep$Fire_Year, 0)
firedpy_keep$Start_Day <- as.character(firedpy_keep$Start_Day, 0)
firedpy_keep$End_Day <- as.character(firedpy_keep$End_Day, 0)
```

### Are some of these fires completely contained by MTBS perimeters?
```{r, warning = FALSE}
### open shp of burned FTs
burned_ft <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fuel_treats_mtbs_firedpy.shp")

### open csv for firedpy
fp <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_ft_burned_all.csv")

### open csv for mtbs
mtbs_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fts_w_us_updated.csv") %>%
  
  ### fix ignition date
  mutate(Ig_Date = make_date(year, month, date))

### rename cols for both csvs
fp <- fp %>%
  dplyr::select(ft_id, 
                firedpy_id = id,
                firedpy_ig_date = ig_date,
                firedpy_ig_day = ig_day,
                firedpy_ig_month = ig_mnth,
                firedpy_ig_year = ig_year)
mtbs_fts <- mtbs_fts %>%
  dplyr::select(ft_id, 
                mtbs_id = Event_ID,
                mtbs_ig_date = Ig_Date,
                mtbs_ig_day = date,
                mtbs_ig_month = month,
                mtbs_ig_year = year)

### merge in data
burned_mtbs <- merge(x = burned_ft,
                     y = mtbs_fts,
                     by = "ft_id",
                     all.x = TRUE)
burned_m_p <- merge(x = burned_mtbs,
                    y = fp,
                    by = "ft_id",
                    all.x = TRUE) 

### drop geom
burned_mp <- burned_m_p
st_geometry(burned_mp) <- NULL
burned_mp <- burned_mp %>%
  distinct()

### subset to ft's that burned in both in the same year
burned_mp <- burned_mp %>%
  filter(!is.na(mtbs_id)) %>%
  filter(!is.na(firedpy_id)) %>%
  filter(mtbs_ig_year == firedpy_ig_year)

### add unique rowname
burned_mp <- burned_mp %>%
  mutate(uid = row_number())

### split mtbs and firedpy
b_m <- burned_mp %>%
  dplyr::select(uid, mtbs_id)
b_f <- burned_mp %>%
  dplyr::select(uid, firedpy_id)

### open fire perimeters
firedpy <- st_read("E:/fired_py_data/firedpy_update_2024/fired_conus_ak_2000_to_2024_events.shp") %>%
  filter(id %in% b_f$firedpy_id) %>%
  st_transform(., 6350)
mtbs <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_through_2022/mtbs_gee.shp") %>%
  filter(Fire_ID %in% b_m$mtbs_id)

### add geom to the dfs
b_m <- merge(y = b_m, 
             x = mtbs,
             by.y = "mtbs_id",
             by.x = "Fire_ID",
             all.y = TRUE)
b_f <- merge(y = b_f, 
             x = firedpy,
             by.y = "firedpy_id",
             by.x = "id",
             all.y = TRUE)

### make df to fill
uid <- NA
mtbs_id <- NA
firedpy_id <- NA
complete_over <- NA
store_comp_overlap <- as.data.frame(cbind(uid, mtbs_id, 
                                          firedpy_id, complete_over))

### loop through and figure out if any of the firedpy are completely within the mtbs perimeters
for (i in 1:nrow(b_f)) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### identify firedpy row
  fp_poly <- b_f[i, ]
  
  ### get mtbs row
  mtbs_poly <- b_m %>%
    filter(uid %in% fp_poly$uid)
  
  ### make cols
  uid <- fp_poly$uid
  mtbs_id <- mtbs_poly$Fire_ID
  firedpy_id <- fp_poly$id
  
  ### make col for overlap
  complete_over <- as.numeric(unlist(st_covered_by(fp_poly,
                                                   mtbs_poly)))
  # complete_unlist <- unlist(complete_over)
  
  if(length(complete_over) > 0) {
  
  ### make df
  df_i <- as.data.frame(cbind(uid, mtbs_id, 
                              firedpy_id, complete_over))
  
  ### store output
  store_comp_overlap <- rbind(store_comp_overlap,
                              df_i)
  }}

### drop empty row
store_comp_overlap <- store_comp_overlap %>%
  filter(!is.na(uid))

### remove these firedpy id's from the cbi dataset
firedpy_keep_keep <- firedpy_keep %>%
  filter(!Fire_ID %in% store_comp_overlap$firedpy_id)

### Write out shp for gee
st_write(firedpy_keep_keep,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_updated/firedpy_gee.shp")
```

#### make sure all firedpy fires ran in GEE
```{r}
### folder url
folder_firedpy_url <- "https://drive.google.com/drive/u/1/folders/1kO88SftL1YkMuvhPVvBtQT-ruJZuZtxv"

### identify the folder
folder_firedpy <- drive_get(as_id(folder_firedpy_url))

### identify the rasters in that folder
drive_firedpy <- drive_ls(folder_firedpy)

### figure out which fires ran

### make df
firedpy_ran <- as.data.frame(drive_firedpy[, c(1:2)])

### split fire name strings
firedpy_ran$name <- gsub('_CBI_bc.tif', '', firedpy_ran$name)

### which fires are missing?
firedpy_missing <- firedpy_keep_keep %>%
  filter(!Fire_ID %in% firedpy_ran$name)

### write these out for GEE
st_write(firedpy_missing,
         "E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_gee_2.shp")

```

### download firedpy CBI from google drive
```{r}
### folder url
folder_firedpy_url <- "https://drive.google.com/drive/u/1/folders/1kO88SftL1YkMuvhPVvBtQT-ruJZuZtxv"

### identify the folder
folder_firedpy <- drive_get(as_id(folder_firedpy_url))

### identify the rasters in that folder
drive_firedpy <- drive_ls(folder_firedpy)

### set download path
firedpy_path <- "E:/fire_sev_rdd/cbi_gee/cbi_gee_firedpy/additional/"

### run through files to download
for (i in seq_along(drive_firedpy$name)) {
  drive_download(
    as_id(drive_firedpy$id[[i]]),
    path = file.path(firedpy_path, drive_firedpy$name[[i]]),
    overwrite = TRUE
  )
}
```

### Overlapping treatments
```{r}
### open shp of fuel treatments that subsequently burned
# burned_ft <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats_updated.shp")
# burned_ft <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fts_polygons.shp")
### to include firedpy:
burned_ft <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fuel_treats_mtbs_firedpy.shp")

### Some of these treatment records are different activities that took place at the same location at the same time (ex. thinning and biomass removal)

### geometry valid
burned_ft <- st_make_valid(burned_ft)

### Open full fuel treatment database
ft <- st_read("E:/usda_2023/usfs_fuel_treatments/S_USA.Activity_HazFuelTrt_PL.shp") %>%
  mutate(., 
         ft_id = row_number()) %>%
  filter(.,
         ft_id %in% burned_ft$ft_id)

### plot one treatment and the overlap
check_ft <- ft %>% filter(ft_id == "8629")
check_burned <- burned_ft %>% filter(ft_id == "8629")
ggplot() +
  geom_sf(data = check_ft, color = "red", fill = NA) +
  geom_sf(data = check_burned, color = "blue", fill = NA) +
  NULL
### they overlap completely
st_geometry(check_ft)==st_geometry(check_burned)
## FALSE -- but why????

### get completion date and state
ft_date <- ft %>%
  dplyr::select(ft_id,
                STATE_ABBR,
                DATE_COMPL,
                geometry)
st_geometry(ft_date) <- NULL

### separate out date components
ft_date <- ft_date %>%
  mutate(date_comp = day(DATE_COMPL),
         month_comp = month(DATE_COMPL),
         year_comp = year(DATE_COMPL))

### merge in
burned_ft <- merge(x = burned_ft,
                   y = ft_date,
                   by = c("ft_id",
                          "STATE_ABBR"),
                   all.x = TRUE)

### write out
# st_write(burned_ft,
#          "E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats_year.shp")
# st_write(burned_ft,
#          "E:/usda_2023/usfs_fuel_treatments/western_us/all_burned_fuel_treats_year_updated.shp")
st_write(burned_ft,
         "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fuel_treats_year_updated_polygons.shp")
```

## CODE FROM ft_overlaps.Rmd

## Overlapping fuel treatments
```{r warning = FALSE}
### open shp of burned FTs
burned_ft <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fuel_treats_year_updated_polygons.shp")

### open csv for firedpy
fp <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/firedpy_ft_burned_all.csv")

### open csv for mtbs
mtbs_fts <- read.csv("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fts_w_us_updated.csv") %>%
  
  ### fix ignition date
  mutate(Ig_Date = make_date(year, month, date))

### rename cols for both csvs
fp <- fp %>%
  dplyr::select(ft_id, 
                firedpy_id = id,
                firedpy_ig_date = ig_date,
                firedpy_ig_day = ig_day,
                firedpy_ig_month = ig_mnth,
                firedpy_ig_year = ig_year)
mtbs_fts <- mtbs_fts %>%
  dplyr::select(ft_id, 
                mtbs_id = Event_ID,
                mtbs_ig_date = Ig_Date,
                mtbs_ig_day = date,
                mtbs_ig_month = month,
                mtbs_ig_year = year)

### merge in data
burned_mtbs <- merge(x = burned_ft,
                     y = mtbs_fts,
                     by = "ft_id",
                     all.x = TRUE)
burned_m_p <- merge(x = burned_mtbs,
                    y = fp,
                    by = "ft_id",
                    all.x = TRUE) 

### clean up intermediate files
rm(burned_mtbs, mtbs_fts, fp)

### double check that fires happened AFTER treatment
burned_m_p <- burned_m_p %>%
  mutate(interval_mtbs = round(as.numeric(difftime(DATE_COMPL,
                                                       mtbs_ig_date, units = "days"))),
         interval_fp = round(as.numeric(difftime(DATE_COMPL,
                                                       firedpy_ig_date, units = "days"))))

### are any of these values positive?
range(burned_m_p$interval_mtbs, na.rm = TRUE)
range(burned_m_p$interval_fp, na.rm = TRUE)
### nope. that's good!

### how many treatments burned in both an mtbs fire and a firedpy fire?
burned_both <- burned_m_p %>%
  filter(!is.na(mtbs_id)) %>%
  filter(!is.na(firedpy_id))
st_geometry(burned_both) <- NULL
burned_both <- burned_both %>%
  distinct()
### 837 treatments

### drop interval cols
burned_m_p <- burned_m_p %>%
  dplyr::select(-interval_mtbs,
                -interval_fp)

### figure out which fire was first
burned_m_p <- burned_m_p %>%
  mutate(int_mtbs = round(as.numeric(difftime(mtbs_ig_date,
                                                  firedpy_ig_date, 
                                              units = "days"))))
### negative value means that MTBS fire happened first
### positive value means that firedpy fire happened first

### id first fire
burned_m_p <- burned_m_p %>%
  mutate(first_fire_id = ifelse(is.na(int_mtbs) & is.na(firedpy_id),
                                mtbs_id,
                                ifelse(is.na(int_mtbs) & is.na(mtbs_id),
                                       firedpy_id,
                                       ifelse(int_mtbs < 0, mtbs_id, firedpy_id))),
         first_fire_source = ifelse(is.na(int_mtbs) & is.na(firedpy_id),
                                "mtbs",
                                ifelse(is.na(int_mtbs) & is.na(mtbs_id),
                                       "firedpy",
                                       ifelse(int_mtbs < 0, "mtbs", "firedpy"))))

### add ignition date info for first fire
burned_m_p <- burned_m_p %>%
  mutate(fire_ig_date = ifelse(first_fire_source == "mtbs",
                               as.character(mtbs_ig_date),
                               firedpy_ig_date))

### clean up
burned_m_p <- burned_m_p %>%
  dplyr::select(ft_id, 
                STATE_ABBR, 
                ACTIVITY_C, 
                ACTIVITY, 
                TREATMENT_, 
                TREATMENT1,
                DATE_COMPL, date_comp, month_comp, year_comp,
                first_fire_id,
                first_fire_source,
                fire_ig_date,
                geometry)

### write out
st_write(burned_m_p,
         "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fuel_treats_year_updated_polygons_fireID.shp")

### THESE ARE FOR THE FULL FUEL TREATMENTS -- THERE COULD BE PARTS OF THE FUEL TREATMENT THAT BURNED IN MTBS BUT NOT IN FIREDPY and VICE VERSA
```

#### look at an example
```{r}
### look at one example: ft_id = 8358
ex_ft <- burned_m_p %>%
  filter(ft_id == "8358") 

### get fire perimeters
mtbs_all <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_1984_2022_west.shp") %>%
  # filter(., Event_ID %in% ex_ft$mtbs_id)
  filter(., Event_ID == "MT4754911296120070628")
firedpy <- st_read("E:/fired_py_data/firedpy_update_2024/fired_conus_ak_2000_to_2024_events.shp") %>%
  # filter(., id %in% ex_ft$firedpy_id) %>%
  filter(., id == "149288") %>%
  st_transform(., 6350)

### plot
ggplot() +
  geom_sf(data = ex_ft) +
  geom_sf(data = mtbs_all, aes(color = Event_ID), fill = NA) +
  geom_sf(data = firedpy, aes(color = as.character(id)), fill = NA)

########
### another example: 24334
ex_ft <- burned_m_p %>%
  filter(ft_id == "24334") 
```

## Intersect with fires
Want the polygon that actually burned in each fuel treatment
```{r, warning = FALSE}
### open fire perimeter polygons
fp <- st_read("E:/fired_py_data/firedpy_update_2024/fired_conus_ak_2000_to_2024_events.shp") %>%
  filter(., id %in% burned_m_p$first_fire_id) %>%
  st_transform(., 6350) %>%
  dplyr::select(., Fire_ID = id,
                Fire_Year = ig_year,
                Start_Day = ig_month, 
                End_Day = ig_day,
                geometry)

mt <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/mtbs_1984_2022_west.shp") %>%
  dplyr::select(., Fire_ID = Event_ID,
                Fire_Year = year,
                Start_Day = month,
                End_Day = date,
                geometry) %>%
  filter(., Fire_ID %in% burned_m_p$first_fire_id)

### rbind fires
all_fires <- rbind(fp, mt)
rm(fp, mt)
gc()

### loop and get actual burned polygon
store_burned <- list()
for (i in 1:nrow(burned_m_p)) {
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get treatment i
  tr_temp <- burned_m_p[i, ]
  
  ### subset to fires that burned after
  fire_temp <- all_fires %>%
    filter(Fire_ID %in% tr_temp$first_fire_id)
  
  ### Intersect
  temp_intersect <- st_intersection(tr_temp, fire_temp)
  
  ### store intersections as a list
  store_burned[[i]] <- list(temp_intersect, unique(burned_m_p$ft_id)[i])
}
rm(burned_mp, all_fires)
gc()

### df for unlisting: temp_intersect_join
temp_intersect_join <- temp_intersect

for (i in 1:length(store_burned)) {
  # for (i in 1:10) { ## make sure it works on subset of data
  
  ### progress bar
  print(paste0("STEP ", i))
  
  ### make df
  # temp_data <- as.data.frame(store_burned[[i]][[1]])
  temp_data <- store_burned[[i]][[1]]
  
  if(nrow(temp_data) > 0) {
    
    ### rbind with adj_treat_burn
    temp_intersect_join <- rbind(temp_intersect_join,
                                 temp_data)
  } 
  
}

### drop copied row
temp_intersect_join <- temp_intersect_join %>%
  distinct()
# 35429

### write out
st_write(temp_intersect_join,
         "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fuel_treats_year_burned_polygons.shp")

# ### version for GEE
# temp_intersect_join <- temp_intersect_join %>%
#   dplyr::select(ft_id, state = STATE_A,
#                 date_comp = DATE_CO,
#                 year_comp = yer_cmp,
#                 fire_year = Fire_Yr)
# st_write(temp_intersect_join,
#          "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_gee.shp")

### clean up
rm(burned_m_p, fire_temp, store_burned,
   temp_data, temp_intersect,
   tr_temp)
gc()
```

## Drop wildfires
Drop wildfires and wildland fire use
```{r}
### remove wildfires, wildland fire use, planned treatment burned in wildfire
temp_intersect_join <- temp_intersect_join %>%
  filter(!ACTIVITY %in% c("Wildfire - Fuels Benefit",
                          "Wildfire - Human Ignition",
                          "Wildfire - Natural Ignition",
                          "Planned Treatment Burned in Wildfire",
                          "Wildland Fire Use"))

### write out
st_write(temp_intersect_join,
         "E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fuel_treats_year_burned_polygons_use.shp")
```


## Intersect overlaps
### Count by state
```{r}
### open file 
temp_intersect_join <- st_read("E:/usda_2023/usfs_fuel_treatments/western_us/burned_ft_2022/all_burned_fuel_treats_year_burned_polygons_use.shp")

### rename cols
temp_intersect_join <- temp_intersect_join %>%
  dplyr::select(ft_id,
                STATE_ABBR = STATE_A,
                ACTIVITY_C = ACTIVITY_,
                ACTIVITY, 
                TREATMENT_,
                TREATMENT1,
                DATE_CO,
                date_comp = dat_cmp,
                month_comp = mnth_cm,
                year_comp = yer_cmp,
                first_fire_id = frst_fr_d,
                first_fire_source = frst_fr_s,
                fire_ig_date = fr_g_dt,
                Fire_ID,
                Fire_Year = Fire_Yr,
                Start_Day = Strt_Dy,
                End_Day,
                geometry)


### see breakdown by state
table(temp_intersect_join$STATE_ABBR)

#   AZ    CA    CO    ID    MT    NM    NV    OR    UT    WA    WY 
# 1005 16343  1052   887   921   255    29  8104   198  2209   571 
```
For each footprint, I want to know if another footprint overlaps it. So the output I want is a df with a column for ft_id 1, ft_id 2, and true/false whether they overlap.

#### run all states
```{r, warning=FALSE}
### parallelize
plan(multicore)

### intersect in parallel
ft_fill <- future_map_dfr(1:(nrow(temp_intersect_join)-1), 
                          function(i) {
  temp_overlap <- st_intersection(temp_intersect_join[i, ],
                                  temp_intersect_join[(i+1):nrow(temp_intersect_join),
                                                      ])
  temp_overlap
}, .options = furrr_options(seed = TRUE))


### update column names
ft_fill <- ft_fill %>%
  dplyr::select(ft_id_1 = ft_id,
                state_1 = STATE_ABBR,
                activity_1 = ACTIVITY,
                date_compl_1 = DATE_CO,
                fire_1 = first_fire_id,
                fire_source_1 = first_fire_source,
                fire_ig_1 = fire_ig_date,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_compl_2 = DATE_CO.1,
                fire_2 = first_fire_id.1,
                fire_source_2 = first_fire_source.1,
                fire_ig_2 = fire_ig_date.1,
                geometry)

### make valid
ft_fill <- st_make_valid(ft_fill) ## 93765 rows

### drop dups
ft_fill <- unique(ft_fill) ## drops 5 rows

# ### write out
# st_write(ft_fill,
#          "E:/usda_2023/usfs_fuel_treatments/western_us/fuel_treat_overlaps/all_states.shp")
# Failed to create feature 8 in all_states
# Error: Feature creation failed.

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

### write out
st_write(ft_fill_split,
         "E:/usda_2023/usfs_fuel_treatments/western_us/fuel_treat_overlaps/all_states.shp")
```

#### nevada
```{r, warning=FALSE}
### subset to NV
test_neva <- temp_intersect_join %>%
  filter(STATE_ABBR == "NV")
# rm(temp_intersect_join)
# gc()

### make two sf dfs for dummy df
nv_1 <- test_neva %>%
  filter(ft_id == "87244")
nv_2 <- test_neva %>%
  filter(ft_id == "421221")

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2)

### change columns for dummy df
ft_fill <- ft_fill %>%
  dplyr::select(ft_id_1 = ft_id, 
                state_1 = STATE_ABBR,
                activity_1 = ACTIVITY,
                date_compl_1 = date_comp,
                fire_1 = first_fire_id,
                fire_source_1 = first_fire_source,
                fire_ig_1 = fire_ig_date,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_compl_2 = date_comp.1,
                fire_2 = first_fire_id.1,
                fire_source_2 = first_fire_source.1,
                fire_ig_2 = fire_ig_date.1,
                geometry)

# i <- 1
### make loop
for (i in 1:nrow(test_neva)) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- test_neva[i, ] %>%
    dplyr::select(ft_id_1 = ft_id, 
                state_1 = STATE_ABBR,
                activity_1 = ACTIVITY,
                date_compl_1 = date_comp,
                fire_1 = first_fire_id,
                fire_source_1 = first_fire_source,
                fire_ig_1 = fire_ig_date,
                geometry)
  
  ### filter dataset by the state of interest
  test_state <- test_neva %>%
    filter(STATE_ABBR == temp_1$state_1)
  
  # for (j in 2:(nrow(test_state)-1)) {
    for (j in (i+1):(nrow(test_state))) {
    
    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_compl_2 = date_comp,
                    fire_2 = first_fire_id,
                    fire_source_2 = first_fire_source,
                    fire_ig_2 = fire_ig_date,
                    geometry)
    
    # if(temp_1$ft_id_1 != temp_2$ft_id_2) {
      
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      # ### store intersections as a list
      # store_overlaps[j] <- temp_overlap
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    # }
    
  }
  
}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### make valid
ft_fill <- st_make_valid(ft_fill)

# ### add area
# ft_fill$area_overlap <- as.numeric(sf::st_area(ft_fill))

# ### remove problem geoms
# ft_fill <- ft_fill %>%
#   filter(area_overlap > 905)

# ### write out
# st_write(ft_fill,
#          "E:/usda_2023/usfs_fuel_treatments/western_us/fuel_treat_overlaps/neva.shp")
### can't write this out: Failed to create feature 0 in neva

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

### what is this doing?
# 87244
# NV
# Burning of Piled Material
# 2015-11-20
# NV3925811988320161014
# mtbs
# 2016-10-14
# 421221

### check with one row from ft_fill
check <- ft_fill %>%
   filter(ft_id_1 == "87244" & ft_id_2 == "421221")
ggplot() +
  geom_sf(data = check)
check_2 <- ft_fill_split %>%
  filter(ft_id_1 == "87244" & ft_id_2 == "421221")
ggplot() +
  geom_sf(data = check, color = "red", fill = "red", alpha = 0.2) +
  geom_sf(data = check_2, color = "blue", fill = "blue", alpha = 0.2)
### splits GEOMETRY COLLECTIONS to individual objects, drops part of the object (line, point)

### are any of the objects just dropped?
length(unique(ft_fill$ft_id_1))
length(unique(ft_fill_split$ft_id_1))
### yes, looks like there are 4 ft_id_1's that are dropped
check <- ft_fill %>%
  filter(!ft_id_1 %in% ft_fill_split$ft_id_1)
ggplot() +
  geom_sf(data = check, aes(color = "ft_id_1"))
### the ones that get dropped are MULTILINESTRINGs

# write out
st_write(ft_fill_split,
         "E:/usda_2023/usfs_fuel_treatments/western_us/fuel_treat_overlaps/neva.shp")

### clean up
rm(ft_fill, ft_fill_split, temp_1,
   temp_2, temp_overlap, test_neva, test_state)
gc()
```

#### utah
```{r, warning=FALSE}
### subset to UT
utah <- temp_intersect_join %>%
  filter(STATE_ABBR == "UT")

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2)

### change columns for dummy df
ft_fill <- ft_fill %>%
  dplyr::select(ft_id_1 = ft_id, 
                state_1 = STATE_ABBR,
                activity_1 = ACTIVITY,
                date_compl_1 = date_comp,
                fire_1 = first_fire_id,
                fire_source_1 = first_fire_source,
                fire_ig_1 = fire_ig_date,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_compl_2 = date_comp.1,
                fire_2 = first_fire_id.1,
                fire_source_2 = first_fire_source.1,
                fire_ig_2 = fire_ig_date.1,
                geometry)

# i <- 1
### make loop
for (i in 1:nrow(utah)) {
  ### progress bar
  print(paste0("STEP ", i))
  
  ### get polygon
  temp_1 <- utah[i, ] %>%
    dplyr::select(ft_id_1 = ft_id, 
                state_1 = STATE_ABBR,
                activity_1 = ACTIVITY,
                date_compl_1 = date_comp,
                fire_1 = first_fire_id,
                fire_source_1 = first_fire_source,
                fire_ig_1 = fire_ig_date,
                geometry)
  
  ### filter dataset by the state of interest
  test_state <- utah %>%
    filter(STATE_ABBR == temp_1$state_1)
  
  for (j in (i+1):(nrow(test_state))) {
    
    ### get polygon 2
    temp_2 <- test_state[j, ] %>%
      dplyr::select(ft_id_2 = ft_id,
                    state_2 = STATE_ABBR,
                    activity_2 = ACTIVITY,
                    date_compl_2 = date_comp,
                    fire_2 = first_fire_id,
                    fire_source_2 = first_fire_source,
                    fire_ig_2 = fire_ig_date,
                    geometry)
  
      ### intersect
      temp_overlap <- st_intersection(temp_1,
                                      temp_2)
      
      # ### store intersections as a list
      # store_overlaps[j] <- temp_overlap
      
      ### add to df
      ft_fill <- rbind(ft_fill,
                       temp_overlap)
    
  }
  
}

### remove dup row
ft_fill <- ft_fill %>%
  distinct()

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

# ### are any of the objects just dropped?
# length(unique(ft_fill$ft_id_1))
# length(unique(ft_fill_split$ft_id_1))
# ### yes, 16 ft_id_1 are dropped
# check <- ft_fill %>%
#   filter(!ft_id_1 %in% ft_fill_split$ft_id_1)
# check[3, ] %>%
#   ggplot() +
#   geom_sf()
# ### the ones that get dropped are LINESTRINGs, MULTILINESTRINGs, and POINTs

### write out
st_write(ft_fill_split,
         "E:/usda_2023/usfs_fuel_treatments/western_us/fuel_treat_overlaps/utah.shp")

### clean up
rm(utah, ft_fill_split, ft_fill, 
   temp_1, temp_2, temp_overlap, test_state)
gc()
```

#### new mexico
```{r, warning=FALSE}
### subset to UT
nmex <- temp_intersect_join %>%
  filter(STATE_ABBR == "NM")

### intersect two to make dummy df
ft_fill <- st_intersection(nv_1,
                           nv_2)

### change columns for dummy df
ft_fill <- ft_fill %>%
  dplyr::select(ft_id_1 = ft_id, 
                state_1 = STATE_ABBR,
                activity_1 = ACTIVITY,
                date_compl_1 = date_comp,
                fire_1 = first_fire_id,
                fire_source_1 = first_fire_source,
                fire_ig_1 = fire_ig_date,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_compl_2 = date_comp.1,
                fire_2 = first_fire_id.1,
                fire_source_2 = first_fire_source.1,
                fire_ig_2 = fire_ig_date.1,
                geometry)

### parallelize
plan(multicore)

### intersect in parallel
ft_fill <- future_map_dfr(1:(nrow(nmex)-1), function(i) {
  temp_overlap <- st_intersection(nmex[i, ],
                                  nmex[(i+1):nrow(nmex), ])
  temp_overlap
}, .options = furrr_options(seed = TRUE))

# ### make loop
# for (i in 1:nrow(nmex)) {
#   ### progress bar
#   print(paste0("STEP ", i))
# 
#   ### get polygon
#   temp_1 <- nmex[i, ] %>%
#     dplyr::select(ft_id_1 = ft_id,
#                 state_1 = STATE_ABBR,
#                 activity_1 = ACTIVITY,
#                 date_compl_1 = date_comp,
#                 fire_1 = first_fire_id,
#                 fire_source_1 = first_fire_source,
#                 fire_ig_1 = fire_ig_date,
#                 geometry)
# 
#   ### filter dataset by the state of interest
#   test_state <- nmex %>%
#     filter(STATE_ABBR == temp_1$state_1)
# 
#   for (j in (i+1):(nrow(test_state))) {
# 
#     ### get polygon 2
#     temp_2 <- test_state[j, ] %>%
#       dplyr::select(ft_id_2 = ft_id,
#                     state_2 = STATE_ABBR,
#                     activity_2 = ACTIVITY,
#                     date_compl_2 = date_comp,
#                     fire_2 = first_fire_id,
#                     fire_source_2 = first_fire_source,
#                     fire_ig_2 = fire_ig_date,
#                     geometry)
# 
#       ### intersect
#       temp_overlap <- st_intersection(temp_1,
#                                       temp_2)
# 
#       # ### store intersections as a list
#       # store_overlaps[j] <- temp_overlap
# 
#       ### add to df
#       ft_fill <- rbind(ft_fill,
#                        temp_overlap)
#     }
# 
# }

### update column names
ft_fill <- ft_fill %>%
  dplyr::select(ft_id_1 = ft_id,
                state_1 = STATE_ABBR,
                activity_1 = ACTIVITY,
                date_compl_1 = date_comp,
                fire_1 = first_fire_id,
                fire_source_1 = first_fire_source,
                fire_ig_1 = fire_ig_date,
                ft_id_2 = ft_id.1,
                state_2 = STATE_ABBR.1,
                activity_2 = ACTIVITY.1,
                date_compl_2 = date_comp.1,
                fire_2 = first_fire_id.1,
                fire_source_2 = first_fire_source.1,
                fire_ig_2 = fire_ig_date.1,
                geometry)

### remove neva dup row
ft_fill <- ft_fill %>%
  filter(state_1 == "NM")

### make valid
ft_fill <- st_make_valid(ft_fill)

### fix problem shapes
ft_fill_split <- ft_fill %>%
  st_collection_extract()

### are any of the objects just dropped?
length(unique(ft_fill$ft_id_1))
length(unique(ft_fill_split$ft_id_1))
### yes, 3 ft_id_1 are dropped
check <- ft_fill %>%
  filter(!ft_id_1 %in% ft_fill_split$ft_id_1)
check %>%
  ggplot() +
  geom_sf()
### the ones that get dropped are LINESTRINGs

### write out
st_write(ft_fill_split,
         "E:/usda_2023/usfs_fuel_treatments/western_us/fuel_treat_overlaps/nmex_check.shp")

### clean up
rm(nmex, ft_fill_split, ft_fill, 
   temp_1, temp_2, temp_overlap, test_state)
gc()
```